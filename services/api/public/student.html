<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å­¦ç”Ÿç«¯ - CodeAdventurers</title>
  <style>
    :root {
      color-scheme: light;
      font-family: 'Microsoft YaHei', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f7ff;
    }

    body {
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #1f2937;
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    header {
      color: #fff;
      text-align: center;
      padding: 48px 24px 24px;
    }

    header h1 {
      font-size: 2.6rem;
      margin-bottom: 8px;
    }

    header p {
      margin: 0;
      opacity: 0.9;
      font-size: 1.05rem;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 16px 40px rgba(46, 56, 77, 0.15);
      backdrop-filter: blur(8px);
    }

    .card h2 {
      margin-top: 0;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    fieldset {
      border: 1px solid rgba(102, 126, 234, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    fieldset legend {
      font-weight: 600;
      color: #4c51bf;
    }

    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 6px;
    }

    input, textarea, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(79, 70, 229, 0.2);
      margin-bottom: 12px;
      font-size: 0.95rem;
      font-family: inherit;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 999px;
      color: #fff;
      font-weight: 600;
      padding: 10px 20px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 24px rgba(102, 126, 234, 0.35);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .status {
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      font-weight: 500;
    }

    .status.info { background: rgba(59, 130, 246, 0.12); color: #1d4ed8; }
    .status.success { background: rgba(16, 185, 129, 0.12); color: #047857; }
    .status.error { background: rgba(239, 68, 68, 0.12); color: #b91c1c; }

    .levels {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    .level {
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 12px;
      padding: 12px;
      background: #f9f9ff;
      cursor: pointer;
      transition: transform 0.2s, border 0.2s;
    }

    .level:hover {
      transform: translateY(-2px);
      border-color: rgba(99, 102, 241, 0.6);
    }

    .level[data-status="completed"] {
      border-color: rgba(16, 185, 129, 0.6);
      background: #ecfdf5;
    }

    .level[data-status="locked"] {
      opacity: 0.65;
      cursor: not-allowed;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.75rem;
      background: rgba(79, 70, 229, 0.12);
      color: #4c51bf;
    }

    .stack {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    pre {
      background: #1f2937;
      color: #f8fafc;
      padding: 12px;
      border-radius: 12px;
      overflow-x: auto;
      font-size: 0.85rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    table th, table td {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(203, 213, 225, 0.6);
      text-align: left;
    }

    table tbody tr:hover {
      background: rgba(99, 102, 241, 0.08);
    }

    details summary {
      cursor: pointer;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ® CodeAdventurers å­¦ç”Ÿç«¯</h1>
    <p>ç™»å½• â†’ æŸ¥çœ‹å†’é™©åœ°å›¾ â†’ è¿è¡ŒæŒ‡ä»¤ â†’ æäº¤ç»“ç®—ï¼Œå®Œæˆå®Œæ•´å­¦ä¹ é—­ç¯ã€‚</p>
  </header>
  <main>
    <div id="status" class="status info" role="status">è¯·å…ˆå®Œæˆç™»å½•ã€‚</div>
    <section class="card-grid">
      <article class="card" aria-labelledby="auth-title">
        <h2 id="auth-title">ğŸ” ç™»å½•ä¸èº«ä»½</h2>
        <fieldset>
          <legend>æ¸¸å®¢ä½“éªŒ</legend>
          <label for="guest-name">æ˜µç§°ï¼ˆå¯é€‰ï¼‰</label>
          <input id="guest-name" type="text" placeholder="ä¾‹å¦‚ï¼šå°å¥‡" />
          <button id="guest-login">ğŸš€ æ¸¸å®¢ä¸€é”®ä½“éªŒ</button>
        </fieldset>
        <fieldset>
          <legend>ç­çº§é‚€è¯·ç ç™»å½•</legend>
          <label for="class-name">å­¦ç”Ÿå§“å</label>
          <input id="class-name" type="text" placeholder="å­¦ç”Ÿå§“å" />
          <label for="class-code">ç­çº§é‚€è¯·ç </label>
          <input id="class-code" type="text" placeholder="ä¾‹å¦‚ï¼šCA-CLASS-1" />
          <button id="class-login">ğŸ“˜ è¿›å…¥ç­çº§</button>
        </fieldset>
        <fieldset>
          <legend>å½“å‰èº«ä»½</legend>
          <div class="stack">
            <div>ç”¨æˆ· IDï¼š<span id="current-user">æœªç™»å½•</span></div>
            <button id="logout" disabled>é€€å‡ºç™»å½•</button>
          </div>
        </fieldset>
      </article>

      <article class="card" aria-labelledby="map-title">
        <h2 id="map-title">ğŸ—ºï¸ å†’é™©åœ°å›¾</h2>
        <div class="stack">
          <button id="load-map" disabled>åˆ·æ–°ç« èŠ‚ä¸å…³å¡</button>
          <div id="chapters" class="stack" aria-live="polite"></div>
        </div>
      </article>

      <article class="card" aria-labelledby="prep-title">
        <h2 id="prep-title">ğŸ“˜ å…³å¡å‡†å¤‡</h2>
        <div class="stack">
          <div>å·²é€‰æ‹©å…³å¡ï¼š<span id="selected-level">å°šæœªé€‰æ‹©</span></div>
          <button id="load-prep" disabled>æŸ¥çœ‹å…³å¡è¯¦æƒ…</button>
          <pre id="prep-info" aria-live="polite">è¯·é€‰æ‹©å…³å¡åæŸ¥çœ‹èƒœåˆ©æ¡ä»¶ä¸å¥–åŠ±ã€‚</pre>
          <button id="request-hint" disabled>ğŸ’¡ è¯·æ±‚æç¤º</button>
          <pre id="hint-info">æç¤ºå°†åœ¨æ­¤å¤„å±•ç¤ºã€‚</pre>
        </div>
      </article>

      <article class="card" aria-labelledby="run-title">
        <h2 id="run-title">ğŸ§© ç¨‹åºè¿è¡Œä¸ç»“ç®—</h2>
        <div class="stack">
          <label for="program-input">æŒ‡ä»¤æ•°ç»„ï¼ˆJSONï¼‰</label>
          <textarea id="program-input" spellcheck="false">[
  { "type": "MOVE" },
  { "type": "MOVE" },
  { "type": "TURN_RIGHT" },
  { "type": "MOVE" }
]</textarea>
          <button id="run-program" disabled>â–¶ï¸ æ¨¡æ‹Ÿè¿è¡Œ</button>
          <pre id="run-result">è¿è¡Œç»“æœå°†åœ¨æ­¤å¤„å±•ç¤ºã€‚</pre>
          <fieldset>
            <legend>ç»“ç®—æ•°æ®</legend>
            <label for="result-stars">æ˜Ÿçº§ï¼ˆ0-3ï¼‰</label>
            <input id="result-stars" type="number" min="0" max="3" value="3" />
            <label for="result-steps">æ­¥æ•°</label>
            <input id="result-steps" type="number" min="0" value="3" />
            <label for="result-hints">ä½¿ç”¨æç¤ºæ¬¡æ•°</label>
            <input id="result-hints" type="number" min="0" value="0" />
            <label for="result-duration">è€—æ—¶ï¼ˆç§’ï¼‰</label>
            <input id="result-duration" type="number" min="0" value="30" />
            <button id="submit-result" disabled>ğŸ æäº¤ç»“ç®—</button>
          </fieldset>
        </div>
      </article>

      <article class="card" aria-labelledby="profile-title">
        <h2 id="profile-title">ğŸ­ è§’è‰²ä¸è®¾ç½®</h2>
        <div class="stack">
          <button id="load-avatar" disabled>æŸ¥çœ‹å½“å‰è£…æ‰®</button>
          <pre id="avatar-info">æœªåŠ è½½</pre>
          <label for="equip-input">åˆ‡æ¢è£…æ‰®ï¼ˆè¾“å…¥å·²è§£é” IDï¼‰</label>
          <input id="equip-input" type="text" placeholder="starter-cape" />
          <button id="equip-submit" disabled>æ›´æ¢è£…æ‰®</button>
          <button id="load-settings" disabled>è¯»å–è®¾ç½®</button>
          <pre id="settings-info">æœªåŠ è½½</pre>
          <label for="volume-input">éŸ³é‡ 0-1</label>
          <input id="volume-input" type="number" min="0" max="1" step="0.1" />
          <label for="language-input">è¯­è¨€</label>
          <input id="language-input" type="text" placeholder="zh-CN" />
          <button id="save-settings" disabled>ä¿å­˜è®¾ç½®</button>
          <button id="reset-progress" disabled>âš ï¸ é‡ç½®è¿›åº¦</button>
        </div>
      </article>

      <article class="card" aria-labelledby="sandbox-title">
        <h2 id="sandbox-title">ğŸ› ï¸ æ²™ç›’åˆ›ä½œä¸ä½œå“</h2>
        <div class="stack">
          <button id="load-sandbox" disabled>è·å–æ²™ç›’çŠ¶æ€</button>
          <pre id="sandbox-info">æœªåŠ è½½</pre>
          <label for="sandbox-title-input">æ–°å»ºä½œå“æ ‡é¢˜</label>
          <input id="sandbox-title-input" type="text" placeholder="æˆ‘çš„ä½œå“" />
          <button id="create-sandbox" disabled>åˆ›å»ºè‰ç¨¿</button>
          <label for="sandbox-id-input">ä½œå“ ID</label>
          <input id="sandbox-id-input" type="text" placeholder="project-..." />
          <select id="sandbox-status">
            <option value="draft">è‰ç¨¿</option>
            <option value="published">å‘å¸ƒ</option>
          </select>
          <button id="update-sandbox" disabled>æ›´æ–°ä½œå“çŠ¶æ€</button>
          <button id="load-library" disabled>æŸ¥çœ‹ç­çº§ä½œå“åº“</button>
          <pre id="library-info">æœªåŠ è½½</pre>
          <label for="comment-work-id">è¯„è®ºä½œå“ ID</label>
          <input id="comment-work-id" type="text" placeholder="work-..." />
          <label for="comment-content">è¯„è®ºå†…å®¹</label>
          <input id="comment-content" type="text" placeholder="å†™ä¸‹é¼“åŠ±çš„è¯" />
          <button id="submit-comment" disabled>å‘é€è¯„è®º</button>
        </div>
      </article>
    </section>
  </main>
  <script type="module">
    const statusBox = document.getElementById('status');
    const currentUser = document.getElementById('current-user');
    const logoutBtn = document.getElementById('logout');
    const buttons = Array.from(document.querySelectorAll('button')).filter((btn) => btn.id && !['guest-login', 'class-login'].includes(btn.id));

    const state = {
      userId: localStorage.getItem('studentUserId') || '',
      selectedLevel: '',
      lastRun: null,
    };

    function setStatus(message, type = 'info') {
      statusBox.textContent = message;
      statusBox.className = `status ${type}`;
    }

    function syncAuthState() {
      const loggedIn = Boolean(state.userId);
      currentUser.textContent = loggedIn ? state.userId : 'æœªç™»å½•';
      logoutBtn.disabled = !loggedIn;
      for (const btn of buttons) {
        btn.disabled = !loggedIn;
      }
      document.getElementById('load-prep').disabled = !state.selectedLevel || !loggedIn;
      document.getElementById('run-program').disabled = !state.selectedLevel || !loggedIn;
      document.getElementById('submit-result').disabled = !state.selectedLevel || !loggedIn;
      document.getElementById('request-hint').disabled = !state.selectedLevel || !loggedIn;
    }

    syncAuthState();

    function authHeaders() {
      return state.userId ? { 'x-user-id': state.userId } : {};
    }

    async function api(path, options = {}) {
      const opts = { method: 'GET', ...options };
      opts.headers = { 'Content-Type': 'application/json', ...authHeaders(), ...(options.headers || {}) };
      if (options.body && typeof options.body !== 'string') {
        opts.body = JSON.stringify(options.body);
      }
      const response = await fetch(path, opts);
      const text = await response.text();
      let data = null;
      try {
        data = text ? JSON.parse(text) : null;
      } catch (error) {
        data = text;
      }
      if (!response.ok) {
        const message = data?.message || response.statusText;
        throw new Error(message);
      }
      return data;
    }

    function renderChapters(chapters) {
      const container = document.getElementById('chapters');
      container.innerHTML = '';
      if (!chapters || chapters.length === 0) {
        container.textContent = 'æš‚æ— è¯¾ç¨‹ï¼Œè¯·è”ç³»è€å¸ˆåˆ†é…ã€‚';
        return;
      }
      chapters.forEach((chapter) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'stack';
        const title = document.createElement('h3');
        title.textContent = `${chapter.title}`;
        wrapper.appendChild(title);
        const grid = document.createElement('div');
        grid.className = 'levels';
        chapter.levels.forEach((level) => {
          const card = document.createElement('button');
          card.type = 'button';
          card.className = 'level';
          card.dataset.status = level.status;
          card.disabled = level.status === 'locked';
          card.innerHTML = `<div class="tag">${level.status === 'completed' ? 'âœ… å·²å®Œæˆ' : level.status === 'available' ? 'ğŸ¯ å¯æŒ‘æˆ˜' : 'ğŸ”’ æœªè§£é”'}</div>
            <div><strong>${level.name}</strong></div>
            <div>æ˜Ÿçº§ï¼š${'â­'.repeat(level.stars || 0)}${'â˜†'.repeat(3 - (level.stars || 0))}</div>`;
          card.addEventListener('click', () => {
            if (level.status === 'locked') return;
            state.selectedLevel = level.id;
            document.getElementById('selected-level').textContent = `${level.name} (${level.id})`;
            syncAuthState();
            setStatus(`å·²é€‰æ‹©å…³å¡ ${level.name}ï¼Œè¯·æŸ¥çœ‹å‡†å¤‡ä¿¡æ¯ã€‚`, 'info');
          });
          grid.appendChild(card);
        });
        wrapper.appendChild(grid);
        container.appendChild(wrapper);
      });
    }

    document.getElementById('guest-login').addEventListener('click', async () => {
      try {
        setStatus('æ­£åœ¨ç™»å½•æ¸¸å®¢èº«ä»½â€¦', 'info');
        const name = document.getElementById('guest-name').value || undefined;
        const result = await api('/api/auth/guest', { method: 'POST', body: name ? { name } : {} });
        state.userId = result.userId;
        localStorage.setItem('studentUserId', state.userId);
        setStatus(`æ¬¢è¿ ${result.name}ï¼Œå·²è¿›å…¥ä½“éªŒå¤§å…ã€‚`, 'success');
        syncAuthState();
        await loadMap();
      } catch (error) {
        setStatus(error.message || 'æ¸¸å®¢ç™»å½•å¤±è´¥', 'error');
      }
    });

    document.getElementById('class-login').addEventListener('click', async () => {
      try {
        setStatus('æ­£åœ¨é€šè¿‡ç­çº§é‚€è¯·ç ç™»å½•â€¦', 'info');
        const name = document.getElementById('class-name').value || undefined;
        const inviteCode = document.getElementById('class-code').value.trim();
        if (!inviteCode) {
          setStatus('è¯·è¾“å…¥ç­çº§é‚€è¯·ç ã€‚', 'error');
          return;
        }
        const result = await api('/api/auth/class', { method: 'POST', body: { name, inviteCode } });
        state.userId = result.userId;
        localStorage.setItem('studentUserId', state.userId);
        setStatus(`å·²åŠ å…¥ç­çº§ï¼Œæ¬¢è¿ ${result.name}ï¼`, 'success');
        syncAuthState();
        await loadMap();
      } catch (error) {
        setStatus(error.message || 'ç­çº§ç™»å½•å¤±è´¥', 'error');
      }
    });

    logoutBtn.addEventListener('click', () => {
      state.userId = '';
      state.selectedLevel = '';
      state.lastRun = null;
      localStorage.removeItem('studentUserId');
      document.getElementById('chapters').innerHTML = '';
      document.getElementById('prep-info').textContent = 'è¯·é€‰æ‹©å…³å¡åæŸ¥çœ‹èƒœåˆ©æ¡ä»¶ä¸å¥–åŠ±ã€‚';
      document.getElementById('run-result').textContent = 'è¿è¡Œç»“æœå°†åœ¨æ­¤å¤„å±•ç¤ºã€‚';
      document.getElementById('hint-info').textContent = 'æç¤ºå°†åœ¨æ­¤å¤„å±•ç¤ºã€‚';
      document.getElementById('sandbox-info').textContent = 'æœªåŠ è½½';
      document.getElementById('library-info').textContent = 'æœªåŠ è½½';
      document.getElementById('avatar-info').textContent = 'æœªåŠ è½½';
      document.getElementById('settings-info').textContent = 'æœªåŠ è½½';
      document.getElementById('selected-level').textContent = 'å°šæœªé€‰æ‹©';
      setStatus('å·²é€€å‡ºç™»å½•ã€‚', 'info');
      syncAuthState();
    });

    async function loadMap() {
      try {
        const data = await api('/api/student/map');
        renderChapters(data.chapters);
        setStatus('å·²æ›´æ–°å†’é™©åœ°å›¾ã€‚', 'success');
      } catch (error) {
        setStatus(error.message || 'æ— æ³•åŠ è½½å†’é™©åœ°å›¾', 'error');
      }
    }

    document.getElementById('load-map').addEventListener('click', loadMap);

    async function loadPrep() {
      if (!state.selectedLevel) {
        setStatus('è¯·é€‰æ‹©å…³å¡ã€‚', 'error');
        return;
      }
      try {
        const data = await api(`/api/student/levels/${state.selectedLevel}/prep`);
        document.getElementById('prep-info').textContent = JSON.stringify(data, null, 2);
        setStatus('å·²è·å–å…³å¡å‡†å¤‡ä¿¡æ¯ã€‚', 'success');
      } catch (error) {
        setStatus(error.message || 'æ— æ³•è·å–å…³å¡è¯¦æƒ…', 'error');
      }
    }

    document.getElementById('load-prep').addEventListener('click', loadPrep);

    async function requestHint() {
      if (!state.selectedLevel) {
        setStatus('è¯·é€‰æ‹©å…³å¡ã€‚', 'error');
        return;
      }
      try {
        const attempts = state.lastRun?.steps ?? 0;
        const payload = { attempts };
        const data = await api(`/api/student/hints/${state.selectedLevel}`, { method: 'POST', body: payload });
        document.getElementById('hint-info').textContent = data.hint;
        setStatus('æç¤ºå·²ç”Ÿæˆï¼Œæ³¨æ„åˆç†ä½¿ç”¨æç¤ºæ¬¡æ•°ã€‚', 'success');
      } catch (error) {
        setStatus(error.message || 'è¯·æ±‚æç¤ºå¤±è´¥', 'error');
      }
    }

    document.getElementById('request-hint').addEventListener('click', requestHint);

    async function runProgram() {
      if (!state.selectedLevel) {
        setStatus('è¯·é€‰æ‹©å…³å¡ã€‚', 'error');
        return;
      }
      try {
        const programText = document.getElementById('program-input').value.trim();
        const program = programText ? JSON.parse(programText) : [];
        const data = await api(`/api/student/levels/${state.selectedLevel}/run`, { method: 'POST', body: { program } });
        state.lastRun = data;
        document.getElementById('run-result').textContent = JSON.stringify(data, null, 2);
        document.getElementById('result-steps').value = data.steps ?? 0;
        document.getElementById('result-stars').value = data.stars ?? 0;
        setStatus(data.success ? 'æ¨¡æ‹ŸæˆåŠŸï¼Œè¯·æäº¤ç»“ç®—ã€‚' : 'æ¨¡æ‹Ÿæœªè¾¾æˆç›®æ ‡ï¼Œè¯·æŸ¥çœ‹æç¤ºã€‚', data.success ? 'success' : 'info');
      } catch (error) {
        setStatus(error.message || 'è¿è¡Œæ¨¡æ‹Ÿå¤±è´¥', 'error');
      }
    }

    document.getElementById('run-program').addEventListener('click', runProgram);

    async function submitResult() {
      if (!state.selectedLevel) {
        setStatus('è¯·é€‰æ‹©å…³å¡ã€‚', 'error');
        return;
      }
      try {
        const payload = {
          stars: Number(document.getElementById('result-stars').value || 0),
          steps: Number(document.getElementById('result-steps').value || 0),
          hints: Number(document.getElementById('result-hints').value || 0),
          duration: Number(document.getElementById('result-duration').value || 0),
          bestDifference: state.lastRun?.metadata?.bestSteps ? Math.max(0, Number(document.getElementById('result-steps').value) - state.lastRun.metadata.bestSteps) : undefined,
          replayLog: state.lastRun?.log || [],
        };
        const data = await api(`/api/student/levels/${state.selectedLevel}/complete`, { method: 'POST', body: payload });
        setStatus('ç»“ç®—æ•°æ®å·²æäº¤ï¼Œå†’é™©åœ°å›¾å°†è‡ªåŠ¨æ›´æ–°ã€‚', 'success');
        await loadMap();
        return data;
      } catch (error) {
        setStatus(error.message || 'æäº¤ç»“ç®—å¤±è´¥', 'error');
      }
    }

    document.getElementById('submit-result').addEventListener('click', submitResult);

    document.getElementById('load-avatar').addEventListener('click', async () => {
      try {
        const data = await api('/api/student/avatar');
        document.getElementById('avatar-info').textContent = JSON.stringify(data, null, 2);
        document.getElementById('equip-input').value = data.equipped;
        setStatus('å·²è¯»å–è§’è‰²è£…æ‰®ã€‚', 'success');
      } catch (error) {
        setStatus(error.message || 'æ— æ³•åŠ è½½è£…æ‰®', 'error');
      }
    });

    document.getElementById('equip-submit').addEventListener('click', async () => {
      try {
        const equipped = document.getElementById('equip-input').value.trim();
        if (!equipped) {
          setStatus('è¯·è¾“å…¥è£…æ‰® IDã€‚', 'error');
          return;
        }
        const data = await api('/api/student/avatar', { method: 'PUT', body: { equipped } });
        document.getElementById('avatar-info').textContent = JSON.stringify(data, null, 2);
        setStatus('è£…æ‰®å·²æ›´æ–°ã€‚', 'success');
      } catch (error) {
        setStatus(error.message || 'è£…æ‰®æ›´æ–°å¤±è´¥', 'error');
      }
    });

    document.getElementById('load-settings').addEventListener('click', async () => {
      try {
        const data = await api('/api/student/settings');
        document.getElementById('settings-info').textContent = JSON.stringify(data, null, 2);
        document.getElementById('volume-input').value = data.volume;
        document.getElementById('language-input').value = data.language;
        setStatus('å·²è¯»å–è®¾ç½®ã€‚', 'success');
      } catch (error) {
        setStatus(error.message || 'æ— æ³•è·å–è®¾ç½®', 'error');
      }
    });

    document.getElementById('save-settings').addEventListener('click', async () => {
      try {
        const volume = Number(document.getElementById('volume-input').value);
        const language = document.getElementById('language-input').value || 'zh-CN';
        const data = await api('/api/student/settings', { method: 'PUT', body: { volume, language } });
        document.getElementById('settings-info').textContent = JSON.stringify(data, null, 2);
        setStatus('è®¾ç½®å·²ä¿å­˜ã€‚', 'success');
      } catch (error) {
        setStatus(error.message || 'ä¿å­˜è®¾ç½®å¤±è´¥', 'error');
      }
    });

    document.getElementById('reset-progress').addEventListener('click', async () => {
      if (!confirm('ç¡®è®¤é‡ç½®æ‰€æœ‰è¿›åº¦ï¼Ÿè¯¥æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        return;
      }
      try {
        await api('/api/student/settings/reset-progress', { method: 'POST' });
        setStatus('è¿›åº¦å·²é‡ç½®ï¼Œè¯·é‡æ–°æŒ‘æˆ˜å…³å¡ã€‚', 'success');
        await loadMap();
      } catch (error) {
        setStatus(error.message || 'é‡ç½®å¤±è´¥', 'error');
      }
    });

    document.getElementById('load-sandbox').addEventListener('click', async () => {
      try {
        const data = await api('/api/student/sandbox');
        document.getElementById('sandbox-info').textContent = JSON.stringify(data, null, 2);
        setStatus(data.sandboxUnlocked ? 'æ²™ç›’å·²è§£é”ï¼Œå°½æƒ…åˆ›ä½œï¼' : 'å°šæœªè§£é”æ²™ç›’ï¼Œè¯·ç»§ç»­é€šå…³ç« èŠ‚ã€‚', 'info');
      } catch (error) {
        setStatus(error.message || 'æ— æ³•è·å–æ²™ç›’ä¿¡æ¯', 'error');
      }
    });

    document.getElementById('create-sandbox').addEventListener('click', async () => {
      try {
        const title = document.getElementById('sandbox-title-input').value || 'æœªå‘½åä½œå“';
        const data = await api('/api/student/sandbox', { method: 'POST', body: { title, data: { createdVia: 'frontend-demo' } } });
        document.getElementById('sandbox-info').textContent = JSON.stringify(data, null, 2);
        document.getElementById('sandbox-id-input').value = data.id;
        setStatus('å·²åˆ›å»ºæ–°çš„æ²™ç›’ä½œå“è‰ç¨¿ã€‚', 'success');
      } catch (error) {
        setStatus(error.message || 'åˆ›å»ºæ²™ç›’ä½œå“å¤±è´¥', 'error');
      }
    });

    document.getElementById('update-sandbox').addEventListener('click', async () => {
      try {
        const id = document.getElementById('sandbox-id-input').value.trim();
        if (!id) {
          setStatus('è¯·è¾“å…¥ä½œå“ IDã€‚', 'error');
          return;
        }
        const status = document.getElementById('sandbox-status').value;
        const data = await api(`/api/student/sandbox/${id}`, { method: 'PATCH', body: { status } });
        document.getElementById('sandbox-info').textContent = JSON.stringify(data, null, 2);
        setStatus(status === 'published' ? 'ä½œå“å·²å‘å¸ƒï¼Œç­‰å¾…è€å¸ˆå®¡æ ¸ã€‚' : 'ä½œå“å·²ä¿å­˜ä¸ºè‰ç¨¿ã€‚', 'success');
      } catch (error) {
        setStatus(error.message || 'æ›´æ–°ä½œå“å¤±è´¥', 'error');
      }
    });

    document.getElementById('load-library').addEventListener('click', async () => {
      try {
        const data = await api('/api/student/library');
        document.getElementById('library-info').textContent = JSON.stringify(data, null, 2);
        setStatus('å·²åŠ è½½ç­çº§ä½œå“åº“ã€‚', 'success');
      } catch (error) {
        setStatus(error.message || 'è·å–ä½œå“åº“å¤±è´¥', 'error');
      }
    });

    document.getElementById('submit-comment').addEventListener('click', async () => {
      try {
        const workId = document.getElementById('comment-work-id').value.trim();
        const content = document.getElementById('comment-content').value.trim();
        if (!workId || !content) {
          setStatus('è¯·è¾“å…¥ä½œå“ ID å’Œè¯„è®ºå†…å®¹ã€‚', 'error');
          return;
        }
        const data = await api(`/api/student/library/${workId}/comment`, { method: 'POST', body: { content } });
        setStatus('è¯„è®ºå·²æäº¤ã€‚', 'success');
        document.getElementById('library-info').textContent = `æœ€æ–°è¯„è®ºï¼š\n${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        setStatus(error.message || 'è¯„è®ºå¤±è´¥', 'error');
      }
    });

    if (state.userId) {
      setStatus('æ£€æµ‹åˆ°å·²ç™»å½•èº«ä»½ï¼Œæ­£åœ¨åŠ è½½å†’é™©åœ°å›¾â€¦', 'info');
      syncAuthState();
      loadMap();
    }
  </script>
</body>
</html>
