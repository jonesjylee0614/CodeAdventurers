<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>学生端 - CodeAdventurers</title>
  <style>
    :root {
      color-scheme: light;
      font-family: 'Microsoft YaHei', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f7ff;
    }

    body {
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #1f2937;
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    header {
      color: #fff;
      text-align: center;
      padding: 48px 24px 24px;
    }

    header h1 {
      font-size: 2.6rem;
      margin-bottom: 8px;
    }

    header p {
      margin: 0;
      opacity: 0.9;
      font-size: 1.05rem;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 16px 40px rgba(46, 56, 77, 0.15);
      backdrop-filter: blur(8px);
    }

    .card h2 {
      margin-top: 0;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    fieldset {
      border: 1px solid rgba(102, 126, 234, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    fieldset legend {
      font-weight: 600;
      color: #4c51bf;
    }

    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 6px;
    }

    input, textarea, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(79, 70, 229, 0.2);
      margin-bottom: 12px;
      font-size: 0.95rem;
      font-family: inherit;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 999px;
      color: #fff;
      font-weight: 600;
      padding: 10px 20px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 24px rgba(102, 126, 234, 0.35);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .status {
      padding: 12px 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      font-weight: 500;
    }

    .status.info { background: rgba(59, 130, 246, 0.12); color: #1d4ed8; }
    .status.success { background: rgba(16, 185, 129, 0.12); color: #047857; }
    .status.error { background: rgba(239, 68, 68, 0.12); color: #b91c1c; }

    .levels {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    .level {
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 12px;
      padding: 12px;
      background: #f9f9ff;
      cursor: pointer;
      transition: transform 0.2s, border 0.2s;
    }

    .level:hover {
      transform: translateY(-2px);
      border-color: rgba(99, 102, 241, 0.6);
    }

    .level[data-status="completed"] {
      border-color: rgba(16, 185, 129, 0.6);
      background: #ecfdf5;
    }

    .level[data-status="locked"] {
      opacity: 0.65;
      cursor: not-allowed;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.75rem;
      background: rgba(79, 70, 229, 0.12);
      color: #4c51bf;
    }

    .stack {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    pre {
      background: #1f2937;
      color: #f8fafc;
      padding: 12px;
      border-radius: 12px;
      overflow-x: auto;
      font-size: 0.85rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    table th, table td {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(203, 213, 225, 0.6);
      text-align: left;
    }

    table tbody tr:hover {
      background: rgba(99, 102, 241, 0.08);
    }

    details summary {
      cursor: pointer;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <header>
    <h1>🎮 CodeAdventurers 学生端</h1>
    <p>登录 → 查看冒险地图 → 运行指令 → 提交结算，完成完整学习闭环。</p>
  </header>
  <main>
    <div id="status" class="status info" role="status">请先完成登录。</div>
    <section class="card-grid">
      <article class="card" aria-labelledby="auth-title">
        <h2 id="auth-title">🔐 登录与身份</h2>
        <fieldset>
          <legend>游客体验</legend>
          <label for="guest-name">昵称（可选）</label>
          <input id="guest-name" type="text" placeholder="例如：小奇" />
          <button id="guest-login">🚀 游客一键体验</button>
        </fieldset>
        <fieldset>
          <legend>班级邀请码登录</legend>
          <label for="class-name">学生姓名</label>
          <input id="class-name" type="text" placeholder="学生姓名" />
          <label for="class-code">班级邀请码</label>
          <input id="class-code" type="text" placeholder="例如：CA-CLASS-1" />
          <button id="class-login">📘 进入班级</button>
        </fieldset>
        <fieldset>
          <legend>当前身份</legend>
          <div class="stack">
            <div>用户 ID：<span id="current-user">未登录</span></div>
            <button id="logout" disabled>退出登录</button>
          </div>
        </fieldset>
      </article>

      <article class="card" aria-labelledby="map-title">
        <h2 id="map-title">🗺️ 冒险地图</h2>
        <div class="stack">
          <button id="load-map" disabled>刷新章节与关卡</button>
          <div id="chapters" class="stack" aria-live="polite"></div>
        </div>
      </article>

      <article class="card" aria-labelledby="prep-title">
        <h2 id="prep-title">📘 关卡准备</h2>
        <div class="stack">
          <div>已选择关卡：<span id="selected-level">尚未选择</span></div>
          <button id="load-prep" disabled>查看关卡详情</button>
          <pre id="prep-info" aria-live="polite">请选择关卡后查看胜利条件与奖励。</pre>
          <button id="request-hint" disabled>💡 请求提示</button>
          <pre id="hint-info">提示将在此处展示。</pre>
        </div>
      </article>

      <article class="card" aria-labelledby="run-title">
        <h2 id="run-title">🧩 程序运行与结算</h2>
        <div class="stack">
          <label for="program-input">指令数组（JSON）</label>
          <textarea id="program-input" spellcheck="false">[
  { "type": "MOVE" },
  { "type": "MOVE" },
  { "type": "TURN_RIGHT" },
  { "type": "MOVE" }
]</textarea>
          <button id="run-program" disabled>▶️ 模拟运行</button>
          <pre id="run-result">运行结果将在此处展示。</pre>
          <fieldset>
            <legend>结算数据</legend>
            <label for="result-stars">星级（0-3）</label>
            <input id="result-stars" type="number" min="0" max="3" value="3" />
            <label for="result-steps">步数</label>
            <input id="result-steps" type="number" min="0" value="3" />
            <label for="result-hints">使用提示次数</label>
            <input id="result-hints" type="number" min="0" value="0" />
            <label for="result-duration">耗时（秒）</label>
            <input id="result-duration" type="number" min="0" value="30" />
            <button id="submit-result" disabled>🏁 提交结算</button>
          </fieldset>
        </div>
      </article>

      <article class="card" aria-labelledby="profile-title">
        <h2 id="profile-title">🎭 角色与设置</h2>
        <div class="stack">
          <button id="load-avatar" disabled>查看当前装扮</button>
          <pre id="avatar-info">未加载</pre>
          <label for="equip-input">切换装扮（输入已解锁 ID）</label>
          <input id="equip-input" type="text" placeholder="starter-cape" />
          <button id="equip-submit" disabled>更换装扮</button>
          <button id="load-settings" disabled>读取设置</button>
          <pre id="settings-info">未加载</pre>
          <label for="volume-input">音量 0-1</label>
          <input id="volume-input" type="number" min="0" max="1" step="0.1" />
          <label for="language-input">语言</label>
          <input id="language-input" type="text" placeholder="zh-CN" />
          <button id="save-settings" disabled>保存设置</button>
          <button id="reset-progress" disabled>⚠️ 重置进度</button>
        </div>
      </article>

      <article class="card" aria-labelledby="sandbox-title">
        <h2 id="sandbox-title">🛠️ 沙盒创作与作品</h2>
        <div class="stack">
          <button id="load-sandbox" disabled>获取沙盒状态</button>
          <pre id="sandbox-info">未加载</pre>
          <label for="sandbox-title-input">新建作品标题</label>
          <input id="sandbox-title-input" type="text" placeholder="我的作品" />
          <button id="create-sandbox" disabled>创建草稿</button>
          <label for="sandbox-id-input">作品 ID</label>
          <input id="sandbox-id-input" type="text" placeholder="project-..." />
          <select id="sandbox-status">
            <option value="draft">草稿</option>
            <option value="published">发布</option>
          </select>
          <button id="update-sandbox" disabled>更新作品状态</button>
          <button id="load-library" disabled>查看班级作品库</button>
          <pre id="library-info">未加载</pre>
          <label for="comment-work-id">评论作品 ID</label>
          <input id="comment-work-id" type="text" placeholder="work-..." />
          <label for="comment-content">评论内容</label>
          <input id="comment-content" type="text" placeholder="写下鼓励的话" />
          <button id="submit-comment" disabled>发送评论</button>
        </div>
      </article>
    </section>
  </main>
  <script type="module">
    const statusBox = document.getElementById('status');
    const currentUser = document.getElementById('current-user');
    const logoutBtn = document.getElementById('logout');
    const buttons = Array.from(document.querySelectorAll('button')).filter((btn) => btn.id && !['guest-login', 'class-login'].includes(btn.id));

    const state = {
      userId: localStorage.getItem('studentUserId') || '',
      selectedLevel: '',
      lastRun: null,
    };

    function setStatus(message, type = 'info') {
      statusBox.textContent = message;
      statusBox.className = `status ${type}`;
    }

    function syncAuthState() {
      const loggedIn = Boolean(state.userId);
      currentUser.textContent = loggedIn ? state.userId : '未登录';
      logoutBtn.disabled = !loggedIn;
      for (const btn of buttons) {
        btn.disabled = !loggedIn;
      }
      document.getElementById('load-prep').disabled = !state.selectedLevel || !loggedIn;
      document.getElementById('run-program').disabled = !state.selectedLevel || !loggedIn;
      document.getElementById('submit-result').disabled = !state.selectedLevel || !loggedIn;
      document.getElementById('request-hint').disabled = !state.selectedLevel || !loggedIn;
    }

    syncAuthState();

    function authHeaders() {
      return state.userId ? { 'x-user-id': state.userId } : {};
    }

    async function api(path, options = {}) {
      const opts = { method: 'GET', ...options };
      opts.headers = { 'Content-Type': 'application/json', ...authHeaders(), ...(options.headers || {}) };
      if (options.body && typeof options.body !== 'string') {
        opts.body = JSON.stringify(options.body);
      }
      const response = await fetch(path, opts);
      const text = await response.text();
      let data = null;
      try {
        data = text ? JSON.parse(text) : null;
      } catch (error) {
        data = text;
      }
      if (!response.ok) {
        const message = data?.message || response.statusText;
        throw new Error(message);
      }
      return data;
    }

    function renderChapters(chapters) {
      const container = document.getElementById('chapters');
      container.innerHTML = '';
      if (!chapters || chapters.length === 0) {
        container.textContent = '暂无课程，请联系老师分配。';
        return;
      }
      chapters.forEach((chapter) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'stack';
        const title = document.createElement('h3');
        title.textContent = `${chapter.title}`;
        wrapper.appendChild(title);
        const grid = document.createElement('div');
        grid.className = 'levels';
        chapter.levels.forEach((level) => {
          const card = document.createElement('button');
          card.type = 'button';
          card.className = 'level';
          card.dataset.status = level.status;
          card.disabled = level.status === 'locked';
          card.innerHTML = `<div class="tag">${level.status === 'completed' ? '✅ 已完成' : level.status === 'available' ? '🎯 可挑战' : '🔒 未解锁'}</div>
            <div><strong>${level.name}</strong></div>
            <div>星级：${'⭐'.repeat(level.stars || 0)}${'☆'.repeat(3 - (level.stars || 0))}</div>`;
          card.addEventListener('click', () => {
            if (level.status === 'locked') return;
            state.selectedLevel = level.id;
            document.getElementById('selected-level').textContent = `${level.name} (${level.id})`;
            syncAuthState();
            setStatus(`已选择关卡 ${level.name}，请查看准备信息。`, 'info');
          });
          grid.appendChild(card);
        });
        wrapper.appendChild(grid);
        container.appendChild(wrapper);
      });
    }

    document.getElementById('guest-login').addEventListener('click', async () => {
      try {
        setStatus('正在登录游客身份…', 'info');
        const name = document.getElementById('guest-name').value || undefined;
        const result = await api('/api/auth/guest', { method: 'POST', body: name ? { name } : {} });
        state.userId = result.userId;
        localStorage.setItem('studentUserId', state.userId);
        setStatus(`欢迎 ${result.name}，已进入体验大厅。`, 'success');
        syncAuthState();
        await loadMap();
      } catch (error) {
        setStatus(error.message || '游客登录失败', 'error');
      }
    });

    document.getElementById('class-login').addEventListener('click', async () => {
      try {
        setStatus('正在通过班级邀请码登录…', 'info');
        const name = document.getElementById('class-name').value || undefined;
        const inviteCode = document.getElementById('class-code').value.trim();
        if (!inviteCode) {
          setStatus('请输入班级邀请码。', 'error');
          return;
        }
        const result = await api('/api/auth/class', { method: 'POST', body: { name, inviteCode } });
        state.userId = result.userId;
        localStorage.setItem('studentUserId', state.userId);
        setStatus(`已加入班级，欢迎 ${result.name}！`, 'success');
        syncAuthState();
        await loadMap();
      } catch (error) {
        setStatus(error.message || '班级登录失败', 'error');
      }
    });

    logoutBtn.addEventListener('click', () => {
      state.userId = '';
      state.selectedLevel = '';
      state.lastRun = null;
      localStorage.removeItem('studentUserId');
      document.getElementById('chapters').innerHTML = '';
      document.getElementById('prep-info').textContent = '请选择关卡后查看胜利条件与奖励。';
      document.getElementById('run-result').textContent = '运行结果将在此处展示。';
      document.getElementById('hint-info').textContent = '提示将在此处展示。';
      document.getElementById('sandbox-info').textContent = '未加载';
      document.getElementById('library-info').textContent = '未加载';
      document.getElementById('avatar-info').textContent = '未加载';
      document.getElementById('settings-info').textContent = '未加载';
      document.getElementById('selected-level').textContent = '尚未选择';
      setStatus('已退出登录。', 'info');
      syncAuthState();
    });

    async function loadMap() {
      try {
        const data = await api('/api/student/map');
        renderChapters(data.chapters);
        setStatus('已更新冒险地图。', 'success');
      } catch (error) {
        setStatus(error.message || '无法加载冒险地图', 'error');
      }
    }

    document.getElementById('load-map').addEventListener('click', loadMap);

    async function loadPrep() {
      if (!state.selectedLevel) {
        setStatus('请选择关卡。', 'error');
        return;
      }
      try {
        const data = await api(`/api/student/levels/${state.selectedLevel}/prep`);
        document.getElementById('prep-info').textContent = JSON.stringify(data, null, 2);
        setStatus('已获取关卡准备信息。', 'success');
      } catch (error) {
        setStatus(error.message || '无法获取关卡详情', 'error');
      }
    }

    document.getElementById('load-prep').addEventListener('click', loadPrep);

    async function requestHint() {
      if (!state.selectedLevel) {
        setStatus('请选择关卡。', 'error');
        return;
      }
      try {
        const attempts = state.lastRun?.steps ?? 0;
        const payload = { attempts };
        const data = await api(`/api/student/hints/${state.selectedLevel}`, { method: 'POST', body: payload });
        document.getElementById('hint-info').textContent = data.hint;
        setStatus('提示已生成，注意合理使用提示次数。', 'success');
      } catch (error) {
        setStatus(error.message || '请求提示失败', 'error');
      }
    }

    document.getElementById('request-hint').addEventListener('click', requestHint);

    async function runProgram() {
      if (!state.selectedLevel) {
        setStatus('请选择关卡。', 'error');
        return;
      }
      try {
        const programText = document.getElementById('program-input').value.trim();
        const program = programText ? JSON.parse(programText) : [];
        const data = await api(`/api/student/levels/${state.selectedLevel}/run`, { method: 'POST', body: { program } });
        state.lastRun = data;
        document.getElementById('run-result').textContent = JSON.stringify(data, null, 2);
        document.getElementById('result-steps').value = data.steps ?? 0;
        document.getElementById('result-stars').value = data.stars ?? 0;
        setStatus(data.success ? '模拟成功，请提交结算。' : '模拟未达成目标，请查看提示。', data.success ? 'success' : 'info');
      } catch (error) {
        setStatus(error.message || '运行模拟失败', 'error');
      }
    }

    document.getElementById('run-program').addEventListener('click', runProgram);

    async function submitResult() {
      if (!state.selectedLevel) {
        setStatus('请选择关卡。', 'error');
        return;
      }
      try {
        const payload = {
          stars: Number(document.getElementById('result-stars').value || 0),
          steps: Number(document.getElementById('result-steps').value || 0),
          hints: Number(document.getElementById('result-hints').value || 0),
          duration: Number(document.getElementById('result-duration').value || 0),
          bestDifference: state.lastRun?.metadata?.bestSteps ? Math.max(0, Number(document.getElementById('result-steps').value) - state.lastRun.metadata.bestSteps) : undefined,
          replayLog: state.lastRun?.log || [],
        };
        const data = await api(`/api/student/levels/${state.selectedLevel}/complete`, { method: 'POST', body: payload });
        setStatus('结算数据已提交，冒险地图将自动更新。', 'success');
        await loadMap();
        return data;
      } catch (error) {
        setStatus(error.message || '提交结算失败', 'error');
      }
    }

    document.getElementById('submit-result').addEventListener('click', submitResult);

    document.getElementById('load-avatar').addEventListener('click', async () => {
      try {
        const data = await api('/api/student/avatar');
        document.getElementById('avatar-info').textContent = JSON.stringify(data, null, 2);
        document.getElementById('equip-input').value = data.equipped;
        setStatus('已读取角色装扮。', 'success');
      } catch (error) {
        setStatus(error.message || '无法加载装扮', 'error');
      }
    });

    document.getElementById('equip-submit').addEventListener('click', async () => {
      try {
        const equipped = document.getElementById('equip-input').value.trim();
        if (!equipped) {
          setStatus('请输入装扮 ID。', 'error');
          return;
        }
        const data = await api('/api/student/avatar', { method: 'PUT', body: { equipped } });
        document.getElementById('avatar-info').textContent = JSON.stringify(data, null, 2);
        setStatus('装扮已更新。', 'success');
      } catch (error) {
        setStatus(error.message || '装扮更新失败', 'error');
      }
    });

    document.getElementById('load-settings').addEventListener('click', async () => {
      try {
        const data = await api('/api/student/settings');
        document.getElementById('settings-info').textContent = JSON.stringify(data, null, 2);
        document.getElementById('volume-input').value = data.volume;
        document.getElementById('language-input').value = data.language;
        setStatus('已读取设置。', 'success');
      } catch (error) {
        setStatus(error.message || '无法获取设置', 'error');
      }
    });

    document.getElementById('save-settings').addEventListener('click', async () => {
      try {
        const volume = Number(document.getElementById('volume-input').value);
        const language = document.getElementById('language-input').value || 'zh-CN';
        const data = await api('/api/student/settings', { method: 'PUT', body: { volume, language } });
        document.getElementById('settings-info').textContent = JSON.stringify(data, null, 2);
        setStatus('设置已保存。', 'success');
      } catch (error) {
        setStatus(error.message || '保存设置失败', 'error');
      }
    });

    document.getElementById('reset-progress').addEventListener('click', async () => {
      if (!confirm('确认重置所有进度？该操作不可恢复。')) {
        return;
      }
      try {
        await api('/api/student/settings/reset-progress', { method: 'POST' });
        setStatus('进度已重置，请重新挑战关卡。', 'success');
        await loadMap();
      } catch (error) {
        setStatus(error.message || '重置失败', 'error');
      }
    });

    document.getElementById('load-sandbox').addEventListener('click', async () => {
      try {
        const data = await api('/api/student/sandbox');
        document.getElementById('sandbox-info').textContent = JSON.stringify(data, null, 2);
        setStatus(data.sandboxUnlocked ? '沙盒已解锁，尽情创作！' : '尚未解锁沙盒，请继续通关章节。', 'info');
      } catch (error) {
        setStatus(error.message || '无法获取沙盒信息', 'error');
      }
    });

    document.getElementById('create-sandbox').addEventListener('click', async () => {
      try {
        const title = document.getElementById('sandbox-title-input').value || '未命名作品';
        const data = await api('/api/student/sandbox', { method: 'POST', body: { title, data: { createdVia: 'frontend-demo' } } });
        document.getElementById('sandbox-info').textContent = JSON.stringify(data, null, 2);
        document.getElementById('sandbox-id-input').value = data.id;
        setStatus('已创建新的沙盒作品草稿。', 'success');
      } catch (error) {
        setStatus(error.message || '创建沙盒作品失败', 'error');
      }
    });

    document.getElementById('update-sandbox').addEventListener('click', async () => {
      try {
        const id = document.getElementById('sandbox-id-input').value.trim();
        if (!id) {
          setStatus('请输入作品 ID。', 'error');
          return;
        }
        const status = document.getElementById('sandbox-status').value;
        const data = await api(`/api/student/sandbox/${id}`, { method: 'PATCH', body: { status } });
        document.getElementById('sandbox-info').textContent = JSON.stringify(data, null, 2);
        setStatus(status === 'published' ? '作品已发布，等待老师审核。' : '作品已保存为草稿。', 'success');
      } catch (error) {
        setStatus(error.message || '更新作品失败', 'error');
      }
    });

    document.getElementById('load-library').addEventListener('click', async () => {
      try {
        const data = await api('/api/student/library');
        document.getElementById('library-info').textContent = JSON.stringify(data, null, 2);
        setStatus('已加载班级作品库。', 'success');
      } catch (error) {
        setStatus(error.message || '获取作品库失败', 'error');
      }
    });

    document.getElementById('submit-comment').addEventListener('click', async () => {
      try {
        const workId = document.getElementById('comment-work-id').value.trim();
        const content = document.getElementById('comment-content').value.trim();
        if (!workId || !content) {
          setStatus('请输入作品 ID 和评论内容。', 'error');
          return;
        }
        const data = await api(`/api/student/library/${workId}/comment`, { method: 'POST', body: { content } });
        setStatus('评论已提交。', 'success');
        document.getElementById('library-info').textContent = `最新评论：\n${JSON.stringify(data, null, 2)}`;
      } catch (error) {
        setStatus(error.message || '评论失败', 'error');
      }
    });

    if (state.userId) {
      setStatus('检测到已登录身份，正在加载冒险地图…', 'info');
      syncAuthState();
      loadMap();
    }
  </script>
</body>
</html>
