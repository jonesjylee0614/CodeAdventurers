<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ•™å¸ˆç«¯ - CodeAdventurers</title>
  <style>
    body {
      margin: 0;
      font-family: 'Microsoft YaHei', system-ui, sans-serif;
      background: linear-gradient(135deg, #4e54c8 0%, #8f94fb 100%);
      color: #1f2937;
    }

    header {
      color: #fff;
      text-align: center;
      padding: 48px 24px 16px;
    }

    header h1 {
      margin: 0 0 8px;
      font-size: 2.4rem;
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
      display: grid;
      gap: 20px;
    }

    .status {
      padding: 14px 18px;
      border-radius: 12px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.7);
      color: #1d4ed8;
    }

    .status.error { color: #b91c1c; background: rgba(254, 202, 202, 0.7); }
    .status.success { color: #047857; background: rgba(204, 251, 241, 0.7); }

    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 16px 30px rgba(45, 55, 72, 0.25);
      backdrop-filter: blur(12px);
    }

    .card h2 {
      margin-top: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-size: 0.9rem;
      font-weight: 500;
    }

    input, textarea, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(99, 102, 241, 0.3);
      margin-bottom: 12px;
      font-family: inherit;
      font-size: 0.95rem;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    button {
      background: linear-gradient(135deg, #6366f1 0%, #4338ca 100%);
      border: none;
      border-radius: 999px;
      color: #fff;
      font-weight: 600;
      padding: 10px 18px;
      cursor: pointer;
      margin-right: 8px;
      margin-bottom: 8px;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 12px 24px rgba(99, 102, 241, 0.25);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 28px rgba(99, 102, 241, 0.3);
    }

    button:disabled {
      opacity: 0.6;
      box-shadow: none;
      transform: none;
      cursor: not-allowed;
    }

    pre {
      background: #0f172a;
      color: #e2e8f0;
      padding: 12px;
      border-radius: 12px;
      overflow-x: auto;
      font-size: 0.85rem;
    }

    .grid {
      display: grid;
      gap: 20px;
    }

    @media (min-width: 960px) {
      .grid.two-columns {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ‘©â€ğŸ« CodeAdventurers æ•™å¸ˆè¿è¥å°</h1>
    <p>ç®¡ç†è¯¾ç¨‹ã€ç­çº§ä¸ä½œå“ï¼Œå®æ—¶æŒæ¡å­¦ç”Ÿå­¦ä¹ æ•°æ®ã€‚</p>
  </header>
  <main>
    <div id="status" class="status" role="status">è¯·å…ˆé…ç½®æ•™å¸ˆèº«ä»½ã€‚</div>

    <section class="grid two-columns">
      <article class="card" aria-labelledby="identity-title">
        <h2 id="identity-title">ğŸ” æ•™å¸ˆèº«ä»½</h2>
        <label for="teacher-id">ç”¨æˆ· ID</label>
        <input id="teacher-id" type="text" placeholder="teacher-1" />
        <button id="apply-id">åº”ç”¨èº«ä»½</button>
        <button id="forget-id">æ¸…é™¤è®°å½•</button>
        <p>å½“å‰ IDï¼š<strong id="current-id">æœªè®¾ç½®</strong></p>
      </article>

      <article class="card" aria-labelledby="course-title">
        <h2 id="course-title">ğŸ“š è¯¾ç¨‹ç®¡ç†</h2>
        <div>
          <button id="load-courses" disabled>åŠ è½½è¯¾ç¨‹åˆ—è¡¨</button>
          <pre id="courses-output">å°šæœªåŠ è½½</pre>
        </div>
        <div>
          <label for="course-name">è¯¾ç¨‹åç§°</label>
          <input id="course-name" type="text" placeholder="é¡ºåºæŒ‡ä»¤è¿›é˜¶" />
          <label for="course-desc">è¯¾ç¨‹æè¿°</label>
          <textarea id="course-desc" placeholder="ä»‹ç»è¯¾ç¨‹ç›®æ ‡ã€é€‚ç”¨å¹´çº§ç­‰ä¿¡æ¯"></textarea>
          <button id="create-course" disabled>æ–°å»ºè¯¾ç¨‹</button>
        </div>
        <div>
          <label for="chapter-course-id">æ‰€å±è¯¾ç¨‹ ID</label>
          <input id="chapter-course-id" type="text" placeholder="course-1" />
          <label for="chapter-title">ç« èŠ‚æ ‡é¢˜</label>
          <input id="chapter-title" type="text" placeholder="ç¬¬äºŒç« ï¼šæ¡ä»¶åˆ¤æ–­" />
          <button id="create-chapter" disabled>æ–°å¢ç« èŠ‚</button>
        </div>
        <div>
          <label for="level-chapter-id">ç« èŠ‚ ID</label>
          <input id="level-chapter-id" type="text" placeholder="chapter-1" />
          <label for="level-definition">å…³å¡å®šä¹‰ï¼ˆJSONï¼‰</label>
          <textarea id="level-definition" spellcheck="false">{
  "level": {
    "id": "level-demo",
    "name": "ç¤ºä¾‹å…³å¡",
    "width": 3,
    "height": 3,
    "tiles": [
      { "x": 0, "y": 0, "walkable": true },
      { "x": 1, "y": 0, "walkable": true },
      { "x": 2, "y": 0, "walkable": true },
      { "x": 2, "y": 1, "walkable": true, "collectible": "gem" },
      { "x": 2, "y": 2, "walkable": true }
    ],
    "start": { "x": 0, "y": 0, "facing": "east" },
    "goal": { "reach": { "x": 2, "y": 1 }, "collectibles": 1, "stepLimit": 12 },
    "bestSteps": 4,
    "hints": ["å‘å‰ç§»åŠ¨", "æ‹¾å–å®çŸ³", "è¿”å›å‡ºå£"],
    "comic": "å¸®åŠ©è§’è‰²æ‹¾å–å®çŸ³å¹¶å®‰å…¨è¿”å›ã€‚",
    "allowedBlocks": ["MOVE", "TURN_LEFT", "TURN_RIGHT"],
    "rewards": { "stars": 3, "outfit": null }
  }
}</textarea>
          <button id="create-level" disabled>æ·»åŠ å…³å¡</button>
        </div>
      </article>

      <article class="card" aria-labelledby="class-title">
        <h2 id="class-title">ğŸ« ç­çº§ç®¡ç†</h2>
        <div>
          <button id="load-progress" disabled>åŠ è½½ç­çº§æ¦‚è§ˆ</button>
          <pre id="progress-output">å°šæœªåŠ è½½</pre>
        </div>
        <div>
          <label for="student-class-id">ç­çº§ ID</label>
          <input id="student-class-id" type="text" placeholder="class-1" />
          <label for="student-name">å­¦ç”Ÿå§“å</label>
          <input id="student-name" type="text" placeholder="æ–°åŒå­¦å§“å" />
          <button id="add-student" disabled>æ·»åŠ å­¦ç”Ÿ</button>
        </div>
        <div>
          <label for="assign-class-id">ç­çº§ ID</label>
          <input id="assign-class-id" type="text" placeholder="class-1" />
          <label for="assign-course-id">è¯¾ç¨‹ ID</label>
          <input id="assign-course-id" type="text" placeholder="course-1" />
          <button id="assign-course" disabled>å¸ƒç½®è¯¾ç¨‹</button>
        </div>
        <div>
          <label for="hint-class-id">ç­çº§ ID</label>
          <input id="hint-class-id" type="text" placeholder="class-1" />
          <label for="hint-limit">æç¤ºä¸Šé™</label>
          <input id="hint-limit" type="number" min="0" value="3" />
          <button id="update-hint" disabled>æ›´æ–°æç¤ºæ¬¡æ•°</button>
        </div>
      </article>

      <article class="card" aria-labelledby="analytics-title">
        <h2 id="analytics-title">ğŸ“Š å­¦ä¹ æ•°æ®</h2>
        <div>
          <button id="load-heatmap" disabled>æ¦‚å¿µçƒ­åŠ›å›¾</button>
          <pre id="heatmap-output">å°šæœªåŠ è½½</pre>
        </div>
        <div>
          <label for="replay-student-id">å­¦ç”Ÿ ID</label>
          <input id="replay-student-id" type="text" placeholder="student-1" />
          <label for="replay-level-id">å…³å¡ ID</label>
          <input id="replay-level-id" type="text" placeholder="level-1" />
          <button id="load-replay" disabled>æŸ¥çœ‹å›æ”¾æ—¥å¿—</button>
          <pre id="replay-output">å°šæœªåŠ è½½</pre>
        </div>
      </article>

      <article class="card" aria-labelledby="works-title">
        <h2 id="works-title">ğŸ“ ä½œå“å®¡æ ¸</h2>
        <div>
          <button id="load-works" disabled>å¾…å®¡æ ¸ä½œå“</button>
          <pre id="works-output">å°šæœªåŠ è½½</pre>
        </div>
        <div>
          <label for="review-work-id">ä½œå“ ID</label>
          <input id="review-work-id" type="text" placeholder="work-..." />
          <select id="review-status">
            <option value="approved">é€šè¿‡</option>
            <option value="rejected">é©³å›</option>
          </select>
          <button id="submit-review" disabled>æäº¤å®¡æ ¸</button>
        </div>
      </article>
    </section>
  </main>
  <script type="module">
    const statusBox = document.getElementById('status');
    const buttons = Array.from(document.querySelectorAll('button')).filter((btn) => !['apply-id', 'forget-id'].includes(btn.id));
    const state = {
      userId: localStorage.getItem('teacherUserId') || '',
    };

    const idInput = document.getElementById('teacher-id');
    const currentId = document.getElementById('current-id');

    function setStatus(message, type = 'info') {
      statusBox.textContent = message;
      statusBox.className = `status ${type === 'error' ? 'error' : type === 'success' ? 'success' : ''}`.trim() || 'status';
    }

    function syncState() {
      const enabled = Boolean(state.userId);
      currentId.textContent = enabled ? state.userId : 'æœªè®¾ç½®';
      for (const btn of buttons) {
        btn.disabled = !enabled;
      }
      if (enabled) {
        setStatus(`å·²å¯ç”¨æ•™å¸ˆèº«ä»½ ${state.userId}ã€‚`, 'success');
      } else {
        setStatus('è¯·å…ˆé…ç½®æ•™å¸ˆèº«ä»½ã€‚', 'info');
      }
    }

    function authHeaders() {
      return state.userId ? { 'x-user-id': state.userId } : {};
    }

    async function api(path, options = {}) {
      const opts = { method: 'GET', ...options };
      opts.headers = { 'Content-Type': 'application/json', ...authHeaders(), ...(options.headers || {}) };
      if (options.body && typeof options.body !== 'string') {
        opts.body = JSON.stringify(options.body);
      }
      const response = await fetch(path, opts);
      const text = await response.text();
      let data = null;
      try {
        data = text ? JSON.parse(text) : null;
      } catch (error) {
        data = text;
      }
      if (!response.ok) {
        throw new Error(data?.message || response.statusText);
      }
      return data;
    }

    document.getElementById('apply-id').addEventListener('click', () => {
      const value = idInput.value.trim() || 'teacher-1';
      state.userId = value;
      localStorage.setItem('teacherUserId', value);
      syncState();
    });

    document.getElementById('forget-id').addEventListener('click', () => {
      localStorage.removeItem('teacherUserId');
      state.userId = '';
      syncState();
    });

    document.getElementById('load-courses').addEventListener('click', async () => {
      try {
        const data = await api('/api/teacher/courses');
        document.getElementById('courses-output').textContent = JSON.stringify(data.courses, null, 2);
        setStatus('è¯¾ç¨‹åˆ—è¡¨å·²æ›´æ–°ã€‚', 'success');
      } catch (error) {
        setStatus(error.message || 'åŠ è½½è¯¾ç¨‹å¤±è´¥', 'error');
      }
    });

    document.getElementById('create-course').addEventListener('click', async () => {
      try {
        const name = document.getElementById('course-name').value || 'æœªå‘½åè¯¾ç¨‹';
        const description = document.getElementById('course-desc').value || '';
        const data = await api('/api/teacher/courses', { method: 'POST', body: { name, description } });
        document.getElementById('courses-output').textContent = JSON.stringify(data, null, 2);
        setStatus('è¯¾ç¨‹å·²åˆ›å»ºã€‚', 'success');
      } catch (error) {
        setStatus(error.message || 'åˆ›å»ºè¯¾ç¨‹å¤±è´¥', 'error');
      }
    });

    document.getElementById('create-chapter').addEventListener('click', async () => {
      try {
        const courseId = document.getElementById('chapter-course-id').value.trim();
        const title = document.getElementById('chapter-title').value || 'æœªå‘½åç« èŠ‚';
        if (!courseId) {
          setStatus('è¯·è¾“å…¥è¯¾ç¨‹ IDã€‚', 'error');
          return;
        }
        const data = await api(`/api/teacher/courses/${courseId}/chapters`, { method: 'POST', body: { title } });
        document.getElementById('courses-output').textContent = JSON.stringify(data, null, 2);
        setStatus('ç« èŠ‚å·²åˆ›å»ºã€‚', 'success');
      } catch (error) {
        setStatus(error.message || 'åˆ›å»ºç« èŠ‚å¤±è´¥', 'error');
      }
    });

    document.getElementById('create-level').addEventListener('click', async () => {
      try {
        const chapterId = document.getElementById('level-chapter-id').value.trim();
        if (!chapterId) {
          setStatus('è¯·è¾“å…¥ç« èŠ‚ IDã€‚', 'error');
          return;
        }
        const text = document.getElementById('level-definition').value.trim();
        const payload = text ? JSON.parse(text) : null;
        if (!payload?.level?.id) {
          setStatus('JSON ä¸­ç¼ºå°‘ level.idã€‚', 'error');
          return;
        }
        const data = await api(`/api/teacher/chapters/${chapterId}/levels`, { method: 'POST', body: payload });
        setStatus('å…³å¡å·²æ·»åŠ åˆ°ç« èŠ‚ã€‚', 'success');
        document.getElementById('courses-output').textContent = JSON.stringify(data, null, 2);
      } catch (error) {
        setStatus(error.message || 'åˆ›å»ºå…³å¡å¤±è´¥', 'error');
      }
    });

    document.getElementById('load-progress').addEventListener('click', async () => {
      try {
        const data = await api('/api/teacher/analytics/progress');
        document.getElementById('progress-output').textContent = JSON.stringify(data.classes, null, 2);
        setStatus('ç­çº§è¿›åº¦å·²è·å–ã€‚', 'success');
      } catch (error) {
        setStatus(error.message || 'åŠ è½½ç­çº§è¿›åº¦å¤±è´¥', 'error');
      }
    });

    document.getElementById('add-student').addEventListener('click', async () => {
      try {
        const classId = document.getElementById('student-class-id').value.trim();
        const name = document.getElementById('student-name').value || 'æ–°åŒå­¦';
        if (!classId) {
          setStatus('è¯·è¾“å…¥ç­çº§ IDã€‚', 'error');
          return;
        }
        const data = await api(`/api/teacher/classes/${classId}/students`, { method: 'POST', body: { name } });
        document.getElementById('progress-output').textContent = JSON.stringify(data, null, 2);
        setStatus('å­¦ç”Ÿå·²åŠ å…¥ç­çº§ã€‚', 'success');
      } catch (error) {
        setStatus(error.message || 'æ·»åŠ å­¦ç”Ÿå¤±è´¥', 'error');
      }
    });

    document.getElementById('assign-course').addEventListener('click', async () => {
      try {
        const classId = document.getElementById('assign-class-id').value.trim();
        const courseId = document.getElementById('assign-course-id').value.trim();
        if (!classId || !courseId) {
          setStatus('è¯·è¾“å…¥ç­çº§ ID å’Œè¯¾ç¨‹ IDã€‚', 'error');
          return;
        }
        const data = await api(`/api/teacher/classes/${classId}/assign-course`, { method: 'POST', body: { courseId } });
        document.getElementById('progress-output').textContent = JSON.stringify(data, null, 2);
        setStatus('è¯¾ç¨‹å·²å¸ƒç½®ç»™ç­çº§ã€‚', 'success');
      } catch (error) {
        setStatus(error.message || 'å¸ƒç½®è¯¾ç¨‹å¤±è´¥', 'error');
      }
    });

    document.getElementById('update-hint').addEventListener('click', async () => {
      try {
        const classId = document.getElementById('hint-class-id').value.trim();
        const hintLimit = Number(document.getElementById('hint-limit').value || 0);
        if (!classId) {
          setStatus('è¯·è¾“å…¥ç­çº§ IDã€‚', 'error');
          return;
        }
        const data = await api(`/api/teacher/classes/${classId}/hint-limit`, { method: 'PATCH', body: { hintLimit } });
        document.getElementById('progress-output').textContent = JSON.stringify(data, null, 2);
        setStatus('æç¤ºæ¬¡æ•°å·²æ›´æ–°ã€‚', 'success');
      } catch (error) {
        setStatus(error.message || 'æ›´æ–°æç¤ºæ¬¡æ•°å¤±è´¥', 'error');
      }
    });

    document.getElementById('load-heatmap').addEventListener('click', async () => {
      try {
        const data = await api('/api/teacher/analytics/heatmap');
        document.getElementById('heatmap-output').textContent = JSON.stringify(data.heatmap, null, 2);
        setStatus('çƒ­åŠ›å›¾æ•°æ®å·²åŠ è½½ã€‚', 'success');
      } catch (error) {
        setStatus(error.message || 'è·å–çƒ­åŠ›å›¾å¤±è´¥', 'error');
      }
    });

    document.getElementById('load-replay').addEventListener('click', async () => {
      try {
        const studentId = document.getElementById('replay-student-id').value.trim();
        const levelId = document.getElementById('replay-level-id').value.trim();
        if (!studentId || !levelId) {
          setStatus('è¯·è¾“å…¥å­¦ç”Ÿ ID å’Œå…³å¡ IDã€‚', 'error');
          return;
        }
        const data = await api(`/api/teacher/analytics/replays/${studentId}/${levelId}`);
        document.getElementById('replay-output').textContent = JSON.stringify(data.replay, null, 2);
        setStatus('å·²è·å–é€šå…³å›æ”¾ã€‚', 'success');
      } catch (error) {
        setStatus(error.message || 'è·å–å›æ”¾å¤±è´¥', 'error');
      }
    });

    document.getElementById('load-works').addEventListener('click', async () => {
      try {
        const data = await api('/api/teacher/works/pending');
        document.getElementById('works-output').textContent = JSON.stringify(data.works, null, 2);
        setStatus('å¾…å®¡æ ¸ä½œå“å·²åŠ è½½ã€‚', 'success');
      } catch (error) {
        setStatus(error.message || 'è·å–å¾…å®¡æ ¸ä½œå“å¤±è´¥', 'error');
      }
    });

    document.getElementById('submit-review').addEventListener('click', async () => {
      try {
        const workId = document.getElementById('review-work-id').value.trim();
        const statusValue = document.getElementById('review-status').value;
        if (!workId) {
          setStatus('è¯·è¾“å…¥ä½œå“ IDã€‚', 'error');
          return;
        }
        const data = await api(`/api/teacher/works/${workId}/review`, { method: 'POST', body: { status: statusValue } });
        document.getElementById('works-output').textContent = JSON.stringify(data, null, 2);
        setStatus('å®¡æ ¸ç»“æœå·²æäº¤ã€‚', 'success');
      } catch (error) {
        setStatus(error.message || 'å®¡æ ¸å¤±è´¥', 'error');
      }
    });

    if (state.userId) {
      idInput.value = state.userId;
    }
    syncState();
  </script>
</body>
</html>
