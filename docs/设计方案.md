# 《代码奇兵 Code Adventurers》完整需求与技术规格（研发交付版 v1.0）

> 面向研发、测试、产品、教学设计与美术团队。交付本稿后，团队可独立完成从 MVP 到正式版的设计、开发、测试与上线。

---

## 0. 版本与范围

* 文档版本：v1.0（2025-09-25）
* 交付范围：

  1. 学生端（Web 首版）
  2. 关卡与课程后台（ECET 通用编辑器）
  3. 教师/家长端基础看板
  4. 服务端（API/数据/鉴权/遥测）
* 不在本期范围：移动端原生发布、AI 自适应出题（可列为后续路线）

---

## 1. 产品价值与闭环校验

### 1.1 学习与动机闭环（L1）

**目标感 → 行动 → 反馈 → 纠错 → 成功 → 奖励 → 进阶 → 创作/分享**

* 目标感：每关顶部明确“胜利条件”（文本+图标），进入前有 1 屏漫画说明“为什么要这样做”。
* 行动：拖拽积木编程，运行后按“指令步进高亮”。
* 反馈：成功/失败实时动画、语音与粒子特效；失败弹出“错误原因三选一”→个性化提示。
* 纠错：渐进式 Hint（1 次：高亮下一块；2 次：伪代码；3 次：可插半成品模块）。
* 成功：结算面板展示“最小步数/本次步数/最佳方案差距”。
* 奖励：星级（1–3），徽章，收集物（图鉴），装扮解锁（不含付费抽卡）。
* 进阶：地图解锁下一关；章节 Boss 关汇总概念；通关章节解锁沙盒。
* 创作/分享：沙盒创作→班级内分享→教师审核→同学三连（赞/评/收藏）。

**验收标准（闭环 AC）**

* AC-L1-01：新用户≤60 秒完成首关（仅顺序指令），可获得至少 1 星与 1 件装扮。
* AC-L1-02：失败≥2 次时，提示内容与其真实错误类型匹配（见错误分类表）。
* AC-L1-03：通关后自动推进地图节点并触发下一步动机文案（见文案库）。
* AC-L1-04：完成一章后自动解锁沙盒，并在首页以“作品位”召回。

### 1.2 教学闭环（L2）

**课程大纲 → 关卡编排 → 掌握评估 → 复训任务 → 家校沟通**

* 教师后台按概念（顺序/循环/条件/变量/事件）布置关卡集。
* 学生端自动上报关卡遥测（使用的积木、Hint 次数、时长）。
* 教师看板提供“概念热力图”和“卡关榜单”，可一键布置复训关。
* 家长每周收到周报：学了什么/易错点/亲子线下练习。

**验收标准（闭环 AC）**

* AC-L2-01：每关埋点完整，教师看板能看到班级概念热力图。
* AC-L2-02：可从某学生的任一关卡回放完整运行轨迹（指令级）。
* AC-L2-03：从卡关榜单可一键下发“针对性关卡集”。

---

## 2. 用户与角色权限

* **学生**：游玩关卡、沙盒创作、查看奖励、班级内分享。
* **教师**：建课程、配关卡、挑选可用积木、布置班级、审核作品、查看看板。
* **家长**：查看学习进度与周报（无编辑权）。
* **管理员**：运营与风控、素材管理、账号管理、数据导出。

---

## 3. 信息架构与页面清单（UI 全量）

### 3.1 学生端

1. **启动/登录**（支持“游客模式”与班级邀请码登录）
2. **首页/冒险地图**（章节岛屿→关卡节点）
3. **关卡准备页**（胜利条件/可用积木/教学漫画 1 屏）
4. **关卡主界面**（左：场景；中：积木库；右：程序区；顶：目标/运行/重置/提示）
5. **结算页**（星级/奖励/最佳方案差距/下一步 CTA）
6. **角色/装扮**（装扮更换与来源说明）
7. **图鉴馆/成就**（章节藏品、徽章、获得条件）
8. **沙盒创作**（空场景+全部已学积木；保存/测试/发布）
9. **作品库（班级）**（浏览/点赞/评论-家长/教师可见设置）
10. **设置**（音量、低动效模式、语言、重置关卡进度）

### 3.2 教师端

1. **课程管理**（创建课程→章节→关卡集）
2. **关卡编辑器**（ECET：场景/实体/组件；事件-条件-动作；目标编辑；可用积木）
3. **班级与布置**（添加学生、布置课程、设置提示次数上限）
4. **进度与看板**（掌握热力图、卡关榜单、用时统计、回放入口）
5. **作品审核**（UGC 审核与下架）

### 3.3 家长端

1. **孩子进度页**（已学概念、星级、常见错误）
2. **周报**（自动生成，可导出 PDF）

**UI 要素通用规范**

* 触控目标≥44px，按钮主色与辅助色对比≥4.5:1；
* 所有可读文字支持“朗读”按钮；
* 色盲安全调色板，支持“低动效模式”。

---

## 4. 交互与流程（关键流＋状态机）

### 4.1 首次上手 ≤60s 流程

1. 游客进入 → 2) 自动进入“首关演示” → 3) 仅展示【开始】【前进】两块积木 → 4) 一键运行获得 1 星与装扮 → 5) 弹窗邀请命名角色并返回地图。

### 4.2 关卡游玩流程（状态机）

**Idle → Editing → Running → Paused → Success/Fail → Settle → Next**

* Running：VM 每步发出 `tick`，高亮对应积木并驱动渲染。
* Fail：分类识别 `撞墙/未达目标/变量未满足/死循环保护` → 提示队列。
* Success：触发 `onComplete` 动作（庆祝动画/解锁奖励/上报埋点）。

### 4.3 Hint 渐进策略

* 第 1 次失败：高亮“下一块可能需要的控制类块”。
* 第 2 次失败：展示伪代码/口播。
* 第 3 次失败：可插半成品模块（需二次确认）。
* Hint 被使用将影响结算评级（最多降 1 星）。

### 4.4 沙盒创作与分享

* 保存为草稿 → 本地测试 → 发布至班级 → 教师审核通过后班级可见。

---

## 5. 教学大纲与章节设计（MVP → 正式）

* 章 1：顺序与方位（6 关）
* 章 2：循环（固定次数/直到条件）（6 关）
* 章 3：条件与感知（墙/颜色/地形）（6 关）
* 章 4：变量与计数器（宝石/钥匙）（6 关）
* 章 5：事件与交互（NPC/机关）（6 关）
* 章 Boss：综合运用（1 关）
* 章节通关解锁沙盒创作主题模板 1 个

**每关结构**：教学漫画（≤1 屏）→ 目标明示 → 可用积木清单 → 关卡地图 → 通过阈值（最小步数/最大步数/提示次数上限）

---

## 6. 游戏化与动机设计（可执行）

* **星级**：①通关；②步数≤阈值1；③无提示/无撞墙。
* **装扮**：章节主题套装，来源清晰（“在 2-3 关 3 星获得斗篷”）。
* **图鉴**：每章 1 件藏品（点击有故事旁白）。
* **连击鼓励**：连续 3 天学习点亮“冒险火把”。
* **无氪无抽**：杜绝概率箱，避免不良强化。

---

## 7. 技术架构与执行引擎

### 7.1 前端

* 技术栈：TypeScript + React（推荐）+ Zustand/Redux；渲染 Pixi.js 或 Phaser。
* 层次：**编程 VM（逻辑）** 与 **渲染层** 分离；VM 决定论、可回放。
* 资产：雪碧图打包，分章节懒加载，WebGL→Canvas 降级。

### 7.2 指令集（IR/VM）

* **指令表（节选）**
  `START, MOVE(n), TURN(dir), JUMP, IF(cond, thenBlock, elseBlock?), REPEAT(n, block), SET(var, val), ADD(var, delta), WAIT(ms)`
* **条件**：`FRONT_IS_WALL, ON_COLOR(c), HIT(entityType)`
* **执行语义**：单步 `tick()`；每步产出日志 `{pc, opcode, args, worldDelta}`；最大步数与最大嵌套深度保护。
* **错误码**：`E_COLLIDE, E_GOAL_NOT_MET, E_STEP_LIMIT, E_LOOP_DEPTH, E_INVALID_BLOCK`。

### 7.3 Blockly 自定义块规范（示例）

* `repeat_n`

```json
{
  "type": "repeat_n",
  "message0": "重复 %1 次",
  "args0": [{ "type": "input_value", "name": "TIMES", "check": "Number" }],
  "message1": "%1",
  "args1": [{ "type": "input_statement", "name": "DO" }],
  "colour": 120,
  "tooltip": "重复执行 N 次",
  "previousStatement": null,
  "nextStatement": null
}
```

* 代码生成→IR：`repeat_n(TIMES){ DO }` 映射 `REPEAT`。

### 7.4 ECET 数据模型

* **Entity**：`{id,type,sprite,initState,components[]}`
* **Component**（含 schema）：

  * `Controllable{speed:number}`
  * `Collider{solid:boolean}`
  * `Collectable{var:string, inc:number}`
  * \`Target{}
  * `Lockable{keyId:string}`
  * `AutoMove{path:[{x,y}], loop:boolean}`
* **Event**：`onGameStart, onCollide(A,B), onCollect(item), onVarReach(name, value)`
* **Action**：`destroy(entityId), playAnim(id,name), setVar(name,val), addVar(name,delta), toggleComponent(id,cName,enabled)`
* **Goal**：AND/OR 组合，示例：

```json
{
  "goals": [
    {"type":"reach","entity":"flag"},
    {"type":"var_gte","var":"gems","value":5}
  ],
  "onComplete": [
    {"action":"playAnim","target":"player","name":"celebrate"},
    {"action":"unlockSkin","skinId":"cape_red"}
  ]
}
```

### 7.5 关卡文件与版本

* 顶层：`levelVersion, scene, entities[], components[], events[], goals[], availableBlocks[]`
* 版本策略：向后兼容；增加新字段必须可默认；提供关卡迁移脚本。

---

## 8. 服务端 API（REST 示例）

**鉴权**：学生游客 token（设备+匿名 ID），家长/教师账户 JWT；班级邀请码绑定。

* `POST /auth/login`（家长/教师）
* `POST /class/join`（学生邀请码）
* `GET /levels/{chapterId}` → 关卡列表（含可用积木摘要）
* `GET /level/{levelId}` → 关卡 JSON（ECET+IR 限定）
* `POST /progress/report` → `{userId, levelId, stars, steps, hints, timeline[]}`
* `GET /dashboard/class/{classId}` → 班级掌握图谱
* `POST /ugc/publish` → 发布沙盒作品（需审核）
* `POST /ugc/review`（教师） → 审核通过/驳回
* `GET /replay/{recordId}` → 运行回放日志

**错误返回统一**：`{code:int, message:string, details?:obj}`

---

## 9. 数据库设计（示例以 MongoDB）

* `users`：`{_id, role, profile, classIds[], createdAt}`（索引：role, classIds）
* `classes`：`{_id, name, inviteCode, teacherId, studentIds[]}`（索引：inviteCode）
* `levels`：`{_id, chapterId, meta, payload(levelJSON), availableBlocks[], version}`（索引：chapterId）
* `progress`：`{_id, userId, levelId, stars, steps, hints, duration, replayLog[], createdAt}`（索引：userId, levelId）
* `ugc`：`{_id, authorId, title, cover, levelJSON, status, reviews[]}`（索引：status, authorId）

---

## 10. 埋点与指标（Analytics）

**关键事件**

* `level_start/level_finish/level_fail`
* `hint_used`（reason: collide/understep/logic）
* `block_used`（type,count）
* `replay_viewed`（by teacher/parent）

**核心看板**

* 概念掌握热力图（班级×概念）
* 卡关 Top10 关卡与常见误解库
* 7 日留存/学习时长/Hint 依赖度

---

## 11. 非功能需求（NFR）

* **性能**：低端平板 2GB RAM，30fps；首屏 < 3s，关卡加载 < 2s。
* **兼容**：WebGL→Canvas 兜底；离线重试与断点续练。
* **隐私与合规**：最小化数据采集；家长同意；UGC 文本脏词/隐私检测；分享仅班级内默认。
* **安全**：沙箱执行（无 `eval` 外泄），素材域名白名单，API 速率限制。
* **可访问性**：朗读、色盲安全、低动效；键盘操作可达。

---

## 12. 视觉与音频规范（Art Bible 简版）

* 风格：可爱卡通、线条简洁、低纯度大色块；
* 分辨率：基准 1920×1080，导出 1x/2x；
* 格式：PNG（图像）/WebP 优先，音频 OGG/MP3；
* 雪碧图：分章节打包，最大单包 < 2MB；
* 交互音：点击、成功、失败、收集、解锁；音量峰值统一。

---

## 13. 文案与本地化

* 所有文案集中 `i18n.json`；
* 小学生口语风 + 旁白可读；
* 例：

  * 失败提示（撞墙）：“哎呀，前面有墙！换个方向试试？”
  * 解锁沙盒：“太棒了！你现在可以自己做游戏啦～”

---

## 14. 测试计划与验收

### 14.1 用例（示例）

* **US-001 新手首关**：Given 首次进入 When 点击开始 Then 60s 内完成并获得装扮。
* **US-012 失败提示匹配**：Given 连续 2 次因撞墙失败 When 第 3 次运行 Then 提示“检查转向”。
* **US-025 回放**：Given 学生完成关卡 When 教师点击回放 Then 按指令逐步复现。

### 14.2 Definition of Done（DoD）

* 功能通过 AC； 95% 单测覆盖 VM 指令与条件；E2E 核心路径（首关/结算/上报/回放）绿灯；
* 低端设备实测帧率≥30；
* 无 P0/P1 bug；
* 安全扫描与隐私审计通过。

---

## 15. 项目里程碑（建议）

* **Sprint 0（1 周）**：原型搭建、资产管线、关卡 JSON 草案、CI。
* **Sprint 1（2 周）**：学生端 MVP（顺序+循环，6 关）、VM 指令最小集、结算与奖励。
* **Sprint 2（2 周）**：教师编辑器 Lite（场景、实体、目标、可用积木）、关卡发布流。
* **Sprint 3（2 周）**：Hint、回放、教师看板 v1、埋点与报表。
* **Sprint 4（2 周）**：沙盒与班级分享、UGC 审核、安全与可访问性收口。

---

## 16. 典型资产与样例

* **关卡样例**：`levels/sample-1.json`（含最小步数与提示策略）
* **积木样例**：`blocks/repeat_n.json`、`blocks/if_else.json`
* **事件模板**：`templates/onCollect_openDoor.json`
* **文案包**：`i18n/zh-CN.json`、`i18n/en-US.json`

---

## 17. 风险与对策

* **编辑器过复杂**：先模板化，再逐步开放事件高级配置。
* **设备性能差**：降级渲染、资源懒加载、30fps 统一目标。
* **卡关率高**：A/B 测试不同 Hint 强度，建立“误解库”。
* **UGC 风险**：严格班级内默认可见+教师审核+脏词与隐私检测。

---

## 18. 附：错误分类与提示映射

* `E_COLLIDE`：提示“前面有障碍，试试转向或绕行”。
* `E_GOAL_NOT_MET`：提示“还差 X 个宝石，看看哪里漏捡了？”
* `E_STEP_LIMIT`：提示“步骤太多了，试试‘重复’吧！”
* `E_LOOP_DEPTH`：提示“循环嵌套太深，分步试一试。”

---

> **交付清单**（落地必需）：
>
> 1. 代码仓：`/apps/student`、`/apps/teacher`、`/services/api`、`/packages/engine`
> 2. 示例关卡与积木 JSON
> 3. UI 组件库（按钮/卡片/弹窗/地图节点）
> 4. CI/CD + 质量门禁（单测、E2E、ESLint、TS 严格模式）
> 5. 运行回放查看器
> 6. 数据看板模版（Superset/Metabase 任一）

