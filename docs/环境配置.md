# 环境配置指南

本文档描述运行 Code Adventurers 平台 API 与测试所需的本地及 CI 环境配置。关于开发调试流程，请配合阅读《开发与调试指南》。

## 1. 系统依赖

- **Node.js 20+**：支持 `structuredClone`、顶层 `await` 等现代特性。建议使用 nvm 管理 Node 版本。
- **npm 9+**：用于安装依赖与运行脚本。
- **MySQL 8.0+**：提供 JSON 列与生成列支持，服务端默认使用 MySQL 连接；若未配置，则自动回退至内存实现以便测试。

## 2. 环境变量

| 变量 | 描述 | 示例 |
| --- | --- | --- |
| `MYSQL_URL` | MySQL 连接字符串，使用 `mysql://user:pass@host:port/database` 格式。设置后 API 将自动启用 MySQL 存储。 | `mysql://root:secret@127.0.0.1:3306/code_adventurers` |
| `MYSQL_TABLE_PREFIX` | （可选）多租户场景下为表名增加前缀，避免冲突。 | `staging_` |
| `MYSQL_HOST` | （可选）当未提供 `MYSQL_URL` 时，服务端会根据这些拆分变量拼装连接字符串。 | `127.0.0.1` |
| `MYSQL_PORT` | 可选，默认 `3306`。 | `3306` |
| `MYSQL_USER` | MySQL 用户名。 | `root` |
| `MYSQL_PASSWORD` | MySQL 密码，允许为空字符串。 | `secret` |
| `MYSQL_DATABASE` | 目标数据库名称。 | `code_adventurers` |

> 📝 **如何使用 `.env` 文件：**
> 1. 将仓库根目录下的 `.env.example` 复制为 `.env`。
> 2. 根据本地环境修改其中的变量，随后运行 `npm test` 或启动服务时会自动读取。
> 3. `.env` 已加入 `.gitignore`，请勿提交个人凭证。

## 3. 初始化流程

1. 安装依赖
   ```bash
   npm install
   ```
2. 创建数据库结构与样例数据
   ```bash
   mysql -u root -p < docs/database_schema.sql
   mysql -u root -p < docs/mysql_init.sql
   ```
3. 启动 API（开发模式推荐使用 `npm run dev`，会自动加载示例数据）
   ```bash
   npm run dev
   ```
   若仅需临时启动或在脚本中调用，可继续使用 `node -e "import('@api/index')..."` 的方式自行封装。
4. 运行测试
   ```bash
   npm test
   ```

## 4. CI/CD 建议

- 在 CI 中预置 MySQL 服务，并在执行测试前运行两份 SQL 脚本。
- 使用 `.env` 或密钥管理系统注入 `MYSQL_URL`，避免明文凭证。
- 建议将 `docs/database_schema.sql`、`docs/mysql_init.sql` 纳入迁移流程（如 Flyway / Liquibase），以便版本化管理。

## 5. 故障排查

| 问题 | 可能原因 | 解决方案 |
| --- | --- | --- |
| API 提示 “MySQL mode requires ...” | 未设置 `MYSQL_URL` 且未传入连接信息 | 设置环境变量或在 `createServer` 调用中传入 `context` 实例 |
| 测试连接 MySQL 失败 | 数据库未启动或账号密码错误 | 确认 MySQL 服务、端口、防火墙及凭证 |
| JSON 字段无法生成列 | MySQL 版本低于 8.0 | 升级 MySQL 或移除生成列相关语句 |

如需部署至生产环境，请结合容器化、负载均衡及日志监控等基础设施进一步完善。
