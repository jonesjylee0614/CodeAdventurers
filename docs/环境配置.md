# 环境配置指南

本文档描述运行 Code Adventurers 平台 API、前端与相关服务所需的本地及 CI 环境配置。建议先完成依赖安装，再根据《开发与调试指南》开展日常开发与调试工作。

## 1. 系统依赖

- **Go 1.23+**：用于构建与调试后端 API。推荐使用 [asdf](https://asdf-vm.com) 或官方二进制安装包管理版本。
- **Node.js 20+ / npm 9+**：驱动前端项目与工具链。
- **MySQL 8.0+**：后端默认连接到 MySQL，若未提供连接信息会退化为占位实现。
- **Redis 7+**：为异步任务调度（Asynq）与缓存提供后端存储。
- **(可选) OpenTelemetry Collector / Prometheus**：若需要链路追踪或指标采集，可在本地或 CI 中部署。

> 📦 **容器化选项**：可以使用 Docker Compose 快速启动 MySQL 与 Redis，确保端口与 `.env` 中的配置一致。

## 2. 配置文件与环境变量

后端通过环境变量驱动配置，支持从 `.env` 文件加载。复制示例配置后再根据本地环境修改：

```bash
cp backend/.env.example backend/.env
```

API 进程会在启动时自当前工作目录向上搜索最近的 `.env` 文件，因此即便在 `backend/cmd/api` 目录执行 `go run .` 也会自动加载 `backend/.env` 中的配置。

常用变量说明如下：

| 变量 | 说明 | 示例 |
| --- | --- | --- |
| `ENV` | 运行环境标识，影响日志格式与部分默认值。 | `dev` |
| `PORT` | HTTP 监听端口。 | `8080` |
| `JWT_SECRET` | 用于签发 JWT 的密钥。开发环境可使用占位符。 | `dev-secret` |
| `CORS_ORIGINS` | 允许访问的前端源，多个值用逗号分隔。 | `http://localhost:5173` |
| `MYSQL_DSN` | MySQL 连接字符串，遵循 Go 驱动格式。 | `mysql://user:pass@tcp(localhost:3306)/code_adventurers?parseTime=true&charset=utf8mb4` |
| `REDIS_ADDR` | Redis 地址，`host:port` 形式。 | `localhost:6379` |
| `ASYNQ_QUEUES` | 异步任务队列与权重设置。 | `default=10,critical=20` |
| `RATE_LIMIT_PER_MINUTE` | 每分钟允许的请求数量。 | `600` |
| `OTEL_EXPORTER_OTLP_ENDPOINT` | 可选的 OTLP Trace 导出地址。 | `http://localhost:4317` |

更多字段及默认值请参考 `backend/internal/platform/config/config.go`。

## 3. 初始化流程

1. **准备依赖**
   ```bash
   npm install          # 安装前端依赖
   go mod download ./backend
   ```
2. **初始化数据库**（若使用 MySQL）：
   ```bash
   mysql -u root -p < docs/database_schema.sql
   mysql -u root -p < database/init/mysql_init.sql
   ```
3. **启动辅助服务**：确保 Redis 与 MySQL 处于运行状态，并与 `.env` 中的地址保持一致。
4. **配置 `.env`**：根据实际环境调整数据库凭证、Redis 地址及遥测开关。

## 4. 验证环境

- 启动后端 API：`go run ./backend/cmd/api`
- 运行 Go 单元测试：`go test ./backend/...`
- 启动前端开发服务器：`cd frontend && npm run dev`

若日志中输出 `api server starting` 及监听地址，即表示后端配置成功。

## 5. 常见问题排查

| 现象 | 可能原因 | 解决方式 |
| --- | --- | --- |
| `failed to connect to MySQL` | MySQL 未启动或 DSN 配置错误 | 检查 MySQL 服务、账号密码与网络连通性 |
| `failed to initialize OpenTelemetry` | 未部署 OTel Collector | 可忽略（开发环境），或设置 `OTEL_EXPORTER_OTLP_ENDPOINT` |
| 请求持续返回 429 | 触发限流策略 | 调整 `RATE_LIMIT_PER_MINUTE` 或使用授权的源 IP |
| WebSocket 无法建立 | 缺少 `userId` 参数或代理阻断 | 在请求中提供用户标识，检查反向代理是否支持 WebSocket |

在 CI/CD 中请使用密钥管理服务注入敏感信息，并根据环境选择合适的日志与指标采集后端。
