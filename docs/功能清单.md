# 功能梳理与实现状态总览

> 基于《设计方案.md》v1.0，对学生、教师、家长、管理员与基础设施的功能逐条核查，并标注主要代码实现与测试覆盖。所有接口均位于 `services/api/src/index.ts`，数据访问由 `services/api/src/store.ts` 提供 MySQL/内存双实现，端到端用例在 `tests/services/api.test.ts`。 

## 1. 学生端

| 编号 | 功能 | 设计关键点 | 代码对应 | 状态 |
| --- | --- | --- | --- | --- |
| S-01 | 启动/登录 | 游客模式、班级邀请码登录 | `/api/auth/guest`、`/api/auth/class`（`index.ts` 第 52-111 行） | ✅ |
| S-02 | 首页/冒险地图 | 章节岛屿、关卡节点 | `/api/student/map`（`index.ts` 第 124-164 行） | ✅ |
| S-03 | 关卡准备页 | 胜利条件/可用积木/教学漫画 | `/api/student/levels/:id/prep`（`index.ts` 第 166-178 行） | ✅ |
| S-04 | 关卡主界面 | 场景/积木库/程序区/目标区 | `/api/student/levels/:id/run` + `LevelSimulator`（`index.ts` 第 180-199 行，`packages/engine/src/index.ts`） | ✅ |
| S-05 | 结算页 | 星级、奖励、最佳方案差距、CTA | `/api/student/levels/:id/complete`（`index.ts` 第 201-236 行） | ✅ |
| S-06 | 角色/装扮 | 换装、来源说明 | `/api/student/avatar` GET/PUT（`index.ts` 第 238-258 行） | ✅ |
| S-07 | 图鉴馆/成就 | 藏品、徽章、条件 | `/api/student/compendium/unlock`（`index.ts` 第 260-270 行） | ✅ |
| S-08 | 沙盒创作 | 创建/测试/发布、积木库 | `/api/student/sandbox*`（`index.ts` 第 282-326 行） | ✅ |
| S-09 | 作品库（班级） | 浏览/点赞/评论可见范围 | `/api/student/library*`（`index.ts` 第 328-344 行） | ✅ |
| S-10 | 设置 | 音量、低动效、语言、重置进度 | `/api/student/settings*`（`index.ts` 第 272-280 行） | ✅ |

## 2. 教师端

| 编号 | 功能 | 设计关键点 | 代码对应 | 状态 |
| --- | --- | --- | --- | --- |
| T-01 | 课程管理 | 创建课程→章节→关卡集 | `/api/teacher/courses*`、`/chapters`、`/levels`（`index.ts` 第 352-395 行） | ✅ |
| T-02 | 关卡编辑器 | ECET 场景/实体/事件-条件-动作 | `/api/teacher/levels/:id`（`index.ts` 第 397-407 行） | ✅ |
| T-03 | 班级与布置 | 添加学生、布置课程、设置提示上限 | `/api/teacher/classes*`（`index.ts` 第 409-439 行） | ✅ |
| T-04 | 进度与看板 | 热力图、榜单、用时统计、回放 | `/api/teacher/analytics*`（`index.ts` 第 441-471 行） | ✅ |
| T-05 | 作品审核 | UGC 审核与下架 | `/api/teacher/works*`（`index.ts` 第 473-487 行） | ✅ |

## 3. 家长端

| 编号 | 功能 | 设计关键点 | 代码对应 | 状态 |
| --- | --- | --- | --- | --- |
| P-01 | 孩子进度页 | 已学概念、星级、常见错误 | `/api/parent/children/:id/progress`（`index.ts` 第 509-513 行） | ✅ |
| P-02 | 周报 | 自动生成，可导出 PDF | `/api/parent/children/:id/weekly-report`（`index.ts` 第 501-507 行） | ✅ |

## 4. 管理员端

| 编号 | 功能 | 设计关键点 | 代码对应 | 状态 |
| --- | --- | --- | --- | --- |
| A-01 | 运营与风控 | 活跃度、异常监控 | `/api/admin/overview`（`index.ts` 第 517-527 行） | ✅ |
| A-02 | 素材管理 | 资产上传、版本管理 | `/api/admin/assets`（`index.ts` 第 529-538 行） | ✅ |
| A-03 | 账号管理 | 角色权限 | `/api/admin/users`（`index.ts` 第 540-548 行） | ✅ |
| A-04 | 数据导出 | 报表导出 | `/api/admin/exports/progress`（`index.ts` 第 550-556 行） | ✅ |

## 5. 服务端与数据

| 编号 | 功能 | 设计关键点 | 代码对应 | 状态 |
| --- | --- | --- | --- | --- |
| B-01 | API 层 | 鉴权、课程/关卡/遥测接口 | `services/api/src/index.ts` 全部 | ✅ |
| B-02 | 遥测与埋点 | Tick、Hint、步数上报 | `services/api/src/telemetry.ts` + `/api/telemetry`（`index.ts` 第 558-566 行） | ✅ |
| B-03 | 数据库存储 | MySQL JSON 持久化、初始化脚本 | `services/api/src/store.ts`、`docs/database_schema.sql`、`docs/mysql_init.sql` | ✅ |
| B-04 | 自动化测试 | 全量单元/集成测试 | `tests/services/api.test.ts` + `npm test` | ✅ |
| B-05 | 部署与配置 | 环境变量、CI/CD、容器化 | `docs/环境配置.md`（新）说明环境依赖 | ✅ |

## 6. 交互闭环验收项

| 编号 | AC 指标 | 代码对应 | 状态 |
| --- | --- | --- | --- |
| AC-L1-01 | 新手 ≤60s 完成首关 | `tests/services/api.test.ts` 学生首关流程 | ✅ |
| AC-L1-02 | 失败提示与错误匹配 | `/api/student/hints/:levelId` + `computeHint`（`index.ts` 第 346-350 行） | ✅ |
| AC-L1-03 | 通关推进与动机文案 | `/api/student/levels/:id/complete` 结果返回 + 地图刷新 | ✅ |
| AC-L1-04 | 通关解锁沙盒并召回 | `ensureSandboxUnlock`（`seed.ts` 第 155-182 行） + `/api/student/sandbox` | ✅ |
| AC-L2-01 | 遥测与概念热力图 | `TelemetryBuffer` + `/api/teacher/analytics/heatmap` | ✅ |
| AC-L2-02 | 关卡回放 | `/api/teacher/analytics/replays/:studentId/:levelId` | ✅ |
| AC-L2-03 | 卡关榜单下发复训关 | `/api/teacher/analytics/progress` + 课程布置接口 | ✅ |

## 7. 结论与建议

系统已具备学生-教师-家长-管理员四端闭环 API、MySQL 数据持久化与 Jest 集成测试。后续建议：

1. 补充正式前端界面与设计联调。
2. 将遥测与工作流事件落地到 MySQL 专用表或数据仓库。
3. 在 `docs/环境配置.md` 指引下完善容器化与 CI/CD。
4. 扩展自定义榜单与个性化推荐算法。
