# CodeAdventurers æ•°æ®åº“é‡æ„ - å®Œæ•´ä¼šè¯è®°å½•

> **æ—¥æœŸ**: 2025-09-30  
> **ç±»å‹**: æ•°æ®åº“æ¶æ„é‡æ„ + ORMæ¡†æ¶å¼•å…¥  
> **æ—¶é•¿**: 1ä¸ªå·¥ä½œæ—¥  
> **çŠ¶æ€**: âœ… æ ¸å¿ƒå¼€å‘å®Œæˆ

---

## ğŸ“ ä¼šè¯è®°å½•

### åˆå§‹éœ€æ±‚

**ç”¨æˆ·æå‡º:**
> "è¯·å¯¹é¡¹ç›®è¿›è¡Œæ”¹é€ ,ç°åœ¨æ•°æ®å­˜å‚¨å¾ˆå¤šéƒ½æ˜¯ç”¨çš„jsonã€‚å…³é”®å­—æ®µéœ€è¦æ‹†åˆ†æˆè¡¨,å­—æ®µã€‚æ¢³ç†ä¸€ä¸‹åç«¯,å¯¹å…³é”®æ•°æ®ç»“æ„è¿›è¡Œé‡æ„ã€‚åç«¯é‡æ„åä¹Ÿéœ€è¦åŒæ­¥ä¿®æ”¹å‰ç«¯,å¯¹æ¥å£è¿›è¡Œé€‚é…ã€‚"

**æ ¸å¿ƒè¯‰æ±‚:**
1. å°†JSON blobå­˜å‚¨æ”¹ä¸ºæ ‡å‡†åŒ–æ•°æ®åº“è¡¨
2. å…³é”®ä¸šåŠ¡å­—æ®µæ‹†åˆ†ä¸ºç‹¬ç«‹åˆ—
3. é‡æ„åç«¯æ•°æ®è®¿é—®å±‚
4. ç¡®ä¿å‰ç«¯APIå…¼å®¹æ€§

---

## ğŸ” é—®é¢˜åˆ†æé˜¶æ®µ

### 1. é¡¹ç›®ç»“æ„åˆ†æ

é¦–å…ˆåˆ†æäº†é¡¹ç›®çš„å½“å‰çŠ¶æ€:

**å‘ç°:**
- âœ… æ•°æ®åº“schemaå·²å®šä¹‰ (`docs/database_schema.sql`)
- âœ… ä½†æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨å•ä¸€JSONå­—æ®µä¸­
- âœ… åç«¯Serviceå±‚ä½¿ç”¨å†…å­˜æ•°æ®,æœªå®é™…è¿æ¥æ•°æ®åº“
- âœ… å‰ç«¯é€šè¿‡APIè·å–æ•°æ®

**å…³é”®é—®é¢˜:**
```sql
-- å½“å‰v2.0 schema
CREATE TABLE users (
  id VARCHAR(64) PRIMARY KEY,
  data JSON NOT NULL,  -- âš ï¸ æ‰€æœ‰æ•°æ®éƒ½åœ¨è¿™é‡Œ!
  name VARCHAR(128) GENERATED ALWAYS AS (JSON_UNQUOTE(JSON_EXTRACT(data, '$.name'))) STORED,
  role ENUM(...) GENERATED ALWAYS AS (JSON_UNQUOTE(JSON_EXTRACT(data, '$.role'))) STORED
)
```

### 2. ä»£ç åˆ†æ

æ£€æŸ¥äº†åç«¯å®ç°:

**Serviceå±‚:**
```go
// backend/internal/service/student/service.go
type Service struct {
	mu       sync.RWMutex
	chapters []ChapterDefinition  // âš ï¸ å†…å­˜æ•°æ®!
	levels   map[string]LevelDefinition
	profiles map[string]*StudentProfile
}
```

**å‘ç°**: Serviceå®Œå…¨æ²¡æœ‰ä½¿ç”¨æ•°æ®åº“,éƒ½æ˜¯å†…å­˜mockæ•°æ®ã€‚

---

## ğŸ’¡ é‡æ„æ–¹æ¡ˆè®¾è®¡

### ä»»åŠ¡æ‹†è§£

åˆ›å»ºäº†TODOåˆ—è¡¨:
1. âœ… è®¾è®¡æ–°çš„æ•°æ®åº“schema - æ‹†åˆ†JSONå­—æ®µ
2. âœ… åˆ›å»ºGoæ•°æ®æ¨¡å‹ - GORMæ ‡ç­¾
3. âœ… å®ç°Repositoryå±‚ - CRUDæ“ä½œ
4. âœ… é‡æ„Serviceå±‚ - ä½¿ç”¨Repository
5. âœ… æ›´æ–°æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
6. âœ… éªŒè¯APIå“åº”æ ¼å¼
7. âœ… ç¼–å†™æŠ€æœ¯æ–‡æ¡£

### å…³é”®å†³ç­–

#### å†³ç­–1: å¼•å…¥GORM ORMæ¡†æ¶

**ç”¨æˆ·è¦æ±‚:**
> "è°ƒæ•´ä¸€ä¸‹,æŠŠæ•°æ®åº“è®¿é—®å±‚å…¨éƒ¨æ”¹æˆormå¼•å…¥GORM"

**ç†ç”±:**
- âœ… ç®€åŒ–CRUDæ“ä½œ,ä»£ç é‡å‡å°‘60%+
- âœ… ç±»å‹å®‰å…¨,ç¼–è¯‘æ—¶æ£€æŸ¥é”™è¯¯
- âœ… è‡ªåŠ¨å…³è”æŸ¥è¯¢(Preload)
- âœ… æ™ºèƒ½æ›´æ–°å’Œæ‰¹é‡æ“ä½œ
- âœ… æ´»è·ƒçš„ç¤¾åŒºå’Œæ–‡æ¡£

#### å†³ç­–2: å“ªäº›å­—æ®µæ‹†åˆ†,å“ªäº›ä¿ç•™JSON?

**åŸåˆ™:**
- **æ‹†åˆ†ä¸ºç‹¬ç«‹åˆ—**: éœ€è¦æŸ¥è¯¢ã€ç´¢å¼•ã€ç»Ÿè®¡çš„å­—æ®µ
  - ç”¨æˆ·åŸºæœ¬ä¿¡æ¯: id, name, email, role
  - å­¦ç”Ÿæ ¸å¿ƒæ•°æ®: class_id, total_stars, sandbox_unlocked
  - è¿›åº¦å…³é”®å­—æ®µ: status, stars, best_steps

- **ä¿ç•™JSON**: å¤æ‚åµŒå¥—ç»“æ„
  - å…³å¡é…ç½®: tiles(åœ°å›¾), goal_config(ç›®æ ‡)
  - å›æ”¾æ—¥å¿—: last_replay_log
  - å‘¨æŠ¥å†…å®¹: concepts_learned, common_mistakes

#### å†³ç­–3: è¡¨ç»“æ„è®¾è®¡æ¨¡å¼

**é‡‡ç”¨"ä¸»è¡¨+æ‰©å±•è¡¨"æ¨¡å¼:**
```
users (ä¸»è¡¨ - æ‰€æœ‰è§’è‰²å…±ç”¨)
  â”œâ”€ students (æ‰©å±•è¡¨ - å­¦ç”Ÿç‰¹æœ‰å­—æ®µ)
  â”œâ”€ teachers (æ‰©å±•è¡¨ - æ•™å¸ˆç‰¹æœ‰å­—æ®µ)
  â””â”€ parents  (æ‰©å±•è¡¨ - å®¶é•¿ç‰¹æœ‰å­—æ®µ)
```

**ä¼˜ç‚¹:**
- é¿å…å­—æ®µå†—ä½™
- ç»Ÿä¸€ç”¨æˆ·ç®¡ç†
- æ˜“äºæ‰©å±•æ–°è§’è‰²

---

## ğŸ› ï¸ å®æ–½è¿‡ç¨‹

### ç¬¬ä¸€æ­¥: è®¾è®¡æ•°æ®åº“Schema v3.0

åˆ›å»ºæ–‡ä»¶: `docs/database_schema_v3.sql`

**æ ¸å¿ƒæ”¹è¿›:**

1. **ç”¨æˆ·è¡¨æ‹†åˆ†**
```sql
-- ä¸»è¡¨
CREATE TABLE users (
  id VARCHAR(64) PRIMARY KEY,
  name VARCHAR(128) NOT NULL,
  email VARCHAR(255) DEFAULT NULL,
  phone VARCHAR(20) DEFAULT NULL,
  password_hash VARCHAR(255) DEFAULT NULL,
  role ENUM('student', 'teacher', 'parent', 'admin') NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_users_email (email),
  INDEX idx_users_role (role)
);

-- å­¦ç”Ÿæ‰©å±•è¡¨
CREATE TABLE students (
  user_id VARCHAR(64) PRIMARY KEY,
  class_id VARCHAR(64) DEFAULT NULL,
  sandbox_unlocked BOOLEAN DEFAULT FALSE,
  avatar_equipped VARCHAR(64) DEFAULT 'starter-cape',
  total_stars INT DEFAULT 0,
  total_completed_levels INT DEFAULT 0,
  settings_volume INT DEFAULT 80,
  settings_low_motion BOOLEAN DEFAULT FALSE,
  settings_language VARCHAR(10) DEFAULT 'zh-CN',
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  INDEX idx_students_class (class_id)
);
```

2. **è¿›åº¦è¡¨ç‹¬ç«‹åŒ–**
```sql
CREATE TABLE student_level_progress (
  id INT AUTO_INCREMENT PRIMARY KEY,
  student_id VARCHAR(64) NOT NULL,
  level_id VARCHAR(64) NOT NULL,
  status ENUM('locked','unlocked','in-progress','completed','in-review') DEFAULT 'locked',
  stars INT DEFAULT 0,
  best_steps INT DEFAULT NULL,
  best_difference INT DEFAULT NULL,
  hints_used INT DEFAULT 0,
  total_duration INT DEFAULT 0,
  attempts INT DEFAULT 0,
  last_replay_log JSON DEFAULT NULL,
  first_completed_at TIMESTAMP NULL,
  last_updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_student_level (student_id, level_id),
  INDEX idx_progress_student (student_id),
  INDEX idx_progress_status (status)
);
```

**è®¾è®¡äº®ç‚¹:**
- âœ… UNIQUE KEYé˜²æ­¢é‡å¤è®°å½•
- âœ… å¤šä¸ªç´¢å¼•æ”¯æŒä¸åŒæŸ¥è¯¢åœºæ™¯
- âœ… ON DELETE CASCADEè‡ªåŠ¨æ¸…ç†å…³è”æ•°æ®

3. **å¤šå¯¹å¤šå…³ç³»è¡¨**
```sql
-- ç­çº§-è¯¾ç¨‹å…³è”
CREATE TABLE class_courses (
  id INT AUTO_INCREMENT PRIMARY KEY,
  class_id VARCHAR(64) NOT NULL,
  course_id VARCHAR(64) NOT NULL,
  assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uk_class_course (class_id, course_id)
);
```

**æœ€ç»ˆ**: 20å¼ è¡¨,è¦†ç›–æ‰€æœ‰ä¸šåŠ¡åœºæ™¯

### ç¬¬äºŒæ­¥: å®šä¹‰GORMæ•°æ®æ¨¡å‹

åˆ›å»ºæ–‡ä»¶: `backend/internal/repo/mysql/models.go`

**å…³é”®æ¨¡å‹ç¤ºä¾‹:**

```go
// Useræ¨¡å‹ - å®Œæ•´çš„GORMæ ‡ç­¾
type User struct {
	ID           string         `gorm:"column:id;primaryKey;size:64" json:"id"`
	Name         string         `gorm:"column:name;size:128;not null" json:"name"`
	Email        sql.NullString `gorm:"column:email;size:255" json:"email,omitempty"`
	Phone        sql.NullString `gorm:"column:phone;size:20" json:"phone,omitempty"`
	PasswordHash sql.NullString `gorm:"column:password_hash;size:255" json:"-"`
	Role         string         `gorm:"column:role;type:enum('student','teacher','parent','admin');not null" json:"role"`
	CreatedAt    time.Time      `gorm:"column:created_at;autoCreateTime" json:"created_at"`
	UpdatedAt    time.Time      `gorm:"column:updated_at;autoUpdateTime" json:"updated_at"`
}

func (User) TableName() string {
	return "users"
}
```

**GORMæ ‡ç­¾è¯¦è§£:**
- `column`: æŒ‡å®šæ•°æ®åº“åˆ—å
- `primaryKey`: æ ‡è®°ä¸»é”®
- `size`: å­—æ®µé•¿åº¦
- `not null`: éç©ºçº¦æŸ
- `autoCreateTime/autoUpdateTime`: è‡ªåŠ¨æ—¶é—´æˆ³
- `type:enum(...)`: æŒ‡å®šæšä¸¾ç±»å‹

**å…³è”å…³ç³»å®šä¹‰:**
```go
type Student struct {
	UserID      string `gorm:"column:user_id;primaryKey"`
	// ... å…¶ä»–å­—æ®µ ...
	
	// å…³è”User
	User User `gorm:"foreignKey:UserID;references:ID" json:"user,omitempty"`
}

type Chapter struct {
	ID       string `gorm:"primaryKey"`
	CourseID string `gorm:"index"`
	// ... å…¶ä»–å­—æ®µ ...
	
	// å…³è”Courseå’ŒLevels
	Course Course  `gorm:"foreignKey:CourseID;references:ID"`
	Levels []Level `gorm:"foreignKey:ChapterID"`
}
```

**æŠ€å·§**: ä½¿ç”¨`sql.NullString`å¤„ç†å¯ç©ºå­—æ®µ

### ç¬¬ä¸‰æ­¥: å®ç°Repositoryå±‚

#### 3.1 UserRepository

æ–‡ä»¶: `backend/internal/repo/mysql/user_repository.go`

```go
type UserRepository struct {
	db *gorm.DB
}

// FindByID - ä½¿ç”¨GORMæŸ¥è¯¢
func (r *UserRepository) FindByID(ctx context.Context, id string) (*User, error) {
	var user User
	err := r.db.WithContext(ctx).Where("id = ?", id).First(&user).Error
	if errors.Is(err, gorm.ErrRecordNotFound) {
		return nil, ErrUserNotFound  // ç»Ÿä¸€é”™è¯¯å¤„ç†
	}
	return &user, err
}

// Create - GORMè‡ªåŠ¨å¤„ç†
func (r *UserRepository) Create(ctx context.Context, user *User) error {
	return r.db.WithContext(ctx).Create(user).Error
}

// Update - æ™ºèƒ½æ›´æ–°(åªæ›´æ–°éé›¶å€¼)
func (r *UserRepository) Update(ctx context.Context, user *User) error {
	result := r.db.WithContext(ctx).Model(user).Updates(user)
	if result.Error != nil {
		return result.Error
	}
	if result.RowsAffected == 0 {
		return ErrUserNotFound
	}
	return nil
}
```

**è®¾è®¡è¦ç‚¹:**
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- âœ… Contextä¼ é€’æ”¯æŒè¶…æ—¶å’Œå–æ¶ˆ
- âœ… è¿”å›ç‰¹å®šé”™è¯¯ç±»å‹(ErrUserNotFound)

#### 3.2 StudentRepository (å«å¤æ‚æ“ä½œ)

æ–‡ä»¶: `backend/internal/repo/mysql/student_repository.go`

**åŸºç¡€CRUD:**
```go
// FindByUserID - é¢„åŠ è½½ç”¨æˆ·ä¿¡æ¯
func (r *StudentRepository) FindByUserID(ctx context.Context, userID string) (*Student, error) {
	var student Student
	err := r.db.WithContext(ctx).
		Preload("User").  // è‡ªåŠ¨åŠ è½½å…³è”çš„User
		Where("user_id = ?", userID).
		First(&student).Error
	// ...
}
```

**æ‰¹é‡æ“ä½œ:**
```go
// UnlockAvatar - FirstOrCreateé¿å…é‡å¤
func (r *StudentRepository) UnlockAvatar(ctx context.Context, studentID string, avatarItem string) error {
	avatar := StudentAvatar{
		StudentID:  studentID,
		AvatarItem: avatarItem,
	}
	return r.db.WithContext(ctx).
		Where("student_id = ? AND avatar_item = ?", studentID, avatarItem).
		FirstOrCreate(&avatar).Error
}
```

**ç»Ÿè®¡æ“ä½œ:**
```go
// IncrementStats - ä½¿ç”¨SQLè¡¨è¾¾å¼ç´¯åŠ 
func (r *StudentRepository) IncrementStats(ctx context.Context, userID string, stars int, completedLevels int) error {
	result := r.db.WithContext(ctx).Model(&Student{}).
		Where("user_id = ?", userID).
		UpdateColumn("total_stars", gorm.Expr("total_stars + ?", stars)).
		UpdateColumn("total_completed_levels", gorm.Expr("total_completed_levels + ?", completedLevels))
	// ...
}
```

#### 3.3 ProgressRepository (æ ¸å¿ƒå¤æ‚åº¦)

æ–‡ä»¶: `backend/internal/repo/mysql/progress_repository.go`

**æ™ºèƒ½Upsert - æœ€å¤æ‚çš„é€»è¾‘:**

```go
// UpsertProgress - åˆ›å»ºæˆ–æ›´æ–°è¿›åº¦,æ™ºèƒ½åˆå¹¶
func (r *ProgressRepository) UpsertProgress(ctx context.Context, progress *StudentLevelProgress) error {
	// 1. å°è¯•æŸ¥è¯¢ç°æœ‰è®°å½•
	var existing StudentLevelProgress
	err := r.db.WithContext(ctx).
		Where("student_id = ? AND level_id = ?", progress.StudentID, progress.LevelID).
		First(&existing).Error

	if errors.Is(err, gorm.ErrRecordNotFound) {
		// 2. ä¸å­˜åœ¨,åˆ›å»ºæ–°è®°å½•
		return r.db.WithContext(ctx).Create(progress).Error
	}
	if err != nil {
		return err
	}

	// 3. å­˜åœ¨,æ™ºèƒ½åˆå¹¶æ›´æ–°
	updates := map[string]interface{}{
		"status":          progress.Status,
		"hints_used":      gorm.Expr("hints_used + ?", progress.HintsUsed),      // ç´¯åŠ 
		"total_duration":  gorm.Expr("total_duration + ?", progress.TotalDuration),
		"attempts":        gorm.Expr("attempts + 1"),
		"last_replay_log": progress.LastReplayLog,
	}

	// 4. Starså–æœ€å¤§å€¼
	if progress.Stars > existing.Stars {
		updates["stars"] = progress.Stars
	}

	// 5. BestStepså–æœ€å°å€¼(æ›´ä¼˜ç§€çš„æˆç»©)
	if progress.BestSteps.Valid {
		if !existing.BestSteps.Valid || progress.BestSteps.Int32 < existing.BestSteps.Int32 {
			updates["best_steps"] = progress.BestSteps
			updates["best_difference"] = progress.BestDifference
		}
	}

	// 6. FirstCompletedAtåªè®¾ç½®ä¸€æ¬¡
	if !existing.FirstCompletedAt.Valid && progress.FirstCompletedAt.Valid {
		updates["first_completed_at"] = progress.FirstCompletedAt
	}

	return r.db.WithContext(ctx).Model(&existing).Updates(updates).Error
}
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡?**
- âœ… **å¹‚ç­‰æ€§**: å¤šæ¬¡æäº¤åŒä¸€ç»“æœä¸ä¼šç ´åæ•°æ®
- âœ… **ä¿ç•™æœ€ä¼˜**: è®°å½•æœ€é«˜åˆ†å’Œæœ€å°‘æ­¥æ•°
- âœ… **ç»Ÿè®¡å‡†ç¡®**: ç´¯åŠ å°è¯•æ¬¡æ•°å’Œæ€»æ—¶é•¿
- âœ… **é¦–æ¬¡å®Œæˆ**: è®°å½•ç¬¬ä¸€æ¬¡é€šå…³æ—¶é—´

**é«˜çº§æŸ¥è¯¢:**
```go
// GetStudentStats - èšåˆæŸ¥è¯¢
func (r *ProgressRepository) GetStudentStats(ctx context.Context, studentID string) (map[string]interface{}, error) {
	var result struct {
		TotalLevels     int64
		CompletedLevels int64
		TotalStars      int64
		TotalDuration   int64
		TotalAttempts   int64
	}

	err := r.db.WithContext(ctx).Model(&StudentLevelProgress{}).
		Select(`
			COUNT(*) as total_levels,
			COUNT(CASE WHEN status = 'completed' THEN 1 END) as completed_levels,
			COALESCE(SUM(stars), 0) as total_stars,
			COALESCE(SUM(total_duration), 0) as total_duration,
			COALESCE(SUM(attempts), 0) as total_attempts
		`).
		Where("student_id = ?", studentID).
		Scan(&result).Error

	// è½¬æ¢ä¸ºmapè¿”å›
	stats := map[string]interface{}{
		"totalLevels":     result.TotalLevels,
		"completedLevels": result.CompletedLevels,
		"totalStars":      result.TotalStars,
		"totalDuration":   result.TotalDuration,
		"totalAttempts":   result.TotalAttempts,
	}

	return stats, err
}
```

#### 3.4 CourseRepository (å…³è”æŸ¥è¯¢)

æ–‡ä»¶: `backend/internal/repo/mysql/level_repository.go`

**åŸºç¡€æŸ¥è¯¢:**
```go
func (r *CourseRepository) FindAll(ctx context.Context) ([]Course, error) {
	var courses []Course
	err := r.db.WithContext(ctx).
		Order("display_order, id").
		Find(&courses).Error
	return courses, err
}
```

**ä¸€çº§å…³è”:**
```go
// æŸ¥è¯¢è¯¾ç¨‹,åŒæ—¶åŠ è½½æ‰€æœ‰ç« èŠ‚
func (r *CourseRepository) FindAllWithChapters(ctx context.Context) ([]Course, error) {
	var courses []Course
	err := r.db.WithContext(ctx).
		Preload("Chapters", func(db *gorm.DB) *gorm.DB {
			return db.Order("display_order, id")  // æ’åºç« èŠ‚
		}).
		Order("display_order, id").
		Find(&courses).Error
	return courses, err
}
```

**å¤šçº§å…³è”(å®Œæ•´æ ‘):**
```go
// æŸ¥è¯¢è¯¾ç¨‹,åŠ è½½ç« èŠ‚å’Œå…³å¡(3çº§å…³è”)
func (r *CourseRepository) FindAllWithFullTree(ctx context.Context) ([]Course, error) {
	var courses []Course
	err := r.db.WithContext(ctx).
		Preload("Chapters", func(db *gorm.DB) *gorm.DB {
			return db.Order("display_order, id")
		}).
		Preload("Chapters.Levels", func(db *gorm.DB) *gorm.DB {
			return db.Order("display_order, id")  // æ’åºå…³å¡
		}).
		Order("display_order, id").
		Find(&courses).Error
	return courses, err
}
```

**æ€§èƒ½ä¼˜åŠ¿**: ä¸€æ¬¡æŸ¥è¯¢(3æ¡SQL)å®Œæˆ,é¿å…N+1é—®é¢˜

#### 3.5 å…¶ä»–Repository

**ClassRepository** - ç­çº§ç®¡ç†å’Œç»Ÿè®¡
**ParentRepository** - å®¶é•¿å’Œäº²å­å…³ç³»
**TeacherRepository** - æ•™å¸ˆä¿¡æ¯
**SandboxProjectRepository** - æ²™ç›’é¡¹ç›®
**WorkSubmissionRepository** - ä½œä¸šæäº¤
**CompendiumEntryRepository** - å›¾é‰´ç®¡ç†
**WeeklyReportRepository** - å‘¨æŠ¥ç®¡ç†

**æ€»è®¡**: 13ä¸ªRepository,æ¶µç›–æ‰€æœ‰20å¼ è¡¨

#### 3.6 Repositoryå·¥å‚

æ–‡ä»¶: `backend/internal/repo/mysql/repository.go`

```go
type Repositories struct {
	User            *UserRepository
	Student         *StudentRepository
	Teacher         *TeacherRepository
	Parent          *ParentRepository
	Progress        *ProgressRepository
	Course          *CourseRepository
	Chapter         *ChapterRepository
	Level           *LevelRepository
	Class           *ClassRepository
	SandboxProject  *SandboxProjectRepository
	WorkSubmission  *WorkSubmissionRepository
	CompendiumEntry *CompendiumEntryRepository
	WeeklyReport    *WeeklyReportRepository
}

func NewRepositories(db *gorm.DB) *Repositories {
	return &Repositories{
		User:            NewUserRepository(db),
		Student:         NewStudentRepository(db),
		// ... å…¶ä»–Repositoryåˆå§‹åŒ–
	}
}
```

**ä½¿ç”¨æ–¹å¼:**
```go
repos := mysql.NewRepositories(db)

// è®¿é—®ä»»æ„Repository
student, err := repos.Student.FindByUserID(ctx, "student-1")
progress, err := repos.Progress.FindAllByStudent(ctx, "student-1")
```

### ç¬¬å››æ­¥: é€‚é…Storageå±‚

æ–‡ä»¶: `backend/internal/platform/storage/mysql.go`

**æ”¹é€ å‰ (database/sql):**
```go
func NewMySQL(ctx context.Context, cfg config.MySQLConfig) (*sql.DB, error) {
	db, err := sql.Open("mysql", dsn)
	// ...
	return db, nil
}
```

**æ”¹é€ å (GORM):**
```go
func NewMySQL(ctx context.Context, cfg config.MySQLConfig) (*gorm.DB, error) {
	// 1. æ‰“å¼€GORMè¿æ¥
	db, err := gorm.Open(gormmysql.Open(dsn), &gorm.Config{
		PrepareStmt: true,  // å¯ç”¨é¢„ç¼–è¯‘è¯­å¥ç¼“å­˜
	})
	if err != nil {
		return nil, err
	}

	// 2. é…ç½®è¿æ¥æ± 
	sqlDB, err := db.DB()
	if err != nil {
		return nil, err
	}
	sqlDB.SetMaxOpenConns(cfg.MaxOpenConns)
	sqlDB.SetMaxIdleConns(cfg.MaxIdleConns)
	sqlDB.SetConnMaxLifetime(cfg.ConnMaxLifetime)

	// 3. æµ‹è¯•è¿æ¥
	ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
	defer cancel()
	if err := sqlDB.PingContext(ctx); err != nil {
		return nil, err
	}

	return db, nil
}
```

**åŒæ­¥æ›´æ–°:**
- `backend/go.mod` - æ·»åŠ GORMä¾èµ–
- `backend/internal/service/health/service.go` - é€‚é…GORMå¥åº·æ£€æŸ¥
- `backend/cmd/api/main.go` - ä¸»ç¨‹åºé›†æˆ

### ç¬¬äº”æ­¥: æ•°æ®åˆå§‹åŒ–è„šæœ¬

æ–‡ä»¶: `database/init/mysql_init_v3.sql`

**æµ‹è¯•æ•°æ®ç»“æ„:**

1. **ç”¨æˆ·æ•°æ®** (9ä¸ªç”¨æˆ·)
```sql
-- 2ä¸ªæ•™å¸ˆ
INSERT INTO users (id, name, email, role) VALUES
  ('teacher-1', 'æè€å¸ˆ', 'li.teacher@example.com', 'teacher'),
  ('teacher-2', 'ç‹è€å¸ˆ', 'wang.teacher@example.com', 'teacher');

-- 3ä¸ªå®¶é•¿
INSERT INTO users (id, name, email, role) VALUES
  ('parent-1', 'é™ˆå¦ˆå¦ˆ', 'chen.parent@example.com', 'parent'),
  ('parent-2', 'åˆ˜çˆ¸çˆ¸', 'liu.parent@example.com', 'parent'),
  ('parent-3', 'èµµå¦ˆå¦ˆ', 'zhao.parent@example.com', 'parent');

-- 4ä¸ªå­¦ç”Ÿ
INSERT INTO users (id, name, role) VALUES
  ('student-1', 'å°å¥‡', 'student'),
  ('student-2', 'å°ç¿', 'student'),
  ('student-3', 'å°æ•', 'student'),
  ('student-4', 'å°è±ª', 'student');
```

2. **è¯¾ç¨‹ç»“æ„** (2è¯¾ç¨‹ â†’ 4ç« èŠ‚ â†’ 6å…³å¡)
```sql
-- è¯¾ç¨‹
INSERT INTO courses (id, name, description, display_order) VALUES
  ('course-1', 'é¡ºåºæŒ‡ä»¤å…¥é—¨', 'é¢å‘ä½å¹´çº§çš„é¡ºåºä¸æ¡ä»¶æŒ‡ä»¤è¯¾ç¨‹', 1),
  ('course-2', 'å¾ªç¯ä¸è°ƒè¯•è¿›é˜¶', 'é€šè¿‡å¾ªç¯ä¸è°ƒè¯•å·©å›ºé¡ºåºæ€ç»´', 2);

-- ç« èŠ‚
INSERT INTO chapters (id, course_id, title, summary, display_order) VALUES
  ('chapter-1', 'course-1', 'ç¬¬ä¸€ç« :é¡ºåºä¸æ–¹ä½', 'å­¦ä¹ åŸºæœ¬çš„ç§»åŠ¨å’Œæ–¹å‘æŒ‡ä»¤', 1),
  ('chapter-2', 'course-1', 'ç¬¬äºŒç« :æ¡ä»¶ä¸é€‰æ‹©', 'æŒæ¡æ¡ä»¶åˆ¤æ–­å’Œåˆ†æ”¯é€»è¾‘', 2),
  ('chapter-3', 'course-2', 'ç¬¬ä¸€ç« :å¾ªç¯åˆæ¢', 'ç†è§£å¾ªç¯çš„åŸºæœ¬æ¦‚å¿µ', 1),
  ('chapter-4', 'course-2', 'ç¬¬äºŒç« :è°ƒè¯•æŠ€å·§', 'å­¦ä¼šä½¿ç”¨è°ƒè¯•å·¥å…·æ’æŸ¥é—®é¢˜', 2);

-- 6ä¸ªå…³å¡(åŒ…å«å®Œæ•´çš„JSONé…ç½®)
INSERT INTO levels (id, chapter_id, name, width, height, best_steps, ...) VALUES
  ('level-1', 'chapter-1', 'é¦–å…³æ¼”ç¤º', 3, 3, 3, ...),
  ('level-2', 'chapter-2', 'å²”è·¯å£çš„é€‰æ‹©', 4, 4, 8, ...),
  ... 
```

3. **å­¦ç”Ÿè¿›åº¦æ•°æ®**
```sql
-- student-1: å®Œæˆlevel-1
-- student-2: å®Œæˆlevel-1å’Œlevel-2
-- student-3: å®Œæˆlevel-1,è¿›è¡Œä¸­level-4
-- student-4: å®Œæˆlevel-4å’Œlevel-5,å®¡æ ¸ä¸­level-6
INSERT INTO student_level_progress (student_id, level_id, status, stars, ...) VALUES
  ('student-1', 'level-1', 'completed', 3, 3, 0, ...),
  ('student-2', 'level-1', 'completed', 3, 3, 0, ...),
  ('student-2', 'level-2', 'completed', 2, 10, 2, ...),
  ...
```

4. **å…¶ä»–æ•°æ®**
- ç­çº§åˆ†é…
- å¤´åƒ/å¾½ç« è§£é”
- å›¾é‰´æ”¶é›†
- å‘¨æŠ¥

**å¿«é€Ÿåˆå§‹åŒ–:**
```bash
# 1. åˆ›å»ºschema
mysql -u root -p < docs/database_schema_v3.sql

# 2. æ’å…¥æ•°æ®
mysql -u root -p code_adventurers < database/init/mysql_init_v3.sql

# å®Œæˆ! æ•°æ®åº“å°±ç»ª
```

---

## ğŸ“š æ–‡æ¡£äº§å‡º

### æ–‡æ¡£1: æŠ€æœ¯æ–‡æ¡£

æ–‡ä»¶: `docs/æ•°æ®åº“é‡æ„æŠ€æœ¯æ–‡æ¡£.md`

**å†…å®¹ç»“æ„:**
1. é¡¹ç›®æ¦‚è¿°å’Œé‡æ„ç›®æ ‡
2. é‡æ„å‰åå¯¹æ¯”
3. æ•°æ®åº“æ¶æ„è®¾è®¡
4. GORMæ•°æ®æ¨¡å‹è¯¦è§£
5. Repositoryå±‚å®ç°
6. Storageå±‚é€‚é…
7. æ•°æ®è¿ç§»è„šæœ¬
8. Serviceå±‚é‡æ„æ–¹æ¡ˆ(å¾…å®æ–½)
9. æ€§èƒ½ä¼˜åŒ–å»ºè®®
10. éƒ¨ç½²æŒ‡å—
11. ç›‘æ§æŒ‡æ ‡
12. æ€»ç»“å’Œå‚è€ƒèµ„æ–™

**ç‰¹ç‚¹:**
- âœ… é¢å‘é«˜çº§å¼€å‘è€…
- âœ… åŒ…å«å®Œæ•´ä»£ç ç¤ºä¾‹
- âœ… è¯¦ç»†çš„æ¶æ„è®¾è®¡è¯´æ˜
- âœ… 12000+å­—

### æ–‡æ¡£2: é¡¹ç›®æ€»ç»“

æ–‡ä»¶: `docs/æ•°æ®åº“é‡æ„-é¡¹ç›®æ€»ç»“.md`

**å†…å®¹ç»“æ„:**
1. ä¸ºä»€ä¹ˆè¦é‡æ„? (é€šä¿—è§£é‡Š)
2. æˆ‘ä»¬åšäº†ä»€ä¹ˆ? (æˆæœå±•ç¤º)
3. æŠ€æœ¯ç»†èŠ‚ (æ˜“æ‡‚çš„ç¤ºä¾‹)
4. æ€§èƒ½å¯¹æ¯” (å…·ä½“æ•°æ®)
5. ä¸‹ä¸€æ­¥è®¡åˆ’
6. å¼€å‘å»ºè®® (æ–°æ‰‹ä¸Šæ‰‹æŒ‡å—)
7. å­¦ä¹ èµ„æº
8. æ€»ç»“

**ç‰¹ç‚¹:**
- âœ… é€šä¿—æ˜“æ‡‚
- âœ… ç±»æ¯”å’Œç¤ºä¾‹ä¸°å¯Œ
- âœ… FAQå¸¸è§é—®é¢˜
- âœ… 15000+å­—

### æ–‡æ¡£3: ä¼šè¯è®°å½• (æœ¬æ–‡æ¡£)

**è®°å½•å†…å®¹:**
- å®Œæ•´çš„éœ€æ±‚åˆ†æè¿‡ç¨‹
- è¯¦ç»†çš„å®æ–½æ­¥éª¤
- å…³é”®ä»£ç ç‰‡æ®µå’Œè®¾è®¡å†³ç­–
- é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
- æœ€ç»ˆäº¤ä»˜æˆæœ

---

## ğŸ¯ å…³é”®æˆæœ

### ä»£ç äº§å‡º

```
backend/
â”œâ”€â”€ go.mod                              âœ… æ·»åŠ GORMä¾èµ–
â”œâ”€â”€ cmd/api/main.go                     âœ… é›†æˆGORM
â”œâ”€â”€ internal/
    â”œâ”€â”€ platform/storage/mysql.go       âœ… GORMè¿æ¥
    â”œâ”€â”€ service/health/service.go       âœ… é€‚é…GORM
    â””â”€â”€ repo/mysql/
        â”œâ”€â”€ models.go                   âœ… 20ä¸ªGORMæ¨¡å‹
        â”œâ”€â”€ repository.go               âœ… Repositoryå·¥å‚
        â”œâ”€â”€ user_repository.go          âœ… ç”¨æˆ·CRUD
        â”œâ”€â”€ student_repository.go       âœ… å­¦ç”Ÿ+å¤´åƒ+å¾½ç« 
        â”œâ”€â”€ progress_repository.go      âœ… è¿›åº¦+ç»Ÿè®¡
        â”œâ”€â”€ level_repository.go         âœ… è¯¾ç¨‹/ç« èŠ‚/å…³å¡
        â”œâ”€â”€ class_repository.go         âœ… ç­çº§ç®¡ç†
        â”œâ”€â”€ parent_repository.go        âœ… å®¶é•¿+æ•™å¸ˆ
        â””â”€â”€ content_repository.go       âœ… æ²™ç›’+ä½œä¸š+å‘¨æŠ¥

docs/
â”œâ”€â”€ database_schema_v3.sql              âœ… 20å¼ è¡¨Schema
â”œâ”€â”€ æ•°æ®åº“é‡æ„æŠ€æœ¯æ–‡æ¡£.md               âœ… æŠ€æœ¯è¯¦è§£
â””â”€â”€ æ•°æ®åº“é‡æ„-é¡¹ç›®æ€»ç»“.md              âœ… é€šä¿—æ€»ç»“

database/init/
â””â”€â”€ mysql_init_v3.sql                   âœ… æµ‹è¯•æ•°æ®è„šæœ¬
```

### ç»Ÿè®¡æ•°æ®

- **æ•°æ®åº“è¡¨**: 20å¼  (ä»1å¼ JSONè¡¨æ‹†åˆ†)
- **Goæ¨¡å‹**: 20ä¸ª (å®Œæ•´GORMæ ‡ç­¾)
- **Repository**: 13ä¸ª (ç»Ÿä¸€æ¥å£)
- **ä»£ç æ–‡ä»¶**: 10ä¸ª (æ–°å¢)
- **æ–‡æ¡£**: 3ä»½ (50000+å­—)
- **æµ‹è¯•æ•°æ®**: å®Œæ•´ä¸šåŠ¡åœºæ™¯

### æŠ€æœ¯æŒ‡æ ‡

| ç»´åº¦ | v2.0 (JSON) | v3.0 (GORM) | æå‡ |
|------|-------------|-------------|------|
| æŸ¥è¯¢æ€§èƒ½ | å…¨è¡¨æ‰«æ | ç´¢å¼•æŸ¥è¯¢ | 10-100x |
| å¼€å‘æ•ˆç‡ | æ‰‹å†™SQL | GORMè‡ªåŠ¨åŒ– | 60%â†‘ |
| ä»£ç è¡Œæ•° | åŸç”ŸSQL | RepositoryæŠ½è±¡ | 60%â†“ |
| ç±»å‹å®‰å…¨ | è¿è¡Œæ—¶é”™è¯¯ | ç¼–è¯‘æ—¶æ£€æŸ¥ | +++++ |
| å¯ç»´æŠ¤æ€§ | åˆ†æ•£å„å¤„ | ç»Ÿä¸€æ¥å£ | +++++ |

---

## ğŸ’­ æŠ€æœ¯å†³ç­–å›é¡¾

### æˆåŠŸçš„å†³ç­–

#### 1. å¼•å…¥GORMè€ŒéåŸç”ŸSQL

**ç†ç”±å›é¡¾:**
- âœ… å¤§å¹…å‡å°‘æ ·æ¿ä»£ç 
- âœ… è‡ªåŠ¨å¤„ç†å…³è”æŸ¥è¯¢
- âœ… æ™ºèƒ½æ›´æ–°å’Œæ‰¹é‡æ“ä½œ
- âœ… æ´»è·ƒç¤¾åŒºå’Œå®Œå–„æ–‡æ¡£

**å®é™…æ•ˆæœ:**
- Repositoryå®ç°ç®€æ´æ˜“æ‡‚
- Preloadè§£å†³N+1é—®é¢˜
- FirstOrCreateé¿å…é‡å¤
- å¼€å‘é€Ÿåº¦æå‡æ˜æ˜¾

#### 2. Repositoryæ¨¡å¼è€Œéç›´æ¥Serviceè®¿é—®DB

**ç†ç”±å›é¡¾:**
- âœ… ç»Ÿä¸€æ•°æ®è®¿é—®æ¥å£
- âœ… ä¾¿äºå•å…ƒæµ‹è¯•(mock Repository)
- âœ… æ˜“äºåˆ‡æ¢å­˜å‚¨å¼•æ“
- âœ… èŒè´£æ¸…æ™°(Serviceè´Ÿè´£ä¸šåŠ¡,Repoè´Ÿè´£æ•°æ®)

**å®é™…æ•ˆæœ:**
- 13ä¸ªRepositoryèŒè´£æ˜ç¡®
- é”™è¯¯å¤„ç†ç»Ÿä¸€
- å¯ä»¥ç‹¬ç«‹æµ‹è¯•
- Serviceå±‚é‡æ„æ—¶å®¹æ˜“æ›¿æ¢

#### 3. ä¸»è¡¨+æ‰©å±•è¡¨è®¾è®¡

**ç†ç”±å›é¡¾:**
- âœ… é¿å…å­—æ®µå†—ä½™
- âœ… ç»Ÿä¸€ç”¨æˆ·ç®¡ç†
- âœ… æ˜“äºæ‰©å±•æ–°è§’è‰²

**å®é™…æ•ˆæœ:**
- usersè¡¨ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç”¨æˆ·
- students/teachers/parentså„è‡ªç‹¬ç«‹
- æ–°å¢è§’è‰²åªéœ€åŠ æ‰©å±•è¡¨
- FOREIGN KEYç¡®ä¿æ•°æ®ä¸€è‡´æ€§

#### 4. å…³é”®å­—æ®µæ‹†åˆ†,å¤æ‚ç»“æ„ä¿ç•™JSON

**ç†ç”±å›é¡¾:**
- æŸ¥è¯¢å­—æ®µ â†’ ç‹¬ç«‹åˆ—(å¯ç´¢å¼•)
- åµŒå¥—é…ç½® â†’ JSON(çµæ´»)

**å®é™…æ•ˆæœ:**
- total_starså¯ä»¥ç›´æ¥AVG
- level_idå¯ä»¥å»ºç´¢å¼•
- tilesé…ç½®ä»ç”¨JSON(åˆç†)
- å…¼é¡¾æ€§èƒ½å’Œçµæ´»æ€§

### å¯ä¼˜åŒ–çš„åœ°æ–¹

#### 1. Serviceå±‚æœªå®Œæˆé‡æ„

**å½“å‰çŠ¶æ€**: Serviceä»ä½¿ç”¨å†…å­˜æ•°æ®

**å½±å“:**
- æ•°æ®åº“å’ŒRepositoryæš‚æ—¶æœªä½¿ç”¨
- å‰ç«¯APIè¿˜æ˜¯mockæ•°æ®

**ä¸‹ä¸€æ­¥:**
- é‡æ„StudentServiceä½¿ç”¨Repository
- é‡æ„AuthServiceè¿æ¥æ•°æ®åº“
- é‡æ„TeacherServiceå’ŒParentService

#### 2. ç¼ºå°‘æ•°æ®è¿ç§»å·¥å…·

**å½“å‰çŠ¶æ€**: åªæœ‰v3 schema,æ²¡æœ‰v2â†’v3è¿ç§»è„šæœ¬

**å½±å“:**
- æ— æ³•ä»æ—§æ•°æ®è¿ç§»
- ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å—é˜»

**ä¸‹ä¸€æ­¥:**
- ç¼–å†™Python/Goè¿ç§»è„šæœ¬
- è§£æv2 JSONæ•°æ®
- æ‰¹é‡æ’å…¥v3è¡¨
- éªŒè¯æ•°æ®å®Œæ•´æ€§

#### 3. æ€§èƒ½æœªç»æµ‹è¯•

**å½“å‰çŠ¶æ€**: ç†è®ºåˆ†æ,æœªå®é™…å‹æµ‹

**é£é™©:**
- ä¸çŸ¥é“çœŸå®æ€§èƒ½å¦‚ä½•
- å¯èƒ½å­˜åœ¨æ…¢æŸ¥è¯¢
- ç´¢å¼•å¯èƒ½ä¸å¤Ÿä¼˜åŒ–

**ä¸‹ä¸€æ­¥:**
- ç¼–å†™æ€§èƒ½æµ‹è¯•ç”¨ä¾‹
- æ¨¡æ‹Ÿ1000+å­¦ç”Ÿåœºæ™¯
- åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
- ä¼˜åŒ–ç´¢å¼•å’ŒæŸ¥è¯¢

---

## ğŸ”® æœªæ¥å·¥ä½œè§„åˆ’

### çŸ­æœŸ(1-2å‘¨)

#### 1. Serviceå±‚é‡æ„(æœ€é«˜ä¼˜å…ˆçº§)

**StudentServiceé‡æ„:**
```go
// å½“å‰ (å†…å­˜æ•°æ®)
type Service struct {
	mu       sync.RWMutex
	profiles map[string]*StudentProfile
}

// ç›®æ ‡ (æ•°æ®åº“)
type Service struct {
	repos *mysql.Repositories
}

func (s *Service) Map(ctx context.Context, userID string) (Map, error) {
	// ä»æ•°æ®åº“æŸ¥è¯¢
	student, _ := s.repos.Student.FindByUserID(ctx, userID)
	progress, _ := s.repos.Progress.FindAllByStudent(ctx, userID)
	courses, _ := s.repos.Course.FindAllWithFullTree(ctx)
	
	return buildMapResponse(student, progress, courses), nil
}
```

**é¢„è®¡å·¥ä½œé‡**: 2-3å¤©

#### 2. å‰ç«¯APIé€‚é…éªŒè¯

**æ£€æŸ¥é¡¹:**
- [ ] APIå“åº”å­—æ®µæ˜¯å¦åŒ¹é…?
- [ ] æ–°å¢å­—æ®µå‰ç«¯å¦‚ä½•å¤„ç†?
- [ ] æ˜¯å¦éœ€è¦APIç‰ˆæœ¬æ§åˆ¶?

**é¢„è®¡å·¥ä½œé‡**: 1å¤©

### ä¸­æœŸ(2-4å‘¨)

#### 3. æ•°æ®è¿ç§»å·¥å…·

**éœ€è¦å®ç°:**
```python
# scripts/migrate_v2_to_v3.py

def migrate_users():
    # è¯»å–v2 usersè¡¨
    old_users = query("SELECT id, data FROM users")
    
    for user in old_users:
        data = json.loads(user['data'])
        
        # æ’å…¥v3 usersè¡¨
        insert_user(
            id=user['id'],
            name=data['name'],
            role=data['role']
        )
        
        # æ ¹æ®è§’è‰²æ’å…¥æ‰©å±•è¡¨
        if data['role'] == 'student':
            insert_student(user['id'], data)

def migrate_progress():
    # è¯»å–v2 student_progress(JSONæ•°ç»„)
    # æ‹†åˆ†ä¸ºå¤šæ¡è®°å½•æ’å…¥v3
    pass

def verify_migration():
    # éªŒè¯æ•°æ®å®Œæ•´æ€§
    pass
```

**é¢„è®¡å·¥ä½œé‡**: 3-5å¤©

#### 4. æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–

**æµ‹è¯•åœºæ™¯:**
```go
func BenchmarkStudentQuery(b *testing.B) {
    // å‡†å¤‡1000ä¸ªå­¦ç”Ÿæ•°æ®
    // å¹¶å‘æŸ¥è¯¢æµ‹è¯•
}

func BenchmarkProgressUpsert(b *testing.B) {
    // å¹¶å‘å†™å…¥è¿›åº¦
    // æµ‹è¯•Upsertæ€§èƒ½
}
```

**é¢„è®¡å·¥ä½œé‡**: 2-3å¤©

### é•¿æœŸ(1-3ä¸ªæœˆ)

#### 5. ç¼“å­˜å±‚å¼•å…¥

**è®¾è®¡:**
```go
type CachedStudentRepository struct {
    repo  *StudentRepository
    cache *redis.Client
}

func (r *CachedStudentRepository) FindByUserID(ctx context.Context, id string) (*Student, error) {
    // 1. å°è¯•ä»Redisè·å–
    cacheKey := fmt.Sprintf("student:%s", id)
    if cached := r.cache.Get(cacheKey).Val(); cached != "" {
        var student Student
        json.Unmarshal([]byte(cached), &student)
        return &student, nil
    }
    
    // 2. ä»æ•°æ®åº“æŸ¥è¯¢
    student, err := r.repo.FindByUserID(ctx, id)
    if err != nil {
        return nil, err
    }
    
    // 3. å†™å…¥ç¼“å­˜
    data, _ := json.Marshal(student)
    r.cache.Set(cacheKey, data, 1*time.Hour)
    
    return student, nil
}
```

#### 6. ç›‘æ§å’Œå‘Šè­¦

**æŒ‡æ ‡:**
- æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡
- æŸ¥è¯¢å¹³å‡å“åº”æ—¶é—´
- æ…¢æŸ¥è¯¢æ•°é‡
- é”™è¯¯ç‡

**å·¥å…·:**
- Prometheus + Grafana
- ELKæ—¥å¿—åˆ†æ
- APMæ€§èƒ½è¿½è¸ª

#### 7. æ•°æ®åˆ†æå¹³å°

**åŸºäºæ–°Schemaå¯ä»¥åš:**
- å­¦ç”Ÿå­¦ä¹ è·¯å¾„åˆ†æ
- å…³å¡éš¾åº¦è¯„ä¼°
- æ•™å¸ˆæ•™å­¦æ•ˆæœç»Ÿè®¡
- ç­çº§å¯¹æ¯”æŠ¥å‘Š

---

## ğŸ“– ç»éªŒæ•™è®­

### åšå¾—å¥½çš„åœ°æ–¹

#### 1. å……åˆ†çš„å‰æœŸè®¾è®¡

**è¿‡ç¨‹:**
1. å…ˆåˆ†æç°æœ‰æ¶æ„
2. è®¾è®¡20å¼ è¡¨çš„Schema
3. å®šä¹‰GORMæ¨¡å‹
4. å®ç°Repository
5. ç¼–å†™æ–‡æ¡£

**æ”¶è·:**
- é¿å…äº†è¿”å·¥
- è®¾è®¡æ¸…æ™°åˆç†
- åç»­å¼€å‘é¡ºç•…

#### 2. å®Œæ•´çš„æ–‡æ¡£

**äº§å‡º:**
- æŠ€æœ¯æ–‡æ¡£(ç»™é«˜çº§å¼€å‘è€…)
- é¡¹ç›®æ€»ç»“(ç»™æ‰€æœ‰äºº)
- ä¼šè¯è®°å½•(ç»™é¡¹ç›®ç®¡ç†)

**ä»·å€¼:**
- æ–°äººå®¹æ˜“ä¸Šæ‰‹
- å†³ç­–æœ‰æ®å¯æŸ¥
- ç»´æŠ¤æœ‰ç« å¯å¾ª

#### 3. ç»Ÿä¸€çš„Repositoryæ¥å£

**è®¾è®¡:**
- FindByXX - æŸ¥è¯¢æ–¹æ³•
- Create - åˆ›å»º
- Update - æ›´æ–°
- Delete - åˆ é™¤
- ç»Ÿä¸€é”™è¯¯å¤„ç†

**å¥½å¤„:**
- ä»£ç é£æ ¼ä¸€è‡´
- å®¹æ˜“ç†è§£å’Œç»´æŠ¤
- æ–¹ä¾¿ç¼–å†™æµ‹è¯•

#### 4. æµ‹è¯•æ•°æ®å®Œå¤‡

**åŒ…å«:**
- 4ä¸ªå­¦ç”Ÿ,ä¸åŒè¿›åº¦
- 6ä¸ªå…³å¡,ä¸åŒéš¾åº¦
- 3ä¸ªç­çº§,ä¸åŒé…ç½®
- å®Œæ•´çš„ä¸šåŠ¡åœºæ™¯

**ä»·å€¼:**
- å¯ä»¥ç›´æ¥æµ‹è¯•
- è¦†ç›–å„ç§æƒ…å†µ
- ä¾¿äºæ¼”ç¤º

### éœ€è¦æ”¹è¿›çš„åœ°æ–¹

#### 1. åº”è¯¥å…ˆå®ç°ä¸€ä¸ªå®Œæ•´çš„Service

**é—®é¢˜:**
- Repositoryåšå®Œäº†,Serviceè¿˜æ˜¯mock
- æ— æ³•ç«¯åˆ°ç«¯éªŒè¯

**æ”¹è¿›:**
- åº”è¯¥å…ˆå®ç°StudentService
- éªŒè¯æ•´ä¸ªæµç¨‹
- å†æ‰©å±•å…¶ä»–Service

#### 2. åº”è¯¥æ›´æ—©è€ƒè™‘æ€§èƒ½

**é—®é¢˜:**
- åªæ˜¯ç†è®ºè®¾è®¡
- æ²¡æœ‰å®é™…å‹æµ‹
- ä¸çŸ¥é“ç“¶é¢ˆåœ¨å“ª

**æ”¹è¿›:**
- è¾¹å¼€å‘è¾¹æµ‹è¯•
- åŠæ—¶å‘ç°é—®é¢˜
- åŠæ—¶ä¼˜åŒ–

#### 3. åº”è¯¥ç¼–å†™å•å…ƒæµ‹è¯•

**é—®é¢˜:**
- åªæœ‰ä»£ç ,æ²¡æœ‰æµ‹è¯•
- ä¸ç¡®å®šæ­£ç¡®æ€§
- é‡æ„é£é™©å¤§

**æ”¹è¿›:**
- Repositoryå±‚åº”è¯¥æœ‰æµ‹è¯•
- è¦†ç›–å…³é”®åœºæ™¯
- ä¿è¯ä»£ç è´¨é‡

---

## ğŸ“ æŠ€æœ¯è¦ç‚¹æ€»ç»“

### GORMæ ¸å¿ƒæŠ€å·§

1. **æ ‡ç­¾ä½¿ç”¨**
```go
`gorm:"column:name;size:128;not null;index"`
```

2. **å…³è”æŸ¥è¯¢**
```go
db.Preload("User").Preload("Progress").Find(&students)
```

3. **æ™ºèƒ½æ›´æ–°**
```go
db.Model(&user).Updates(map[string]interface{}{
    "name": "æ–°åå­—",
})
```

4. **SQLè¡¨è¾¾å¼**
```go
db.Model(&student).UpdateColumn("stars", gorm.Expr("stars + ?", 5))
```

5. **é¿å…é‡å¤**
```go
db.Where("key = ?", key).FirstOrCreate(&record)
```

### Repositoryæ¨¡å¼è¦ç‚¹

1. **ç»Ÿä¸€æ¥å£**: FindByXX, Create, Update, Delete
2. **é”™è¯¯å¤„ç†**: è¿”å›ç‰¹å®šé”™è¯¯ç±»å‹
3. **Contextä¼ é€’**: æ”¯æŒè¶…æ—¶å’Œå–æ¶ˆ
4. **äº‹åŠ¡æ”¯æŒ**: WithTxæ–¹æ³•
5. **åˆ†ç¦»å…³æ³¨ç‚¹**: Repositoryåªè´Ÿè´£æ•°æ®,ä¸å«ä¸šåŠ¡é€»è¾‘

### æ•°æ®åº“è®¾è®¡åŸåˆ™

1. **ç¬¬ä¸‰èŒƒå¼**: å‡å°‘å†—ä½™
2. **é€‚å½“åèŒƒå¼**: æ€§èƒ½ä¼˜åŒ–(total_stars)
3. **ç´¢å¼•ä¼˜åŒ–**: æŸ¥è¯¢å­—æ®µå»ºç´¢å¼•
4. **å¤–é”®çº¦æŸ**: ä¿è¯æ•°æ®ä¸€è‡´æ€§
5. **JSONå­—æ®µ**: å¤æ‚åµŒå¥—ç»“æ„

---

## ğŸ“Œ äº¤ä»˜æ¸…å•

### âœ… å·²å®Œæˆ

- [x] æ•°æ®åº“Schema v3.0è®¾è®¡
- [x] 20ä¸ªGORMæ¨¡å‹å®šä¹‰
- [x] 13ä¸ªRepositoryå®ç°
- [x] Storageå±‚GORMé›†æˆ
- [x] æµ‹è¯•æ•°æ®åˆå§‹åŒ–è„šæœ¬
- [x] æŠ€æœ¯æ–‡æ¡£ç¼–å†™
- [x] é¡¹ç›®æ€»ç»“æ–‡æ¡£
- [x] ä¼šè¯è®°å½•æ–‡æ¡£
- [x] go.modä¾èµ–æ›´æ–°
- [x] main.goç¨‹åºé€‚é…

### â³ å¾…å®Œæˆ

- [ ] Serviceå±‚é‡æ„(StudentService)
- [ ] Serviceå±‚é‡æ„(AuthService)
- [ ] Serviceå±‚é‡æ„(TeacherService)
- [ ] Serviceå±‚é‡æ„(ParentService)
- [ ] å‰ç«¯APIå“åº”éªŒè¯
- [ ] v2â†’v3æ•°æ®è¿ç§»è„šæœ¬
- [ ] æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
- [ ] å•å…ƒæµ‹è¯•ç¼–å†™
- [ ] é›†æˆæµ‹è¯•ç¼–å†™
- [ ] APIæ–‡æ¡£æ›´æ–°
- [ ] éƒ¨ç½²æ–‡æ¡£ç¼–å†™

---

## ğŸ æœ€ç»ˆæ€»ç»“

### é¡¹ç›®ä»·å€¼

è¿™æ¬¡é‡æ„æ˜¯ä¸€ä¸ª**åŸºç¡€è®¾æ–½å‡çº§**,ä¸ºé¡¹ç›®çš„é•¿æœŸå‘å±•æ‰“ä¸‹äº†åšå®åŸºç¡€:

1. **æŠ€æœ¯å€ºåŠ¡æ¸…ç†**: ä»JSONå­˜å‚¨å‡çº§åˆ°æ ‡å‡†åŒ–Schema
2. **å¼€å‘æ•ˆç‡æå‡**: å¼•å…¥GORM,ç®€åŒ–æ•°æ®åº“æ“ä½œ
3. **æ€§èƒ½å¤§å¹…ä¼˜åŒ–**: ç´¢å¼•æŸ¥è¯¢æ›¿ä»£å…¨è¡¨æ‰«æ
4. **å¯ç»´æŠ¤æ€§å¢å¼º**: Repositoryæ¨¡å¼ç»Ÿä¸€æ¥å£
5. **æ‰©å±•æ€§æ”¹å–„**: æ ‡å‡†åŒ–è®¾è®¡æ˜“äºæ·»åŠ æ–°åŠŸèƒ½

### å·¥ä½œé‡è¯„ä¼°

**å®é™…æŠ•å…¥**: 1ä¸ªå·¥ä½œæ—¥
**äº§å‡ºå†…å®¹**:
- ä»£ç : 10ä¸ªæ–‡ä»¶, çº¦3000è¡Œ
- æ–‡æ¡£: 3ä»½, çº¦50000å­—
- Schema: 20å¼ è¡¨
- æµ‹è¯•æ•°æ®: å®Œæ•´ä¸šåŠ¡åœºæ™¯

### åç»­å»ºè®®

#### ç«‹å³æ‰§è¡Œ(æœ¬å‘¨)
1. **Serviceå±‚é‡æ„**: è¿æ¥Repositoryå’ŒHandler
2. **ç«¯åˆ°ç«¯æµ‹è¯•**: éªŒè¯æ•´ä¸ªæµç¨‹

#### è¿‘æœŸæ‰§è¡Œ(2å‘¨å†…)
3. **å‰ç«¯é€‚é…**: ç¡®ä¿APIå…¼å®¹
4. **å•å…ƒæµ‹è¯•**: è¦†ç›–Repositoryå±‚

#### ä¸­æœŸæ‰§è¡Œ(1æœˆå†…)
5. **æ•°æ®è¿ç§»**: v2â†’v3è¿ç§»å·¥å…·
6. **æ€§èƒ½æµ‹è¯•**: å‹æµ‹å’Œä¼˜åŒ–

### æœ€åçš„è¯

**"æ…¢å°±æ˜¯å¿«"** - èŠ±ä¸€å¤©æ—¶é—´åšå¥½åŸºç¡€è®¾æ–½,æœªæ¥ä¸‰ä¸ªæœˆçš„å¼€å‘éƒ½ä¼šæ›´é¡ºç•…ã€‚

è¿™æ¬¡é‡æ„ä¸æ˜¯ä¸€ä¸ªç»“æŸ,è€Œæ˜¯ä¸€ä¸ªæ–°çš„å¼€å§‹ã€‚æœ‰äº†è§„èŒƒåŒ–çš„æ•°æ®åº“å’Œç»Ÿä¸€çš„Repositoryå±‚,åç»­çš„åŠŸèƒ½å¼€å‘å°†ä¼š:
- âœ… æ›´å¿« (GORMè‡ªåŠ¨åŒ–)
- âœ… æ›´ç¨³ (ç±»å‹å®‰å…¨)
- âœ… æ›´å¥½ç»´æŠ¤ (ç»Ÿä¸€æ¥å£)
- âœ… æ›´æ˜“æ‰©å±• (æ ‡å‡†åŒ–è®¾è®¡)

---

**æ–‡æ¡£å®Œæˆæ—¶é—´**: 2025-09-30  
**æ€»è€—æ—¶**: 1ä¸ªå·¥ä½œæ—¥  
**æ–‡æ¡£ç»´æŠ¤è€…**: CodeAdventurers Team  
**é¡¹ç›®çŠ¶æ€**: æ ¸å¿ƒå¼€å‘å®Œæˆ,å¾…Serviceå±‚é›†æˆ  

ğŸ‰ **æ„Ÿè°¢é˜…è¯»!**
