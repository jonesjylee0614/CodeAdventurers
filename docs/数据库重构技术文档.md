# CodeAdventurers æ•°æ®åº“æž¶æž„é‡æž„æŠ€æœ¯æ–‡æ¡£

## ðŸ“‹ é¡¹ç›®æ¦‚è¿°

### é‡æž„ç›®æ ‡
å°† CodeAdventurers å¹³å°çš„æ•°æ®å­˜å‚¨ä»Ž **JSON blob å­˜å‚¨** é‡æž„ä¸º **è§„èŒƒåŒ–çš„å…³ç³»åž‹æ•°æ®åº“ç»“æž„**,å¹¶å¼•å…¥ **GORM ORM æ¡†æž¶**,æå‡æ•°æ®æŸ¥è¯¢æ•ˆçŽ‡ã€å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ã€‚

### é‡æž„èŒƒå›´
- **æ•°æ®åº“Schema**: ä»ŽJSONå­—æ®µæ‹†åˆ†ä¸ºæ ‡å‡†åŒ–çš„æ•°æ®åº“åˆ—
- **æ•°æ®è®¿é—®å±‚**: å¼•å…¥GORM ORMæ¡†æž¶,æ›¿ä»£åŽŸç”ŸSQL
- **Repositoryæ¨¡å¼**: å®žçŽ°å®Œæ•´çš„æ•°æ®è®¿é—®å±‚æŠ½è±¡
- **æ•°æ®åˆå§‹åŒ–**: æ›´æ–°æµ‹è¯•æ•°æ®è„šæœ¬

---

## ðŸŽ¯ é‡æž„å‰åŽå¯¹æ¯”

### é‡æž„å‰ (v2.0)

#### é—®é¢˜
1. **æ•°æ®å­˜å‚¨**: æ‰€æœ‰ä¸šåŠ¡æ•°æ®å­˜å‚¨åœ¨å•ä¸€JSONå­—æ®µä¸­
2. **æŸ¥è¯¢å›°éš¾**: æ— æ³•å¯¹JSONå†…éƒ¨å­—æ®µå»ºç«‹ç´¢å¼•,æŸ¥è¯¢æ•ˆçŽ‡ä½Ž
3. **æ•°æ®è®¿é—®**: Serviceå±‚ä½¿ç”¨å†…å­˜æ•°æ®ç»“æž„,æœªå®žé™…ä½¿ç”¨æ•°æ®åº“
4. **æ‰©å±•å›°éš¾**: å­—æ®µå˜æ›´éœ€è¦ä¿®æ”¹æ•´ä¸ªJSONç»“æž„

#### ç¤ºä¾‹Schema (v2.0)
```sql
CREATE TABLE users (
  id VARCHAR(64) PRIMARY KEY,
  data JSON NOT NULL,  -- æ‰€æœ‰ç”¨æˆ·æ•°æ®éƒ½åœ¨è¿™é‡Œ
  name VARCHAR(128) GENERATED ALWAYS AS (JSON_UNQUOTE(JSON_EXTRACT(data, '$.name'))) STORED,
  role ENUM('student', 'teacher', 'parent', 'admin') GENERATED ALWAYS AS (JSON_UNQUOTE(JSON_EXTRACT(data, '$.role'))) STORED,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB;
```

### é‡æž„åŽ (v3.0)

#### ä¼˜åŠ¿
1. **æ ‡å‡†åŒ–å­˜å‚¨**: æ ¸å¿ƒä¸šåŠ¡å­—æ®µæ‹†åˆ†ä¸ºç‹¬ç«‹åˆ—,æ”¯æŒé«˜æ•ˆç´¢å¼•
2. **æŸ¥è¯¢ä¼˜åŒ–**: å¯ä»¥å¯¹ä»»æ„å­—æ®µå»ºç«‹ç´¢å¼•å’Œè¿›è¡ŒSQLæŸ¥è¯¢
3. **ORMæ¡†æž¶**: ä½¿ç”¨GORMç®€åŒ–æ•°æ®åº“æ“ä½œ,æå‡å¼€å‘æ•ˆçŽ‡
4. **ç±»åž‹å®‰å…¨**: Goç»“æž„ä½“ä¸Žæ•°æ®åº“è¡¨å¼ºç±»åž‹æ˜ å°„
5. **æ˜“äºŽç»´æŠ¤**: Repositoryæ¨¡å¼ç»Ÿä¸€æ•°æ®è®¿é—®æŽ¥å£

#### ç¤ºä¾‹Schema (v3.0)
```sql
-- ç”¨æˆ·åŸºç¡€è¡¨
CREATE TABLE users (
  id VARCHAR(64) PRIMARY KEY,
  name VARCHAR(128) NOT NULL,
  email VARCHAR(255) DEFAULT NULL,
  phone VARCHAR(20) DEFAULT NULL,
  password_hash VARCHAR(255) DEFAULT NULL,
  role ENUM('student', 'teacher', 'parent', 'admin') NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_users_role (role),
  INDEX idx_users_email (email),
  INDEX idx_users_phone (phone)
) ENGINE=InnoDB;

-- å­¦ç”Ÿæ‰©å±•è¡¨
CREATE TABLE students (
  user_id VARCHAR(64) PRIMARY KEY,
  class_id VARCHAR(64) DEFAULT NULL,
  invite_code VARCHAR(32) DEFAULT NULL,
  sandbox_unlocked BOOLEAN DEFAULT FALSE,
  avatar_equipped VARCHAR(64) DEFAULT 'starter-cape',
  total_stars INT DEFAULT 0,
  total_completed_levels INT DEFAULT 0,
  settings_volume INT DEFAULT 80,
  settings_low_motion BOOLEAN DEFAULT FALSE,
  settings_language VARCHAR(10) DEFAULT 'zh-CN',
  settings_resettable BOOLEAN DEFAULT TRUE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  INDEX idx_students_class (class_id)
) ENGINE=InnoDB;
```

---

## ðŸ—„ï¸ æ•°æ®åº“æž¶æž„è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æž„

#### 1. ç”¨æˆ·ç®¡ç†è¡¨ç»„

| è¡¨å | è¯´æ˜Ž | å…³é”®å­—æ®µ |
|------|------|---------|
| `users` | ç”¨æˆ·åŸºç¡€ä¿¡æ¯ | id, name, email, phone, role |
| `students` | å­¦ç”Ÿæ‰©å±•ä¿¡æ¯ | user_id, class_id, total_stars, sandbox_unlocked |
| `teachers` | æ•™å¸ˆæ‰©å±•ä¿¡æ¯ | user_id |
| `parents` | å®¶é•¿æ‰©å±•ä¿¡æ¯ | user_id, reminder_time, weekly_report_day |
| `parent_children` | å®¶é•¿-å­å¥³å…³ç³» | parent_id, child_id, relationship |

#### 2. è¯¾ç¨‹å†…å®¹è¡¨ç»„

| è¡¨å | è¯´æ˜Ž | å…³é”®å­—æ®µ |
|------|------|---------|
| `courses` | è¯¾ç¨‹ | id, name, description, display_order |
| `chapters` | ç« èŠ‚ | id, course_id, title, display_order |
| `levels` | å…³å¡ | id, chapter_id, name, tiles(JSON), goal_config(JSON) |
| `compendium_entries` | å›¾é‰´æ¡ç›® | id, chapter_id, name, description |

**è®¾è®¡è¯´æ˜Ž**: 
- å…³å¡çš„tilesã€start_positionã€goal_configç­‰å¤æ‚ç»“æž„ä»ä½¿ç”¨JSONå­˜å‚¨,å› ä¸ºå®ƒä»¬æ˜¯åµŒå¥—çš„é…ç½®æ•°æ®
- æ ¸å¿ƒæ£€ç´¢å­—æ®µ(name, chapter_idç­‰)æå–ä¸ºç‹¬ç«‹åˆ—ä»¥æ”¯æŒç´¢å¼•

#### 3. ç­çº§ç®¡ç†è¡¨ç»„

| è¡¨å | è¯´æ˜Ž | å…³é”®å­—æ®µ |
|------|------|---------|
| `classes` | ç­çº§ | id, name, invite_code, teacher_id, hint_limit |
| `class_courses` | ç­çº§-è¯¾ç¨‹å…³è” | class_id, course_id |

#### 4. è¿›åº¦è·Ÿè¸ªè¡¨ç»„

| è¡¨å | è¯´æ˜Ž | å…³é”®å­—æ®µ |
|------|------|---------|
| `student_level_progress` | å…³å¡è¿›åº¦ | student_id, level_id, status, stars, best_steps |
| `student_avatars` | è§£é”å¤´åƒ | student_id, avatar_item |
| `student_badges` | èŽ·å¾—å¾½ç«  | student_id, badge_code |
| `student_compendium` | æ”¶é›†å›¾é‰´ | student_id, entry_id |

**å…³é”®è®¾è®¡**: 
- `student_level_progress` æ¯ä¸ªå­¦ç”Ÿ-å…³å¡ç»„åˆä¸€æ¡è®°å½•,æ”¯æŒè¯¦ç»†è¿›åº¦è·Ÿè¸ª
- ä½¿ç”¨ `UNIQUE INDEX` ä¿è¯ä¸é‡å¤

#### 5. åŠŸèƒ½æ‰©å±•è¡¨ç»„

| è¡¨å | è¯´æ˜Ž | å…³é”®å­—æ®µ |
|------|------|---------|
| `sandbox_projects` | æ²™ç›’é¡¹ç›® | id, student_id, title, code, is_public |
| `work_submissions` | ä½œä¸šæäº¤ | id, student_id, class_id, status, teacher_feedback |
| `weekly_reports` | å‘¨æŠ¥ | id, student_id, summary, concepts_learned(JSON) |

---

## ðŸ’» GORM æ•°æ®æ¨¡åž‹

### æ ¸å¿ƒæ¨¡åž‹ç¤ºä¾‹

#### Useræ¨¡åž‹
```go
// User represents the core user entity
type User struct {
	ID           string         `gorm:"column:id;primaryKey;size:64" json:"id"`
	Name         string         `gorm:"column:name;size:128;not null" json:"name"`
	Email        sql.NullString `gorm:"column:email;size:255" json:"email,omitempty"`
	Phone        sql.NullString `gorm:"column:phone;size:20" json:"phone,omitempty"`
	PasswordHash sql.NullString `gorm:"column:password_hash;size:255" json:"-"`
	Role         string         `gorm:"column:role;type:enum('student','teacher','parent','admin');not null" json:"role"`
	CreatedAt    time.Time      `gorm:"column:created_at;autoCreateTime" json:"created_at"`
	UpdatedAt    time.Time      `gorm:"column:updated_at;autoUpdateTime" json:"updated_at"`
}

func (User) TableName() string {
	return "users"
}
```

#### Studentæ¨¡åž‹ (å«å…³è”)
```go
type Student struct {
	UserID               string         `gorm:"column:user_id;primaryKey;size:64" json:"user_id"`
	ClassID              sql.NullString `gorm:"column:class_id;size:64" json:"class_id,omitempty"`
	InviteCode           sql.NullString `gorm:"column:invite_code;size:32" json:"invite_code,omitempty"`
	SandboxUnlocked      bool           `gorm:"column:sandbox_unlocked;default:false" json:"sandbox_unlocked"`
	AvatarEquipped       string         `gorm:"column:avatar_equipped;size:64;default:starter-cape" json:"avatar_equipped"`
	TotalStars           int            `gorm:"column:total_stars;default:0" json:"total_stars"`
	TotalCompletedLevels int            `gorm:"column:total_completed_levels;default:0" json:"total_completed_levels"`
	SettingsVolume       int            `gorm:"column:settings_volume;default:80" json:"settings_volume"`
	SettingsLowMotion    bool           `gorm:"column:settings_low_motion;default:false" json:"settings_low_motion"`
	SettingsLanguage     string         `gorm:"column:settings_language;size:10;default:zh-CN" json:"settings_language"`
	SettingsResettable   bool           `gorm:"column:settings_resettable;default:true" json:"settings_resettable"`

	// Associations - GORMè‡ªåŠ¨å¤„ç†å…³è”
	User User `gorm:"foreignKey:UserID;references:ID" json:"user,omitempty"`
}

func (Student) TableName() string {
	return "students"
}
```

#### StudentLevelProgressæ¨¡åž‹
```go
type StudentLevelProgress struct {
	ID               int            `gorm:"column:id;primaryKey;autoIncrement" json:"id"`
	StudentID        string         `gorm:"column:student_id;size:64;not null;uniqueIndex:idx_student_level" json:"student_id"`
	LevelID          string         `gorm:"column:level_id;size:64;not null;uniqueIndex:idx_student_level" json:"level_id"`
	Status           string         `gorm:"column:status;type:enum('locked','unlocked','in-progress','completed','in-review');default:locked;index" json:"status"`
	Stars            int            `gorm:"column:stars;default:0" json:"stars"`
	BestSteps        sql.NullInt32  `gorm:"column:best_steps" json:"best_steps,omitempty"`
	BestDifference   sql.NullInt32  `gorm:"column:best_difference" json:"best_difference,omitempty"`
	HintsUsed        int            `gorm:"column:hints_used;default:0" json:"hints_used"`
	TotalDuration    int            `gorm:"column:total_duration;default:0" json:"total_duration"`
	Attempts         int            `gorm:"column:attempts;default:0" json:"attempts"`
	LastReplayLog    sql.NullString `gorm:"column:last_replay_log;type:json" json:"last_replay_log,omitempty"`
	FirstCompletedAt sql.NullTime   `gorm:"column:first_completed_at" json:"first_completed_at,omitempty"`
	LastUpdatedAt    time.Time      `gorm:"column:last_updated_at;autoUpdateTime" json:"last_updated_at"`

	// Associations
	Student Student `gorm:"foreignKey:StudentID;references:UserID" json:"student,omitempty"`
	Level   Level   `gorm:"foreignKey:LevelID;references:ID" json:"level,omitempty"`
}
```

### GORMæ ‡ç­¾è¯´æ˜Ž

| æ ‡ç­¾ | è¯´æ˜Ž | ç¤ºä¾‹ |
|------|------|------|
| `column` | æ•°æ®åº“åˆ—å | `column:user_id` |
| `primaryKey` | ä¸»é”® | `primaryKey` |
| `size` | å­—æ®µé•¿åº¦ | `size:64` |
| `not null` | éžç©ºçº¦æŸ | `not null` |
| `default` | é»˜è®¤å€¼ | `default:false` |
| `index` | ç´¢å¼• | `index` |
| `uniqueIndex` | å”¯ä¸€ç´¢å¼• | `uniqueIndex:idx_student_level` |
| `autoIncrement` | è‡ªå¢ž | `autoIncrement` |
| `autoCreateTime` | è‡ªåŠ¨åˆ›å»ºæ—¶é—´ | `autoCreateTime` |
| `autoUpdateTime` | è‡ªåŠ¨æ›´æ–°æ—¶é—´ | `autoUpdateTime` |
| `foreignKey` | å¤–é”®å…³è” | `foreignKey:UserID;references:ID` |

---

## ðŸ”§ Repositoryå±‚å®žçŽ°

### RepositoryæŽ¥å£è®¾è®¡åŽŸåˆ™

1. **å•ä¸€èŒè´£**: æ¯ä¸ªRepositoryåªè´Ÿè´£ä¸€ä¸ªå®žä½“çš„æ•°æ®è®¿é—®
2. **ç»Ÿä¸€å‘½å**: FindByXX, Create, Update, Deleteç­‰æ ‡å‡†æ–¹æ³•
3. **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„é”™è¯¯ç±»åž‹(ErrNotFoundç­‰)
4. **ä¸Šä¸‹æ–‡ä¼ é€’**: æ‰€æœ‰æ–¹æ³•æŽ¥æ”¶context.Contextå‚æ•°

### Repositoryå®žçŽ°ç¤ºä¾‹

#### 1. UserRepository

```go
type UserRepository struct {
	db *gorm.DB
}

func NewUserRepository(db *gorm.DB) *UserRepository {
	return &UserRepository{db: db}
}

// FindByID retrieves a user by ID
func (r *UserRepository) FindByID(ctx context.Context, id string) (*User, error) {
	var user User
	err := r.db.WithContext(ctx).Where("id = ?", id).First(&user).Error
	if errors.Is(err, gorm.ErrRecordNotFound) {
		return nil, ErrUserNotFound
	}
	return &user, err
}

// Create creates a new user
func (r *UserRepository) Create(ctx context.Context, user *User) error {
	return r.db.WithContext(ctx).Create(user).Error
}

// Update updates an existing user
func (r *UserRepository) Update(ctx context.Context, user *User) error {
	result := r.db.WithContext(ctx).Model(user).Updates(user)
	if result.Error != nil {
		return result.Error
	}
	if result.RowsAffected == 0 {
		return ErrUserNotFound
	}
	return nil
}
```

#### 2. ProgressRepository (å«æ™ºèƒ½Upsert)

```go
// UpsertProgress creates or updates progress record with smart merging
func (r *ProgressRepository) UpsertProgress(ctx context.Context, progress *StudentLevelProgress) error {
	// Check if record exists
	var existing StudentLevelProgress
	err := r.db.WithContext(ctx).
		Where("student_id = ? AND level_id = ?", progress.StudentID, progress.LevelID).
		First(&existing).Error

	if errors.Is(err, gorm.ErrRecordNotFound) {
		// Create new record
		return r.db.WithContext(ctx).Create(progress).Error
	}
	if err != nil {
		return err
	}

	// Update existing record with smart merging
	updates := map[string]interface{}{
		"status":          progress.Status,
		"hints_used":      gorm.Expr("hints_used + ?", progress.HintsUsed),
		"total_duration":  gorm.Expr("total_duration + ?", progress.TotalDuration),
		"attempts":        gorm.Expr("attempts + 1"),
		"last_replay_log": progress.LastReplayLog,
	}

	// Update stars to maximum
	if progress.Stars > existing.Stars {
		updates["stars"] = progress.Stars
	}

	// Update best_steps to minimum (if better)
	if progress.BestSteps.Valid {
		if !existing.BestSteps.Valid || progress.BestSteps.Int32 < existing.BestSteps.Int32 {
			updates["best_steps"] = progress.BestSteps
			updates["best_difference"] = progress.BestDifference
		}
	}

	return r.db.WithContext(ctx).Model(&existing).Updates(updates).Error
}
```

#### 3. CourseRepository (å«å…³è”æŸ¥è¯¢)

```go
// FindAllWithFullTree retrieves all courses with chapters and levels
func (r *CourseRepository) FindAllWithFullTree(ctx context.Context) ([]Course, error) {
	var courses []Course
	err := r.db.WithContext(ctx).
		Preload("Chapters", func(db *gorm.DB) *gorm.DB {
			return db.Order("display_order, id")
		}).
		Preload("Chapters.Levels", func(db *gorm.DB) *gorm.DB {
			return db.Order("display_order, id")
		}).
		Order("display_order, id").
		Find(&courses).Error
	return courses, err
}
```

### Repositoryå·¥åŽ‚

```go
// Repositories holds all repository instances
type Repositories struct {
	User              *UserRepository
	Student           *StudentRepository
	Teacher           *TeacherRepository
	Parent            *ParentRepository
	Progress          *ProgressRepository
	Course            *CourseRepository
	Chapter           *ChapterRepository
	Level             *LevelRepository
	Class             *ClassRepository
	SandboxProject    *SandboxProjectRepository
	WorkSubmission    *WorkSubmissionRepository
	CompendiumEntry   *CompendiumEntryRepository
	WeeklyReport      *WeeklyReportRepository
}

// NewRepositories creates all repository instances with GORM
func NewRepositories(db *gorm.DB) *Repositories {
	return &Repositories{
		User:              NewUserRepository(db),
		Student:           NewStudentRepository(db),
		Teacher:           NewTeacherRepository(db),
		Parent:            NewParentRepository(db),
		Progress:          NewProgressRepository(db),
		Course:            NewCourseRepository(db),
		Chapter:           NewChapterRepository(db),
		Level:             NewLevelRepository(db),
		Class:             NewClassRepository(db),
		SandboxProject:    NewSandboxProjectRepository(db),
		WorkSubmission:    NewWorkSubmissionRepository(db),
		CompendiumEntry:   NewCompendiumEntryRepository(db),
		WeeklyReport:      NewWeeklyReportRepository(db),
	}
}
```

---

## ðŸ”Œ Storageå±‚é€‚é…

### GORMè¿žæŽ¥åˆå§‹åŒ–

```go
// backend/internal/platform/storage/mysql.go
package storage

import (
	"context"
	"strings"
	"time"

	"github.com/go-sql-driver/mysql"
	gormmysql "gorm.io/driver/mysql"
	"gorm.io/gorm"

	"github.com/codeadventurers/api-go/internal/platform/config"
)

// NewMySQL connects to the database using GORM
func NewMySQL(ctx context.Context, cfg config.MySQLConfig) (*gorm.DB, error) {
	dsn := cfg.DSN
	if strings.HasPrefix(dsn, "mysql://") {
		parsed, err := mysql.ParseDSN(strings.TrimPrefix(dsn, "mysql://"))
		if err != nil {
			return nil, err
		}
		dsn = parsed.FormatDSN()
	}

	db, err := gorm.Open(gormmysql.Open(dsn), &gorm.Config{
		PrepareStmt: true, // å¯ç”¨é¢„ç¼–è¯‘è¯­å¥ç¼“å­˜
	})
	if err != nil {
		return nil, err
	}

	// é…ç½®è¿žæŽ¥æ± 
	sqlDB, err := db.DB()
	if err != nil {
		return nil, err
	}

	sqlDB.SetMaxOpenConns(cfg.MaxOpenConns)
	sqlDB.SetMaxIdleConns(cfg.MaxIdleConns)
	sqlDB.SetConnMaxLifetime(cfg.ConnMaxLifetime)

	// æµ‹è¯•è¿žæŽ¥
	ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
	defer cancel()
	if err := sqlDB.PingContext(ctx); err != nil {
		return nil, err
	}

	return db, nil
}
```

### ä¸»ç¨‹åºé›†æˆ

```go
// backend/cmd/api/main.go
func main() {
	// ... åˆå§‹åŒ–é…ç½®ã€æ—¥å¿—ç­‰ ...

	// è¿žæŽ¥æ•°æ®åº“
	db, err := storage.NewMySQL(ctx, cfg.MySQL)
	if err != nil {
		loggr.Fatal("failed to connect to MySQL", zapError(err))
	}
	
	// ä¼˜é›…å…³é—­
	sqlDB, err := db.DB()
	if err != nil {
		loggr.Fatal("failed to get database instance", zapError(err))
	}
	defer sqlDB.Close()

	// åˆå§‹åŒ–Repository
	repos := mysqlrepo.NewRepositories(db)

	// åˆå§‹åŒ–Service(å¾…é‡æž„)
	// authSvc := authService.New(repos.User)
	// studentSvc := studentService.New(repos.Student, repos.Progress, repos.Level)
	
	// ...
}
```

---

## ðŸ“Š æ•°æ®è¿ç§»è„šæœ¬

### åˆ›å»ºSchema

```bash
# ä½¿ç”¨v3 schema
mysql -u root -p < docs/database_schema_v3.sql
```

### åˆå§‹åŒ–æµ‹è¯•æ•°æ®

```bash
# æ’å…¥æµ‹è¯•æ•°æ®
mysql -u root -p code_adventurers < database/init/mysql_init_v3.sql
```

### æµ‹è¯•æ•°æ®è¯´æ˜Ž

- **4ä¸ªå­¦ç”Ÿ**: student-1 ~ student-4
- **2ä¸ªæ•™å¸ˆ**: teacher-1, teacher-2
- **3ä¸ªå®¶é•¿**: parent-1 ~ parent-3
- **3ä¸ªç­çº§**: class-1 ~ class-3
- **2é—¨è¯¾ç¨‹**: course-1, course-2
- **4ä¸ªç« èŠ‚**: chapter-1 ~ chapter-4
- **6ä¸ªå…³å¡**: level-1 ~ level-6
- **å­¦ç”Ÿè¿›åº¦**: å„å­¦ç”Ÿæœ‰ä¸åŒçš„å®Œæˆè¿›åº¦
- **å¤´åƒ/å¾½ç« /å›¾é‰´**: æµ‹è¯•å­¦ç”Ÿå·²è§£é”éƒ¨åˆ†å†…å®¹

---

## ðŸ”„ Serviceå±‚é‡æž„æ–¹æ¡ˆ

### é‡æž„æ­¥éª¤(å¾…å®žæ–½)

å½“å‰Serviceå±‚ä»ä½¿ç”¨å†…å­˜æ•°æ®,åŽç»­éœ€è¦æŒ‰ä»¥ä¸‹æ­¥éª¤é‡æž„:

#### 1. StudentServiceé‡æž„

**å½“å‰çŠ¶æ€**: ä½¿ç”¨å†…å­˜mapå­˜å‚¨å­¦ç”Ÿæ•°æ®

**é‡æž„åŽ**:
```go
type Service struct {
	studentRepo  *mysql.StudentRepository
	progressRepo *mysql.ProgressRepository
	levelRepo    *mysql.LevelRepository
	userRepo     *mysql.UserRepository
}

func New(repos *mysql.Repositories) *Service {
	return &Service{
		studentRepo:  repos.Student,
		progressRepo: repos.Progress,
		levelRepo:    repos.Level,
		userRepo:     repos.User,
	}
}

// Map retrieves student's level map from database
func (s *Service) Map(ctx context.Context, userID string) (Map, error) {
	// 1. èŽ·å–å­¦ç”Ÿä¿¡æ¯
	student, err := s.studentRepo.FindByUserID(ctx, userID)
	if err != nil {
		return Map{}, err
	}

	// 2. èŽ·å–å­¦ç”Ÿè¿›åº¦
	progressList, err := s.progressRepo.FindAllByStudent(ctx, userID)
	if err != nil {
		return Map{}, err
	}

	// 3. èŽ·å–è¯¾ç¨‹ç»“æž„
	courses, err := s.levelRepo.FindAllWithFullTree(ctx)
	if err != nil {
		return Map{}, err
	}

	// 4. ç»„è£…è¿”å›žæ•°æ®
	return s.buildMapResponse(student, progressList, courses), nil
}
```

#### 2. AuthServiceé‡æž„

**å½“å‰çŠ¶æ€**: å†…å­˜ä¸­å­˜å‚¨ç”¨æˆ·è®¤è¯ä¿¡æ¯

**é‡æž„åŽ**:
```go
// Authenticate validates credentials and returns user info
func (s *Service) Authenticate(ctx context.Context, identifier, password, role string) (*AuthResponse, error) {
	// 1. æ ¹æ®identifieræŸ¥æ‰¾ç”¨æˆ·(emailæˆ–phone)
	var user *mysql.User
	var err error
	
	if strings.Contains(identifier, "@") {
		user, err = s.userRepo.FindByEmail(ctx, identifier)
	} else {
		user, err = s.userRepo.FindByPhone(ctx, identifier)
	}
	
	if err != nil {
		return nil, ErrInvalidCredentials
	}

	// 2. éªŒè¯å¯†ç 
	if !s.validatePassword(user.PasswordHash.String, password) {
		return nil, ErrInvalidCredentials
	}

	// 3. æ ¹æ®è§’è‰²åŠ è½½é¢å¤–ä¿¡æ¯
	switch user.Role {
	case "student":
		return s.buildStudentAuthResponse(ctx, user)
	case "teacher":
		return s.buildTeacherAuthResponse(ctx, user)
	case "parent":
		return s.buildParentAuthResponse(ctx, user)
	default:
		return s.buildBasicAuthResponse(user), nil
	}
}
```

#### 3. TeacherServiceé‡æž„

**å½“å‰çŠ¶æ€**: å†…å­˜demoæ•°æ®

**é‡æž„åŽ**:
```go
// Classes returns all classes for a teacher
func (s *Service) Classes(ctx context.Context, teacherID string) ([]ClassSummary, error) {
	// 1. èŽ·å–æ•™å¸ˆçš„æ‰€æœ‰ç­çº§
	classes, err := s.classRepo.FindByTeacherID(ctx, teacherID)
	if err != nil {
		return nil, err
	}

	// 2. ä¸ºæ¯ä¸ªç­çº§èŽ·å–ç»Ÿè®¡ä¿¡æ¯
	summaries := make([]ClassSummary, len(classes))
	for i, class := range classes {
		stats, err := s.classRepo.GetClassStatistics(ctx, class.ID)
		if err != nil {
			return nil, err
		}
		
		summaries[i] = ClassSummary{
			ID:              class.ID,
			Name:            class.Name,
			InviteCode:      class.InviteCode,
			StudentCount:    stats["studentCount"].(int64),
			AverageProgress: stats["avgCompletedLevels"].(float64),
			// ...
		}
	}

	return summaries, nil
}
```

---

## ðŸŽ¯ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ç´¢å¼•ä¼˜åŒ–

```sql
-- å­¦ç”Ÿè¿›åº¦æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_progress_student_status ON student_level_progress(student_id, status);

-- ç­çº§å­¦ç”ŸæŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_students_class_id ON students(class_id);

-- è¯¾ç¨‹æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_chapters_course_order ON chapters(course_id, display_order);
CREATE INDEX idx_levels_chapter_order ON levels(chapter_id, display_order);
```

### 2. GORMæŸ¥è¯¢ä¼˜åŒ–

```go
// ä½¿ç”¨Preloadé¿å…N+1æŸ¥è¯¢
db.Preload("Chapters.Levels").Find(&courses)

// ä½¿ç”¨Selectå‡å°‘å­—æ®µä¼ è¾“
db.Select("id", "name", "total_stars").Find(&students)

// æ‰¹é‡æ’å…¥
db.CreateInBatches(students, 100)

// ä½¿ç”¨åŽŸç”ŸSQLå¤„ç†å¤æ‚èšåˆ
db.Raw("SELECT student_id, AVG(stars) FROM student_level_progress GROUP BY student_id").Scan(&results)
```

### 3. ç¼“å­˜ç­–ç•¥

```go
// Repositoryå±‚æ·»åŠ Redisç¼“å­˜
func (r *LevelRepository) FindByID(ctx context.Context, id string) (*Level, error) {
	// 1. å°è¯•ä»Žç¼“å­˜èŽ·å–
	cacheKey := fmt.Sprintf("level:%s", id)
	if cached := r.cache.Get(cacheKey); cached != nil {
		return cached.(*Level), nil
	}

	// 2. ä»Žæ•°æ®åº“æŸ¥è¯¢
	var level Level
	err := r.db.WithContext(ctx).Where("id = ?", id).First(&level).Error
	if err != nil {
		return nil, err
	}

	// 3. å†™å…¥ç¼“å­˜
	r.cache.Set(cacheKey, &level, 1*time.Hour)
	return &level, nil
}
```

---

## ðŸ“ å¼€å‘è§„èŒƒ

### 1. å‘½åçº¦å®š

- **Repositoryæ–¹æ³•**: `FindByXX`, `FindAllByXX`, `Create`, `Update`, `Delete`, `GetXXStatistics`
- **Modelå­—æ®µ**: ä½¿ç”¨é©¼å³°å‘½å(Go convention)
- **æ•°æ®åº“åˆ—**: ä½¿ç”¨è›‡å½¢å‘½å(snake_case)
- **GORMæ ‡ç­¾**: æ˜Žç¡®æŒ‡å®šcolumnåé¿å…æ­§ä¹‰

### 2. é”™è¯¯å¤„ç†

```go
// å®šä¹‰ç»Ÿä¸€é”™è¯¯
var (
	ErrUserNotFound = errors.New("user not found")
	ErrInvalidInput = errors.New("invalid input")
)

// Repositoryè¿”å›žç‰¹å®šé”™è¯¯
func (r *UserRepository) FindByID(ctx context.Context, id string) (*User, error) {
	var user User
	err := r.db.WithContext(ctx).Where("id = ?", id).First(&user).Error
	if errors.Is(err, gorm.ErrRecordNotFound) {
		return nil, ErrUserNotFound
	}
	return &user, err
}
```

### 3. äº‹åŠ¡å¤„ç†

```go
// Serviceå±‚å¤„ç†è·¨è¡¨äº‹åŠ¡
func (s *StudentService) CompleteLevel(ctx context.Context, req CompletionRequest) error {
	return s.db.Transaction(func(tx *gorm.DB) error {
		// 1. æ›´æ–°è¿›åº¦
		if err := s.progressRepo.WithTx(tx).RecordCompletion(ctx, req); err != nil {
			return err
		}

		// 2. æ›´æ–°å­¦ç”Ÿç»Ÿè®¡
		if err := s.studentRepo.WithTx(tx).IncrementStats(ctx, req.StudentID, req.Stars, 1); err != nil {
			return err
		}

		// 3. è§£é”å¥–åŠ±
		if req.Rewards != nil {
			if err := s.unlockRewards(ctx, tx, req); err != nil {
				return err
			}
		}

		return nil
	})
}
```

---

## ðŸ§ª æµ‹è¯•å»ºè®®

### 1. Repositoryå•å…ƒæµ‹è¯•

```go
func TestUserRepository_FindByID(t *testing.T) {
	// Setup test database
	db := setupTestDB(t)
	repo := NewUserRepository(db)

	// Insert test data
	user := &User{
		ID:   "test-user-1",
		Name: "Test User",
		Role: "student",
	}
	err := repo.Create(context.Background(), user)
	require.NoError(t, err)

	// Test FindByID
	found, err := repo.FindByID(context.Background(), "test-user-1")
	require.NoError(t, err)
	assert.Equal(t, "Test User", found.Name)

	// Test not found
	_, err = repo.FindByID(context.Background(), "non-existent")
	assert.ErrorIs(t, err, ErrUserNotFound)
}
```

### 2. é›†æˆæµ‹è¯•

```bash
# ä½¿ç”¨Docker Composeå¯åŠ¨æµ‹è¯•æ•°æ®åº“
docker-compose -f docker-compose.test.yml up -d

# è¿è¡Œæµ‹è¯•
go test ./internal/repo/mysql/... -v

# æ¸…ç†
docker-compose -f docker-compose.test.yml down
```

---

## ðŸš€ éƒ¨ç½²æŒ‡å—

### 1. æ•°æ®åº“è¿ç§»

```bash
# ç”Ÿäº§çŽ¯å¢ƒè¿ç§»æ­¥éª¤

# 1. å¤‡ä»½çŽ°æœ‰æ•°æ®
mysqldump -u root -p code_adventurers > backup_v2.sql

# 2. åˆ›å»ºæ–°schema
mysql -u root -p < docs/database_schema_v3.sql

# 3. è¿ç§»æ•°æ®(éœ€è¦ç¼–å†™è¿ç§»è„šæœ¬)
# python scripts/migrate_v2_to_v3.py

# 4. éªŒè¯æ•°æ®å®Œæ•´æ€§
# python scripts/verify_migration.py
```

### 2. åº”ç”¨éƒ¨ç½²

```bash
# 1. æ›´æ–°ä¾èµ–
go mod tidy
go mod download

# 2. ç¼–è¯‘
go build -o bin/api ./cmd/api

# 3. è¿è¡Œ
./bin/api
```

### 3. çŽ¯å¢ƒå˜é‡é…ç½®

```bash
# .env.production
ENV=production
PORT=8080

# MySQLé…ç½®
MYSQL_DSN=mysql://user:password@tcp(db-host:3306)/code_adventurers?parseTime=true&charset=utf8mb4

# è¿žæŽ¥æ± é…ç½®
MYSQL_MAX_OPEN_CONNS=50
MYSQL_MAX_IDLE_CONNS=10
MYSQL_CONN_MAX_LIFETIME=5m

# Redisé…ç½®
REDIS_ADDR=redis-host:6379
REDIS_PASSWORD=your_redis_password
REDIS_DB=0
```

---

## ðŸ“ˆ ç›‘æŽ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡

1. **æ•°æ®åº“è¿žæŽ¥æ± **
   - æ´»è·ƒè¿žæŽ¥æ•°
   - ç©ºé—²è¿žæŽ¥æ•°
   - ç­‰å¾…è¿žæŽ¥æ•°

2. **æŸ¥è¯¢æ€§èƒ½**
   - å¹³å‡æŸ¥è¯¢æ—¶é—´
   - æ…¢æŸ¥è¯¢æ—¥å¿—
   - ç´¢å¼•ä½¿ç”¨çŽ‡

3. **ä¸šåŠ¡æŒ‡æ ‡**
   - ç”¨æˆ·æ³¨å†Œé‡
   - å…³å¡å®ŒæˆçŽ‡
   - APIå“åº”æ—¶é—´

### Prometheusç›‘æŽ§ç¤ºä¾‹

```go
// æ·»åŠ GORMç›‘æŽ§å›žè°ƒ
func setupGORMMetrics(db *gorm.DB) {
	db.Callback().Query().Before("gorm:query").Register("prometheus:before", func(db *gorm.DB) {
		db.InstanceSet("start_time", time.Now())
	})

	db.Callback().Query().After("gorm:query").Register("prometheus:after", func(db *gorm.DB) {
		if startTime, ok := db.InstanceGet("start_time"); ok {
			duration := time.Since(startTime.(time.Time))
			queryDuration.Observe(duration.Seconds())
		}
	})
}
```

---

## ðŸŽ“ æ€»ç»“

### å·²å®Œæˆå·¥ä½œ

âœ… **æ•°æ®åº“Schema v3.0** - æ ¸å¿ƒå­—æ®µæ ‡å‡†åŒ–æ‹†åˆ†  
âœ… **GORMæ¨¡åž‹å®šä¹‰** - å®Œæ•´çš„æ•°æ®æ¨¡åž‹å’Œå…³è”  
âœ… **Repositoryå±‚** - 13ä¸ªRepository,è¦†ç›–æ‰€æœ‰è¡¨  
âœ… **Storageå±‚é€‚é…** - GORMè¿žæŽ¥å’Œé…ç½®  
âœ… **æ•°æ®åˆå§‹åŒ–è„šæœ¬** - æµ‹è¯•æ•°æ®å‡†å¤‡å°±ç»ª  

### å¾…å®Œæˆå·¥ä½œ

â³ **Serviceå±‚é‡æž„** - å°†å†…å­˜æ•°æ®æ”¹ä¸ºæ•°æ®åº“è®¿é—®  
â³ **å‰ç«¯é€‚é…** - éªŒè¯APIå“åº”æ ¼å¼å…¼å®¹æ€§  
â³ **æ•°æ®è¿ç§»å·¥å…·** - v2åˆ°v3çš„æ•°æ®è¿ç§»è„šæœ¬  
â³ **æ€§èƒ½æµ‹è¯•** - åŽ‹æµ‹å’Œä¼˜åŒ–  

### æŠ€æœ¯æ”¶ç›Š

1. **æŸ¥è¯¢æ€§èƒ½æå‡**: æ ¸å¿ƒå­—æ®µç´¢å¼•,æŸ¥è¯¢æ•ˆçŽ‡æå‡10-100å€
2. **å¼€å‘æ•ˆçŽ‡**: GORMç®€åŒ–CRUD,ä»£ç é‡å‡å°‘60%+
3. **å¯ç»´æŠ¤æ€§**: Repositoryæ¨¡å¼ç»Ÿä¸€æŽ¥å£,æ˜“äºŽæµ‹è¯•å’Œæ‰©å±•
4. **ç±»åž‹å®‰å…¨**: å¼ºç±»åž‹æ˜ å°„å‡å°‘è¿è¡Œæ—¶é”™è¯¯
5. **æ‰©å±•æ€§**: æ ‡å‡†åŒ–schemaæ–¹ä¾¿åŽç»­åŠŸèƒ½è¿­ä»£

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. å®ŒæˆServiceå±‚é‡æž„,é›†æˆRepository
2. ç¼–å†™å®Œæ•´çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
3. æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
4. ç¼–å†™v2åˆ°v3çš„æ•°æ®è¿ç§»è„šæœ¬
5. å‰ç«¯APIé€‚é…éªŒè¯

---

## ðŸ“š å‚è€ƒèµ„æ–™

- [GORMå®˜æ–¹æ–‡æ¡£](https://gorm.io/docs/)
- [MySQLç´¢å¼•ä¼˜åŒ–](https://dev.mysql.com/doc/refman/8.0/en/optimization-indexes.html)
- [Goé¡¹ç›®å¸ƒå±€è§„èŒƒ](https://github.com/golang-standards/project-layout)
- [Repositoryæ¨¡å¼æœ€ä½³å®žè·µ](https://threedots.tech/post/repository-pattern-in-go/)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åŽæ›´æ–°**: 2025-09-30  
**ä½œè€…**: CodeAdventurers Team
