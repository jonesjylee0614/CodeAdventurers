# 前端技术文档

## 目录

1. [项目概述](#项目概述)
2. [技术栈](#技术栈)
3. [项目结构](#项目结构)
4. [核心功能](#核心功能)
5. [路由系统](#路由系统)
6. [状态管理](#状态管理)
7. [组件库](#组件库)
8. [API 集成](#api-集成)
9. [游戏引擎](#游戏引擎)
10. [开发指南](#开发指南)

---

## 项目概述

**代码奇兵 (Code Adventurers)** 是一个面向青少年的编程教育平台，通过游戏化的方式让学生学习编程概念。

### 核心特性

- 🎮 **游戏化学习**：通过闯关模式学习编程
- 🧩 **可视化编程**：使用积木式编程界面
- 👥 **多角色系统**：支持学生、教师、家长、管理员
- 📊 **进度追踪**：实时查看学习进度和成就
- 🏆 **成就系统**：收集徽章、解锁装扮

---

## 技术栈

### 核心框架
- **React 18** - UI 框架
- **TypeScript** - 类型安全
- **Vite** - 构建工具

### 路由和状态
- **React Router v6** - 客户端路由
- **Zustand** - 轻量级状态管理
- **Zustand Persist** - 状态持久化

### 样式
- **CSS Modules** - 组件样式隔离
- **自定义 CSS** - 简洁的样式系统

### 工具库
- **React Query** (可选) - 数据获取和缓存
- **Jest** - 单元测试
- **ESLint** - 代码规范

---

## 项目结构

```
frontend/
├── apps/
│   ├── student/              # 学生端独立组件
│   │   └── src/
│   │       ├── BlockEditor.tsx    # 积木编程编辑器
│   │       ├── GameCanvas.tsx     # 游戏画布
│   │       └── components.tsx     # 学生端工具组件
│   │
│   ├── teacher/              # 教师端独立组件
│   │   └── src/
│   │       ├── LevelEditor.tsx    # 关卡编辑器
│   │       └── components.tsx     # 教师端工具组件
│   │
│   └── web/                  # 主应用
│       └── src/
│           ├── app/                  # 应用核心
│           │   ├── components/       # 应用级组件
│           │   │   ├── AuthModal.tsx        # 登录模态框（备用）
│           │   │   └── auth-modal.css
│           │   │
│           │   ├── layouts/          # 布局组件
│           │   │   ├── AppShell.tsx         # 主框架（导航栏等）
│           │   │   └── app-shell.css
│           │   │
│           │   ├── pages/            # 页面组件
│           │   │   ├── admin/               # 管理员页面
│           │   │   ├── parent/              # 家长页面
│           │   │   ├── shared/              # 共享页面
│           │   │   │   ├── LoginPage.tsx    # 登录页面
│           │   │   │   └── login-page.css
│           │   │   ├── student/             # 学生页面
│           │   │   │   ├── HomePage.tsx           # 学生首页
│           │   │   │   ├── LevelsPage.tsx         # 关卡地图
│           │   │   │   ├── LevelDetailPage.tsx    # 关卡详情
│           │   │   │   ├── PlayPage.tsx           # 游戏页面
│           │   │   │   ├── ResultPage.tsx         # 结果页面
│           │   │   │   ├── AchievementsPage.tsx   # 成就页面
│           │   │   │   ├── SettingsPage.tsx       # 设置页面
│           │   │   │   ├── StudentLayout.tsx      # 学生布局
│           │   │   │   └── student-layout.css
│           │   │   └── teacher/             # 教师页面
│           │   │       ├── OverviewPage.tsx       # 概览
│           │   │       ├── ClassesPage.tsx        # 班级列表
│           │   │       ├── ClassDetailPage.tsx    # 班级详情
│           │   │       ├── AssignmentsPage.tsx    # 作业管理
│           │   │       ├── ContentPage.tsx        # 内容管理
│           │   │       ├── AnalyticsPage.tsx      # 数据分析
│           │   │       ├── TeacherLayout.tsx      # 教师布局
│           │   │       └── teacher-layout.css
│           │   │
│           │   ├── providers/        # 上下文提供者
│           │   │   ├── AppErrorBoundary.tsx # 错误边界
│           │   │   └── FeatureFlagProvider.tsx
│           │   │
│           │   ├── App.tsx           # 应用根组件
│           │   ├── providers.tsx     # Provider 集合
│           │   └── routes.tsx        # 路由配置
│           │
│           ├── components/           # 通用组件库
│           │   └── ui/
│           │       ├── Badge.tsx           # 徽章
│           │       ├── Button.tsx          # 按钮
│           │       ├── Card.tsx            # 卡片
│           │       ├── Drawer.tsx          # 抽屉
│           │       ├── EmptyState.tsx      # 空状态
│           │       ├── Input.tsx           # 输入框
│           │       ├── Modal.tsx           # 模态框
│           │       ├── Progress.tsx        # 进度条
│           │       ├── Select.tsx          # 下拉选择
│           │       ├── Skeleton.tsx        # 骨架屏
│           │       ├── Table.tsx           # 表格
│           │       ├── Tabs.tsx            # 标签页
│           │       ├── TabSwitcher.tsx     # 标签切换器
│           │       └── Toast.tsx           # 提示消息
│           │
│           ├── services/             # 服务层
│           │   └── api/
│           │       └── client.ts           # API 客户端
│           │
│           ├── store/                # 状态管理
│           │   ├── useAppStore.ts          # 应用全局状态
│           │   └── usePlaybackStore.ts     # 游戏回放状态
│           │
│           ├── hooks/                # 自定义 Hooks
│           │   └── useWebVitalsLogger.ts
│           │
│           ├── utils/                # 工具函数
│           │   └── featureFlags.ts
│           │
│           └── main.tsx              # 应用入口
│
├── packages/                 # 共享包
│   └── engine/
│       └── src/
│           ├── index.ts              # 游戏引擎
│           └── types.ts              # 类型定义
│
├── tests/                    # 测试文件
│   ├── apps/
│   └── packages/
│
├── index.html               # HTML 入口
├── vite.config.ts           # Vite 配置
├── tsconfig.json            # TypeScript 配置
└── package.json             # 项目依赖
```

---

## 核心功能

### 1. 用户认证系统

支持四种登录方式：

#### 游客模式
- 快速体验，无需注册
- 数据保存在本地
- 功能受限

#### 学生登录
- 使用班级邀请码加入
- 输入姓名即可
- 可以闯关学习

#### 教师登录
- 账号密码登录
- 管理班级和学生
- 查看学习数据

#### 家长登录
- 账号密码登录
- 查看孩子进度
- 接收学习报告

**实现文件：**
- `LoginPage.tsx` - 登录页面
- `AuthModal.tsx` - 登录模态框（备用）
- `useAppStore.ts` - 认证状态管理

### 2. 学生学习系统

#### 2.1 首页 (HomePage)
- 显示学习进度
- 推荐下一个关卡
- 显示最近完成的关卡
- 学习统计（连续天数、本周进度等）

#### 2.2 关卡地图 (LevelsPage)
- 章节式组织
- 关卡解锁机制
- 三星评价系统
- 进度可视化

#### 2.3 游戏页面 (PlayPage)
- 积木编程编辑器
- 实时游戏画布
- 提示系统
- 运行和重置功能

#### 2.4 成就系统 (AchievementsPage)
- 徽章收集
- 装扮解锁
- 成就展示

### 3. 教师管理系统

#### 3.1 班级管理
- 创建和管理班级
- 生成邀请码
- 查看学生列表

#### 3.2 作业管理
- 布置关卡作业
- 设置截止时间
- 查看完成情况

#### 3.3 数据分析
- 学生进度统计
- 学习时间分析
- 难点识别

#### 3.4 内容管理
- 自定义关卡（未来）
- 教学资源管理

### 4. 家长监护系统

#### 4.1 进度查看
- 孩子学习进度
- 学习时长统计
- 成就展示

#### 4.2 学习报告
- 周报/月报
- 学习建议

---

## 路由系统

### 路由结构

```typescript
/                       → 重定向到 /student
/login                  → 登录页面（独立，无 AppShell）

# 学生端路由
/student                → 学生首页
/student/levels         → 关卡地图
/student/levels/:id     → 关卡详情
/student/play/:id       → 游戏页面
/student/result         → 结果页面
/student/achievements   → 成就页面
/student/settings       → 设置页面

# 教师端路由
/teacher                → 教师概览
/teacher/classes        → 班级列表
/teacher/classes/:id    → 班级详情
/teacher/assignments    → 作业管理
/teacher/content        → 内容管理
/teacher/analytics      → 数据分析

# 家长端路由
/parent                 → 家长首页
/parent/progress        → 进度查看
/parent/progress/:id    → 孩子详细进度
/parent/settings        → 设置页面

# 管理端路由
/admin                  → 管理概览
/admin/users            → 用户管理
/admin/curriculum       → 课程管理
/admin/ops              → 运营管理
/admin/settings         → 系统设置
```

### 路由保护

未登录用户访问受保护页面时，会自动重定向到登录页面，并保存原始路径：

```typescript
// 示例
访问：/student/play/level-1
重定向到：/login?redirect=/student/play/level-1
登录后自动返回：/student/play/level-1
```

### 实现文件
- `routes.tsx` - 路由配置
- `AppShell.tsx` - 应用框架布局

---

## 状态管理

使用 **Zustand** 进行状态管理，配合 **Persist 中间件** 实现状态持久化。

### 主要 Store

#### 1. App Store (`useAppStore.ts`)

**用户状态**
```typescript
user: User | StudentProfile | TeacherProfile | ParentProfile | undefined
isLoggedIn: boolean
```

**认证相关**
```typescript
auth: {
  isOpen: boolean     // AuthModal 是否打开
  mode: AuthMode      // 'guest' | 'student' | 'teacher' | 'parent'
}
```

**学生端数据**
```typescript
chapters: Chapter[]       // 章节列表
currentChapter?: Chapter  // 当前章节
```

**游戏状态**
```typescript
game: {
  currentLevel?: Level
  currentProgram: any[]
  simulationResult?: SimulationResult
  isRunning: boolean
  hints: string[]
  attempts: number
  lastError?: string
}
```

**UI 状态**
```typescript
loading: boolean
error?: string
```

**核心方法**

```typescript
// 认证
loginAsGuest(name?: string): Promise<boolean>
joinClass(inviteCode: string, name: string): Promise<boolean>
loginWithCredentials(payload): Promise<boolean>
logout(): void

// 学生数据
loadStudentData(): Promise<void>
loadChapters(): Promise<void>

// 游戏
setCurrentLevel(level: Level): void
setProgram(program: any[]): void
runProgram(programOverride?: any[]): Promise<any>
completeLevel(data): Promise<void>
getHint(): Promise<void>
resetGame(): void
```

#### 2. Playback Store (`usePlaybackStore.ts`)

用于游戏回放和动画控制（未来扩展）。

### 状态持久化

使用 Zustand 的 `persist` 中间件，将以下状态保存到 localStorage：

```typescript
{
  name: 'app-storage',
  partialize: (state) => ({
    user: state.user,
    isLoggedIn: state.isLoggedIn
  })
}
```

---

## 组件库

### UI 组件清单

所有组件位于 `components/ui/` 目录下：

#### 1. Badge（徽章）
```tsx
<Badge tone="success">完成</Badge>
<Badge tone="info">进行中</Badge>
<Badge tone="warning">警告</Badge>
<Badge tone="error">错误</Badge>
```

#### 2. Button（按钮）
```tsx
<Button variant="primary">主要按钮</Button>
<Button variant="secondary">次要按钮</Button>
<Button variant="ghost">幽灵按钮</Button>
<Button loading={true}>加载中...</Button>
<Button disabled>禁用</Button>
```

#### 3. Card（卡片）
```tsx
<Card 
  title="标题"
  subtitle="副标题"
  actions={<Button>操作</Button>}
>
  内容
</Card>
```

#### 4. Modal（模态框）
```tsx
<Modal
  title="标题"
  open={isOpen}
  onClose={handleClose}
  primaryAction={{ label: '确定', onClick: handleConfirm }}
  secondaryAction={{ label: '取消', onClick: handleClose }}
>
  模态框内容
</Modal>
```

#### 5. Input（输入框）
```tsx
<Input
  type="text"
  placeholder="请输入"
  value={value}
  onChange={handleChange}
  maxLength={20}
/>
```

#### 6. Progress（进度条）
```tsx
<Progress value={75} label="75%" />
```

#### 7. Toast（提示消息）
```tsx
const { showToast } = useToast();
showToast('操作成功', 'success');
```

#### 8. Skeleton（骨架屏）
```tsx
<Skeleton height={200} />
```

#### 9. EmptyState（空状态）
```tsx
<EmptyState
  title="暂无数据"
  description="还没有任何内容"
  actions={<Button>添加</Button>}
/>
```

#### 10. Table（表格）
```tsx
<Table
  columns={[
    { key: 'name', label: '姓名' },
    { key: 'score', label: '分数' }
  ]}
  data={students}
/>
```

#### 11. Tabs（标签页）
```tsx
<Tabs
  tabs={[
    { id: 'tab1', label: '标签1', content: <div>内容1</div> },
    { id: 'tab2', label: '标签2', content: <div>内容2</div> }
  ]}
/>
```

#### 12. TabSwitcher（标签切换器）
```tsx
<TabSwitcher
  tabs={[
    { id: 'tab1', label: '标签1', icon: '🏠' },
    { id: 'tab2', label: '标签2', icon: '⚙️' }
  ]}
  activeTab={activeTab}
  onTabChange={setActiveTab}
/>
```

#### 13. Select（下拉选择）
```tsx
<Select
  options={[
    { value: '1', label: '选项1' },
    { value: '2', label: '选项2' }
  ]}
  value={selectedValue}
  onChange={handleChange}
/>
```

#### 14. Drawer（抽屉）
```tsx
<Drawer
  open={isOpen}
  onClose={handleClose}
  title="抽屉标题"
>
  抽屉内容
</Drawer>
```

### 组件设计原则

1. **简洁性**：API 简单直观
2. **可定制**：支持 className 和 style props
3. **无障碍**：支持键盘导航和屏幕阅读器
4. **响应式**：适配移动和桌面设备

---

## API 集成

### API Client (`services/api/client.ts`)

统一的 API 调用接口，基于 RESTful 设计。

#### 主要方法

**认证相关**
```typescript
loginAsGuest(name?: string): Promise<ApiResponse<LoginResponse>>
joinClass(inviteCode: string, name: string): Promise<ApiResponse<JoinClassResponse>>
loginWithCredentials(payload): Promise<ApiResponse<LoginResponse>>
```

**学生端**
```typescript
getStudentProfile(): Promise<ApiResponse<StudentProfile>>
getStudentMap(): Promise<ApiResponse<{ chapters: Chapter[] }>>
getStudentLevel(levelId: string): Promise<ApiResponse<Level>>
getLevelPrep(levelId: string): Promise<ApiResponse<LevelPrep>>
runLevel(levelId: string, program: any[]): Promise<ApiResponse<SimulationResult>>
completeLevel(levelId: string, data): Promise<ApiResponse<void>>
getHint(levelId: string, context): Promise<ApiResponse<{ hint: string }>>
```

**教师端**
```typescript
getTeacherProfile(): Promise<ApiResponse<TeacherProfile>>
getTeacherClasses(): Promise<ApiResponse<Class[]>>
getClassDetail(classId: string): Promise<ApiResponse<ClassDetail>>
createClass(data): Promise<ApiResponse<Class>>
```

**家长端**
```typescript
getParentProfile(): Promise<ApiResponse<ParentProfile>>
getChildrenProgress(): Promise<ApiResponse<ChildProgress[]>>
```

#### 类型定义

所有 API 相关的类型都在 `client.ts` 中定义：

```typescript
// 用户类型
export interface User {
  id: string;
  name: string;
  role: 'student' | 'teacher' | 'parent' | 'admin';
  classId?: string;
}

export interface StudentProfile extends User {
  role: 'student';
  avatar?: {
    equipped: string;
    unlocked: string[];
  };
  badges: Badge[];
  sandboxUnlocked: boolean;
}

// 章节和关卡
export interface Chapter {
  id: string;
  name: string;
  description: string;
  levels: Level[];
}

export interface Level {
  id: string;
  name: string;
  description: string;
  status: 'locked' | 'unlocked' | 'completed';
  stars: number;
  bestSteps: number;
  allowedBlocks: string[];
  goal: VictoryCondition;
  // ... 更多字段
}

// API 响应
export interface ApiResponse<T> {
  data?: T;
  error?: string;
}
```

#### 错误处理

API 调用失败时返回 error 字段：

```typescript
const response = await apiClient.getStudentProfile();
if (response.error) {
  console.error('获取数据失败:', response.error);
  // 处理错误
}
```

---

## 游戏引擎

### 游戏引擎 (`packages/engine/`)

负责程序执行和游戏逻辑模拟。

#### 核心功能

1. **程序解释器**：解析积木程序
2. **游戏状态管理**：跟踪角色位置、收集物等
3. **碰撞检测**：检查角色移动是否合法
4. **胜利条件判断**：判断是否完成关卡目标

#### 类型定义 (`types.ts`)

```typescript
// 指令类型
export type BlockType = 
  | 'MOVE' 
  | 'TURN_LEFT' 
  | 'TURN_RIGHT' 
  | 'COLLECT'
  | 'REPEAT'
  | 'CONDITIONAL';

// 游戏状态
export interface GameState {
  character: {
    x: number;
    y: number;
    direction: Direction;
  };
  collectibles: Position[];
  obstacles: Position[];
}

// 执行结果
export interface SimulationResult {
  success: boolean;
  steps: number;
  stars: number;
  log: GameLog[];
  errorCode?: string;
}
```

#### 使用示例

```typescript
import { executeProgram } from '@packages/engine';

const result = await executeProgram(program, level);
if (result.success) {
  console.log(`完成关卡，获得 ${result.stars} 星`);
} else {
  console.log(`失败：${result.errorCode}`);
}
```

---

## 开发指南

### 环境准备

1. **安装依赖**
```bash
cd frontend
npm install
```

2. **启动开发服务器**
```bash
npm run dev
```

3. **构建生产版本**
```bash
npm run build
```

4. **运行测试**
```bash
npm test
```

### 开发规范

#### 1. 文件命名
- 组件文件：PascalCase，如 `HomePage.tsx`
- 样式文件：kebab-case，如 `home-page.css`
- 工具文件：camelCase，如 `utils.ts`

#### 2. 组件编写

使用函数组件和 Hooks：

```tsx
import { useState, useEffect } from 'react';

export const MyComponent = () => {
  const [count, setCount] = useState(0);

  useEffect(() => {
    // 副作用
  }, []);

  return <div>{count}</div>;
};

export default MyComponent;
```

#### 3. 类型定义

优先使用 TypeScript 类型：

```typescript
interface Props {
  title: string;
  count?: number;
  onSubmit: (value: string) => void;
}

export const MyComponent: React.FC<Props> = ({ title, count = 0, onSubmit }) => {
  // ...
};
```

#### 4. 样式编写

使用 CSS Modules 或普通 CSS：

```css
/* my-component.css */
.container {
  padding: 1rem;
  background: white;
}

.title {
  font-size: 1.5rem;
  font-weight: bold;
}
```

```tsx
import './my-component.css';

export const MyComponent = () => {
  return (
    <div className="container">
      <h1 className="title">标题</h1>
    </div>
  );
};
```

#### 5. 状态管理

使用 Zustand Store：

```typescript
const { user, setUser } = useAppStore((state) => ({
  user: state.user,
  setUser: state.setUser,
}));
```

#### 6. API 调用

使用 API Client：

```typescript
const response = await apiClient.getStudentProfile();
if (response.error) {
  setError(response.error);
  return;
}
setProfile(response.data);
```

### 常见问题

#### 1. Hooks 顺序问题

**错误示例**：
```tsx
const MyComponent = () => {
  if (condition) {
    return <div>Early return</div>;
  }
  
  const [count, setCount] = useState(0); // ❌ 错误！Hooks 在条件之后
};
```

**正确示例**：
```tsx
const MyComponent = () => {
  const [count, setCount] = useState(0); // ✅ 正确！Hooks 在最前面
  
  if (condition) {
    return <div>Early return</div>;
  }
};
```

#### 2. 路由跳转

使用 `useNavigate` Hook：

```tsx
const navigate = useNavigate();

const handleClick = () => {
  navigate('/student/levels');
};
```

#### 3. 状态更新

使用 Zustand 的 set 方法：

```typescript
// Store 定义
set((state) => ({
  user: newUser,
  isLoggedIn: true
}));

// 或者使用 get 获取当前状态
set((state) => ({
  count: get().count + 1
}));
```

### 性能优化

1. **懒加载**：使用 `React.lazy` 和 `Suspense`
2. **Memo**：使用 `React.memo` 避免不必要的重渲染
3. **useCallback/useMemo**：缓存函数和计算结果
4. **代码分割**：按路由分割代码

### 调试技巧

1. **React DevTools**：查看组件树和 props
2. **Console.log**：在关键位置添加日志
3. **Zustand DevTools**：查看状态变化
4. **Network 面板**：查看 API 请求

---

## 总结

代码奇兵前端项目采用现代化的 React 技术栈，结构清晰、易于维护。核心特点：

- ✅ **模块化设计**：按功能和角色分离组件
- ✅ **类型安全**：全面使用 TypeScript
- ✅ **状态管理**：Zustand 轻量高效
- ✅ **组件复用**：丰富的 UI 组件库
- ✅ **用户体验**：响应式设计和加载状态

如有问题，请参考其他文档或联系开发团队。

