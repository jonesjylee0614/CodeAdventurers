# CodeAdventurers æ•°æ®åº“é‡æ„é¡¹ç›®æ€»ç»“

> **é¡¹ç›®å‘¨æœŸ**: 2025-09-30  
> **é‡æ„ç±»å‹**: æ•°æ®åº“æ¶æ„å‡çº§ + ORMæ¡†æ¶å¼•å…¥  
> **çŠ¶æ€**: æ ¸å¿ƒå¼€å‘å®Œæˆ,å¾…Serviceå±‚é›†æˆ

---

## ğŸ¯ ä¸ºä»€ä¹ˆè¦é‡æ„?

### åŸæ¥çš„é—®é¢˜

æƒ³è±¡ä¸€ä¸‹,ä½ æœ‰ä¸€ä¸ªæŸœå­,æ‰€æœ‰ä¸œè¥¿éƒ½æ‰”åœ¨ä¸€ä¸ªå¤§ç®±å­é‡Œ:

```json
{
  "id": "student-1",
  "name": "å°æ˜",
  "class": "ä¸€ç­",
  "stars": 10,
  "avatar": {...},
  "progress": {...},
  ...æ‰€æœ‰ä¸œè¥¿éƒ½åœ¨è¿™é‡Œ
}
```

**è¿™æ ·çš„é—®é¢˜:**
- ğŸ” **æ‰¾ä¸œè¥¿æ…¢**: æƒ³æ‰¾"ç­çº§æ˜¯ä¸€ç­çš„æ‰€æœ‰å­¦ç”Ÿ",å¾—æŠŠæ¯ä¸ªç®±å­éƒ½æ‰“å¼€ç¿»ä¸€é
- ğŸ“Š **ç»Ÿè®¡éš¾**: æƒ³çŸ¥é“"å¹³å‡åˆ†æ˜¯å¤šå°‘",å¾—æŠŠæ‰€æœ‰æ•°æ®è¯»å‡ºæ¥è‡ªå·±ç®—
- ğŸŒ **æ€§èƒ½å·®**: æ¯æ¬¡æŸ¥è¯¢éƒ½è¦è¯»å–æ•´ä¸ªJSON,å³ä½¿åªéœ€è¦ä¸€ä¸ªå­—æ®µ
- ğŸ”§ **éš¾ç»´æŠ¤**: æƒ³åŠ ä¸ªæ–°å­—æ®µ,å¾—æ”¹éæ‰€æœ‰åœ°æ–¹

### é‡æ„åçš„æ ·å­

ç°åœ¨å˜æˆäº†ä¸€ä¸ªæœ‰åºçš„æ–‡ä»¶æŸœ,æ¯ä¸ªæŠ½å±‰åˆ†é—¨åˆ«ç±»:

```
ğŸ“ ç”¨æˆ·æŸœ (usersè¡¨)
   â”œâ”€ ID
   â”œâ”€ å§“å
   â”œâ”€ è§’è‰²
   â””â”€ ...

ğŸ“ å­¦ç”ŸæŸœ (studentsè¡¨)
   â”œâ”€ å­¦ç”ŸID
   â”œâ”€ ç­çº§ID
   â”œâ”€ æ€»æ˜Ÿæ•°
   â””â”€ ...

ğŸ“ è¿›åº¦æŸœ (student_level_progressè¡¨)
   â”œâ”€ å­¦ç”ŸID
   â”œâ”€ å…³å¡ID
   â”œâ”€ å®ŒæˆçŠ¶æ€
   â”œâ”€ å¾—åˆ†
   â””â”€ ...
```

**å¥½å¤„:**
- âš¡ **æŸ¥è¯¢å¿«**: ç›´æ¥æ‰¾å¯¹åº”çš„æŠ½å±‰,è¿˜èƒ½å»ºç´¢å¼•(å°±åƒä¹¦ç­¾)
- ğŸ“Š **ç»Ÿè®¡æ˜“**: æ•°æ®åº“è‡ªå·±ä¼šç®—å¹³å‡å€¼ã€æ€»æ•°ç­‰
- ğŸš€ **æ€§èƒ½å¥½**: åªè¯»éœ€è¦çš„å­—æ®µ,ä¸ç”¨å…¨éƒ¨åŠ è½½
- âœ¨ **å¥½ç»´æŠ¤**: åŠ æ–°å­—æ®µå°±æ˜¯åŠ æ–°åˆ—,ä¸å½±å“æ—§æ•°æ®

---

## ğŸ“‹ æˆ‘ä»¬åšäº†ä»€ä¹ˆ?

### 1. è®¾è®¡æ–°çš„æ•°æ®åº“ç»“æ„

#### æ ¸å¿ƒè¡¨ä¸€è§ˆ

```
ç”¨æˆ·ç›¸å…³ (5å¼ è¡¨)
â”œâ”€ users          ç”¨æˆ·åŸºç¡€ä¿¡æ¯
â”œâ”€ students       å­¦ç”Ÿæ‰©å±•ä¿¡æ¯
â”œâ”€ teachers       æ•™å¸ˆä¿¡æ¯
â”œâ”€ parents        å®¶é•¿ä¿¡æ¯
â””â”€ parent_children å®¶é•¿-å­©å­å…³ç³»

è¯¾ç¨‹å†…å®¹ (4å¼ è¡¨)
â”œâ”€ courses        è¯¾ç¨‹
â”œâ”€ chapters       ç« èŠ‚
â”œâ”€ levels         å…³å¡
â””â”€ compendium_entries å›¾é‰´æ¡ç›®

ç­çº§ç®¡ç† (2å¼ è¡¨)
â”œâ”€ classes        ç­çº§ä¿¡æ¯
â””â”€ class_courses  ç­çº§-è¯¾ç¨‹å…³è”

è¿›åº¦è¿½è¸ª (4å¼ è¡¨)
â”œâ”€ student_level_progress  å…³å¡è¿›åº¦
â”œâ”€ student_avatars         è§£é”å¤´åƒ
â”œâ”€ student_badges          è·å¾—å¾½ç« 
â””â”€ student_compendium      æ”¶é›†å›¾é‰´

åŠŸèƒ½æ‰©å±• (3å¼ è¡¨)
â”œâ”€ sandbox_projects æ²™ç›’é¡¹ç›®
â”œâ”€ work_submissions ä½œä¸šæäº¤
â””â”€ weekly_reports   å‘¨æŠ¥
```

#### ä¸¾ä¸ªæ —å­: å­¦ç”Ÿè¿›åº¦è¡¨

**ä»¥å‰ (JSON):**
```json
{
  "student-1": [
    {"levelId": "level-1", "stars": 3, "status": "completed"},
    {"levelId": "level-2", "stars": 2, "status": "in-progress"}
  ]
}
```

**ç°åœ¨ (SQLè¡¨):**
```sql
+----+------------+----------+-----------+-------+------------+
| id | student_id | level_id | status    | stars | best_steps |
+----+------------+----------+-----------+-------+------------+
| 1  | student-1  | level-1  | completed | 3     | 5          |
| 2  | student-1  | level-2  | in-progress| 2    | 8          |
+----+------------+----------+-----------+-------+------------+
```

**ä¸ºä»€ä¹ˆè¿™æ ·æ›´å¥½?**
- âœ… æ¯ä¸ªå­¦ç”Ÿçš„æ¯ä¸ªå…³å¡æ˜¯ç‹¬ç«‹ä¸€è¡Œ,æ–¹ä¾¿æŸ¥è¯¢å’Œç»Ÿè®¡
- âœ… å¯ä»¥å»ºç«‹ç´¢å¼•: `INDEX(student_id, level_id)`
- âœ… å¯ä»¥ç›´æ¥SQLæŸ¥è¯¢: "æ‰¾å‡ºæ‰€æœ‰å®Œæˆçš„å…³å¡"
  ```sql
  SELECT * FROM student_level_progress WHERE status = 'completed'
  ```

### 2. å¼•å…¥GORMæ¡†æ¶

**GORMæ˜¯ä»€ä¹ˆ?**
- å°±åƒä¸€ä¸ª"ç¿»è¯‘å®˜",æŠŠGoä»£ç ç¿»è¯‘æˆSQL
- ä¸ç”¨æ‰‹å†™SQL,å†™Goä»£ç å°±è¡Œ

**å¯¹æ¯”:**

âŒ **åŸæ¥ (æ‰‹å†™SQL):**
```go
query := "SELECT * FROM users WHERE id = ?"
var user User
err := db.QueryRow(query, userID).Scan(&user.ID, &user.Name, &user.Role, ...)
// è¦æ‰‹åŠ¨Scanæ¯ä¸ªå­—æ®µ,å¾ˆå®¹æ˜“å‡ºé”™
```

âœ… **ç°åœ¨ (GORM):**
```go
var user User
db.Where("id = ?", userID).First(&user)
// è‡ªåŠ¨æ˜ å°„åˆ°ç»“æ„ä½“,ç®€å•!
```

**GORMçš„é­”æ³•:**

1. **è‡ªåŠ¨å»ºè¡¨**: å®šä¹‰Goç»“æ„ä½“,è‡ªåŠ¨å¯¹åº”æ•°æ®åº“è¡¨
   ```go
   type User struct {
       ID   string `gorm:"primaryKey"`
       Name string `gorm:"size:128"`
       Role string `gorm:"type:enum('student','teacher')"`
   }
   ```

2. **å…³è”æŸ¥è¯¢**: è‡ªåŠ¨åŠ è½½å…³è”æ•°æ®
   ```go
   // æŸ¥è¯¢å­¦ç”Ÿ,åŒæ—¶åŠ è½½ç”¨æˆ·ä¿¡æ¯
   var student Student
   db.Preload("User").First(&student, "user_id = ?", id)
   // student.User è‡ªåŠ¨å¡«å……äº†!
   ```

3. **æ™ºèƒ½æ›´æ–°**: åªæ›´æ–°æ”¹å˜çš„å­—æ®µ
   ```go
   db.Model(&student).Updates(map[string]interface{}{
       "total_stars": gorm.Expr("total_stars + ?", 5),
   })
   // è‡ªåŠ¨ç”Ÿæˆ: UPDATE students SET total_stars = total_stars + 5
   ```

### 3. åˆ›å»ºRepositoryå±‚

**Repositoryæ˜¯ä»€ä¹ˆ?**
- å°±åƒä¸€ä¸ª"æ•°æ®ç®¡ç†å‘˜",ä¸“é—¨è´Ÿè´£æŸä¸ªå®ä½“çš„å¢åˆ æ”¹æŸ¥
- ç»Ÿä¸€æ¥å£,æ–¹ä¾¿æµ‹è¯•å’Œç»´æŠ¤

**æˆ‘ä»¬åˆ›å»ºçš„Repository:**

```go
UserRepository          // ç®¡ç†ç”¨æˆ·
StudentRepository       // ç®¡ç†å­¦ç”Ÿä¿¡æ¯ã€å¤´åƒã€å¾½ç« 
ProgressRepository      // ç®¡ç†å…³å¡è¿›åº¦
CourseRepository        // ç®¡ç†è¯¾ç¨‹ã€ç« èŠ‚ã€å…³å¡
ClassRepository         // ç®¡ç†ç­çº§
TeacherRepository       // ç®¡ç†æ•™å¸ˆ
ParentRepository        // ç®¡ç†å®¶é•¿å’Œäº²å­å…³ç³»
SandboxProjectRepository // ç®¡ç†æ²™ç›’é¡¹ç›®
WorkSubmissionRepository // ç®¡ç†ä½œä¸šæäº¤
CompendiumEntryRepository // ç®¡ç†å›¾é‰´
WeeklyReportRepository  // ç®¡ç†å‘¨æŠ¥
```

**ä½¿ç”¨ç¤ºä¾‹:**

```go
// 1. æŸ¥è¯¢å­¦ç”Ÿ
student, err := studentRepo.FindByUserID(ctx, "student-1")

// 2. æ›´æ–°å­¦ç”Ÿæ˜Ÿæ•°
err = studentRepo.IncrementStats(ctx, "student-1", 5, 1)  // +5æ˜Ÿ, +1å…³å¡

// 3. è®°å½•å…³å¡å®Œæˆ
err = progressRepo.RecordCompletion(ctx, "student-1", "level-1", 3, 10, 1, 120, replayData)

// 4. æŸ¥è¯¢å­¦ç”Ÿæ‰€æœ‰è¿›åº¦
progressList, err := progressRepo.FindAllByStudent(ctx, "student-1")

// 5. è§£é”æ–°å¤´åƒ
err = studentRepo.UnlockAvatar(ctx, "student-1", "cool-hat")
```

### 4. æ›´æ–°æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

**æµ‹è¯•æ•°æ®åŒ…æ‹¬:**
- 4ä¸ªå­¦ç”Ÿ (å°å¥‡ã€å°ç¿ã€å°æ•ã€å°è±ª)
- 2ä¸ªæ•™å¸ˆ (æè€å¸ˆã€ç‹è€å¸ˆ)
- 3ä¸ªå®¶é•¿
- 3ä¸ªç­çº§
- 2é—¨è¯¾ç¨‹ (é¡ºåºæŒ‡ä»¤å…¥é—¨ã€å¾ªç¯ä¸è°ƒè¯•è¿›é˜¶)
- 4ä¸ªç« èŠ‚
- 6ä¸ªå…³å¡ (é¦–å…³æ¼”ç¤ºã€å²”è·¯å£çš„é€‰æ‹©ã€å®ˆå«çš„å·¡é€»...)
- å­¦ç”Ÿä»¬çš„è¿›åº¦ã€å¾½ç« ã€å¤´åƒç­‰

**ä¸€é”®åˆå§‹åŒ–:**
```bash
# åˆ›å»ºæ•°æ®åº“å’Œè¡¨ç»“æ„
mysql -u root -p < docs/database_schema_v3.sql

# æ’å…¥æµ‹è¯•æ•°æ®
mysql -u root -p code_adventurers < database/init/mysql_init_v3.sql
```

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### 1. æ•°æ®æ¨¡å‹è®¾è®¡åŸåˆ™

#### ä¸»è¡¨ + æ‰©å±•è¡¨
```
users (ä¸»è¡¨ - æ‰€æœ‰ç”¨æˆ·å…±ç”¨)
  â”œâ”€ students (æ‰©å±•è¡¨ - å­¦ç”Ÿä¸“ç”¨å­—æ®µ)
  â”œâ”€ teachers (æ‰©å±•è¡¨ - æ•™å¸ˆä¸“ç”¨å­—æ®µ)
  â””â”€ parents  (æ‰©å±•è¡¨ - å®¶é•¿ä¸“ç”¨å­—æ®µ)
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡?**
- âœ… é¿å…å­—æ®µå†—ä½™: ä¸åŒè§’è‰²çš„ç‰¹æœ‰å­—æ®µåˆ†å¼€å­˜
- âœ… ç»Ÿä¸€ç”¨æˆ·ç®¡ç†: ç™»å½•ã€æƒé™ç­‰é€»è¾‘åªçœ‹ä¸»è¡¨
- âœ… æ˜“äºæ‰©å±•: æ–°è§’è‰²åªéœ€åŠ æ–°æ‰©å±•è¡¨

#### å…³ç³»è¡¨ (å¤šå¯¹å¤š)
```
classes â†â†’ class_courses â†â†’ courses
(ç­çº§)      (å…³è”è¡¨)        (è¯¾ç¨‹)
```

**ä¸ºä»€ä¹ˆéœ€è¦å…³è”è¡¨?**
- ä¸€ä¸ªç­çº§å¯ä»¥æœ‰å¤šé—¨è¯¾ç¨‹
- ä¸€é—¨è¯¾ç¨‹å¯ä»¥åˆ†é…ç»™å¤šä¸ªç­çº§
- å…³è”è¡¨è®°å½•è¿™ç§"å¤šå¯¹å¤š"å…³ç³»

#### è¿›åº¦è¡¨ (æ¯ä¸ªç»„åˆä¸€æ¡è®°å½•)
```
student_level_progress
+-----------+----------+--------+
|student_id |level_id  |progress|
+-----------+----------+--------+
|student-1  |level-1   |å®Œæˆ    |
|student-1  |level-2   |è¿›è¡Œä¸­  |
|student-2  |level-1   |å®Œæˆ    |
+-----------+----------+--------+
```

**ä¸ºä»€ä¹ˆè¿™æ ·å¥½?**
- âœ… æŸ¥è¯¢å¿«: ç›´æ¥WHERE student_id = 'xxx'
- âœ… ç»Ÿè®¡æ–¹ä¾¿: COUNT, AVG, SUMä¸€é”®æå®š
- âœ… ä¸ä¼šä¸¢å¤±: æ¯ä¸ªç»„åˆç‹¬ç«‹ä¿å­˜

### 2. GORMæœ€ä½³å®è·µ

#### ä½¿ç”¨æ ‡ç­¾å®šä¹‰è¡¨ç»“æ„
```go
type Student struct {
    UserID      string `gorm:"column:user_id;primaryKey;size:64"`
    ClassID     string `gorm:"column:class_id;size:64;index"`
    TotalStars  int    `gorm:"column:total_stars;default:0"`
    CreatedAt   time.Time `gorm:"autoCreateTime"`
}
```

**æ ‡ç­¾è¯´æ˜:**
- `column`: æ•°æ®åº“åˆ—å
- `primaryKey`: ä¸»é”®
- `size`: å­—æ®µé•¿åº¦
- `index`: å»ºç«‹ç´¢å¼•
- `default`: é»˜è®¤å€¼
- `autoCreateTime`: è‡ªåŠ¨è®¾ç½®åˆ›å»ºæ—¶é—´

#### Preloadå…³è”æŸ¥è¯¢
```go
// æŸ¥è¯¢å­¦ç”Ÿ,åŒæ—¶åŠ è½½ç”¨æˆ·ä¿¡æ¯å’Œè¿›åº¦
var student Student
db.Preload("User").
   Preload("Progress").
   First(&student, "user_id = ?", id)

// student.User å’Œ student.Progress å·²è‡ªåŠ¨å¡«å……
```

**ä¸ºä»€ä¹ˆè¦Preload?**
- âŒ ä¸ç”¨Preload: N+1æŸ¥è¯¢é—®é¢˜
  ```go
  students := findAllStudents()  // 1æ¬¡æŸ¥è¯¢
  for _, s := range students {
      user := findUser(s.UserID)  // Næ¬¡æŸ¥è¯¢
  }
  // æ€»å…±: 1 + N æ¬¡æŸ¥è¯¢
  ```
- âœ… ç”¨Preload: åªéœ€2æ¬¡æŸ¥è¯¢
  ```go
  students := db.Preload("User").Find(&students)
  // 1æ¬¡æŸ¥è¯¢students + 1æ¬¡æŸ¥è¯¢æ‰€æœ‰users
  // æ€»å…±: 2æ¬¡æŸ¥è¯¢
  ```

#### æ™ºèƒ½Upsert (æ’å…¥æˆ–æ›´æ–°)
```go
// å¦‚æœå­˜åœ¨å°±æ›´æ–°,ä¸å­˜åœ¨å°±æ’å…¥
func (r *ProgressRepository) UpsertProgress(ctx context.Context, progress *StudentLevelProgress) error {
    var existing StudentLevelProgress
    err := r.db.Where("student_id = ? AND level_id = ?", 
                      progress.StudentID, progress.LevelID).
                First(&existing).Error

    if errors.Is(err, gorm.ErrRecordNotFound) {
        // ä¸å­˜åœ¨,æ’å…¥æ–°è®°å½•
        return r.db.Create(progress).Error
    }

    // å­˜åœ¨,æ™ºèƒ½åˆå¹¶
    updates := map[string]interface{}{
        "stars": gorm.Expr("GREATEST(stars, ?)", progress.Stars),  // å–æœ€å¤§
        "best_steps": gorm.Expr("LEAST(best_steps, ?)", progress.BestSteps), // å–æœ€å°
        "attempts": gorm.Expr("attempts + 1"), // ç´¯åŠ 
    }
    return r.db.Model(&existing).Updates(updates).Error
}
```

### 3. Repositoryæ¨¡å¼

#### æ ‡å‡†æ¥å£
```go
type UserRepository struct {
    db *gorm.DB
}

// æŸ¥è¯¢å•ä¸ª
func (r *UserRepository) FindByID(ctx context.Context, id string) (*User, error)

// æŸ¥è¯¢åˆ—è¡¨
func (r *UserRepository) ListByRole(ctx context.Context, role string) ([]User, error)

// åˆ›å»º
func (r *UserRepository) Create(ctx context.Context, user *User) error

// æ›´æ–°
func (r *UserRepository) Update(ctx context.Context, user *User) error

// åˆ é™¤
func (r *UserRepository) Delete(ctx context.Context, id string) error
```

#### é”™è¯¯å¤„ç†
```go
var (
    ErrUserNotFound = errors.New("user not found")
    ErrDuplicateEmail = errors.New("email already exists")
)

func (r *UserRepository) FindByID(ctx context.Context, id string) (*User, error) {
    var user User
    err := r.db.WithContext(ctx).Where("id = ?", id).First(&user).Error
    if errors.Is(err, gorm.ErrRecordNotFound) {
        return nil, ErrUserNotFound  // è¿”å›ä¸šåŠ¡é”™è¯¯
    }
    return &user, err
}
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### æŸ¥è¯¢æ€§èƒ½æå‡

#### åœºæ™¯1: æŸ¥æ‰¾ç­çº§é‡Œæ‰€æœ‰å®Œæˆå…³å¡çš„å­¦ç”Ÿ

**ä»¥å‰ (JSON):**
```go
// 1. è¯»å–æ‰€æœ‰å­¦ç”ŸJSON (å‡è®¾100ä¸ªå­¦ç”Ÿ)
for each student {
    jsonData := parseJSON(student.data)  // 100æ¬¡JSONè§£æ
    if jsonData.classId == targetClass {
        for each level in jsonData.progress {
            if level.status == "completed" {
                // æ‰¾åˆ°äº†
            }
        }
    }
}
// æ—¶é—´å¤æ‚åº¦: O(N * M), N=å­¦ç”Ÿæ•°, M=å…³å¡æ•°
```

**ç°åœ¨ (SQL + ç´¢å¼•):**
```go
var results []StudentLevelProgress
db.Where("status = ?", "completed").
   Joins("JOIN students ON students.user_id = student_level_progress.student_id").
   Where("students.class_id = ?", targetClass).
   Find(&results)
// æ—¶é—´å¤æ‚åº¦: O(log N), åˆ©ç”¨ç´¢å¼•
```

**æ€§èƒ½æå‡**: 10-100å€ (å–å†³äºæ•°æ®é‡)

#### åœºæ™¯2: ç»Ÿè®¡å­¦ç”Ÿå¹³å‡æ˜Ÿæ•°

**ä»¥å‰:**
```go
totalStars := 0
count := 0
for each student {
    jsonData := parseJSON(student.data)
    totalStars += jsonData.totalStars
    count++
}
average := totalStars / count
```

**ç°åœ¨:**
```sql
SELECT AVG(total_stars) FROM students WHERE class_id = ?
```

**æ€§èƒ½æå‡**: æ•°æ®åº“è‡ªå·±ç®—,å¿«å¾—å¤š!

### å­˜å‚¨ç©ºé—´ä¼˜åŒ–

**ä»¥å‰ (JSON):**
```json
{
  "id": "student-1",
  "name": "å°æ˜",
  "class_id": "class-1",
  "total_stars": 10,
  "settings": {
    "volume": 80,
    "low_motion": false,
    "language": "zh-CN"
  },
  ...
}
// æ¯ä¸ªå­—æ®µéƒ½å­˜å‚¨äº†keyåç§°
```

**ç°åœ¨ (SQLè¡Œ):**
```
| user_id   | class_id | total_stars | settings_volume | ... |
|-----------|----------|-------------|-----------------|-----|
| student-1 | class-1  | 10          | 80              | ... |
// åªå­˜å‚¨å€¼,keyåœ¨è¡¨ç»“æ„é‡Œ
```

**å­˜å‚¨èŠ‚çœ**: çº¦30-50% (å¯¹äºå¤§é‡æ•°æ®)

---

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

### å¾…å®Œæˆå·¥ä½œ

#### 1. Serviceå±‚é‡æ„ (æœ€é‡è¦!)

**å½“å‰çŠ¶æ€**: Serviceå±‚è¿˜åœ¨ç”¨å†…å­˜æ•°æ®
```go
// ç›®å‰
type Service struct {
    mu       sync.RWMutex
    chapters []ChapterDefinition  // å†…å­˜æ•°æ®
    levels   map[string]LevelDefinition
    profiles map[string]*StudentProfile
}
```

**éœ€è¦æ”¹æˆ**: ä½¿ç”¨Repositoryè®¿é—®æ•°æ®åº“
```go
// ç›®æ ‡
type Service struct {
    studentRepo  *mysql.StudentRepository
    progressRepo *mysql.ProgressRepository
    levelRepo    *mysql.LevelRepository
}

func (s *Service) Map(ctx context.Context, userID string) (Map, error) {
    // 1. ä»æ•°æ®åº“è·å–å­¦ç”Ÿä¿¡æ¯
    student, err := s.studentRepo.FindByUserID(ctx, userID)
    
    // 2. ä»æ•°æ®åº“è·å–è¿›åº¦
    progress, err := s.progressRepo.FindAllByStudent(ctx, userID)
    
    // 3. ä»æ•°æ®åº“è·å–è¯¾ç¨‹ç»“æ„
    courses, err := s.levelRepo.FindAllWithFullTree(ctx)
    
    // 4. ç»„è£…è¿”å›
    return buildMapResponse(student, progress, courses), nil
}
```

#### 2. å‰ç«¯APIé€‚é…éªŒè¯

**æ£€æŸ¥ç‚¹:**
- âœ… APIå“åº”æ ¼å¼æ˜¯å¦å…¼å®¹?
- âœ… å‰ç«¯æ˜¯å¦éœ€è¦è°ƒæ•´å­—æ®µå?
- âœ… æ–°å¢å­—æ®µå‰ç«¯å¦‚ä½•å±•ç¤º?

#### 3. æ•°æ®è¿ç§»è„šæœ¬

**éœ€è¦ç¼–å†™:**
```python
# scripts/migrate_v2_to_v3.py
def migrate():
    # 1. ä»v2è¡¨è¯»å–JSONæ•°æ®
    old_users = read_json_from_v2()
    
    # 2. è§£æJSON,æ‹†åˆ†å­—æ®µ
    for user in old_users:
        data = json.loads(user.data)
        
        # 3. æ’å…¥åˆ°v3è¡¨
        insert_user(user.id, data['name'], data['role'])
        if data['role'] == 'student':
            insert_student(user.id, data)
            insert_progress(user.id, data['progress'])
```

#### 4. æ€§èƒ½æµ‹è¯•

**æµ‹è¯•åœºæ™¯:**
- 1000ä¸ªå­¦ç”ŸåŒæ—¶æŸ¥è¯¢è¿›åº¦
- 100ä¸ªç­çº§ç»Ÿè®¡æ•°æ®
- å¹¶å‘å†™å…¥å…³å¡å®Œæˆè®°å½•

**ç›®æ ‡æŒ‡æ ‡:**
- æŸ¥è¯¢å“åº”æ—¶é—´ < 100ms
- å†™å…¥TPS > 1000
- æ•°æ®åº“CPU < 70%

---

## ğŸ’¡ å¼€å‘å»ºè®®

### æ–°æ‰‹ä¸Šæ‰‹æŒ‡å—

#### 1. å¦‚ä½•æ·»åŠ æ–°å­—æ®µ?

**åœºæ™¯**: ç»™å­¦ç”Ÿè¡¨åŠ ä¸€ä¸ª"ç»éªŒå€¼"å­—æ®µ

**æ­¥éª¤:**
```sql
-- 1. ä¿®æ”¹æ•°æ®åº“
ALTER TABLE students ADD COLUMN experience INT DEFAULT 0;
```

```go
// 2. ä¿®æ”¹Goæ¨¡å‹
type Student struct {
    // ... å…¶ä»–å­—æ®µ ...
    Experience int `gorm:"column:experience;default:0" json:"experience"`
}
```

```go
// 3. Repositoryè‡ªåŠ¨æ”¯æŒ,æ— éœ€ä¿®æ”¹!
student, _ := studentRepo.FindByUserID(ctx, "student-1")
fmt.Println(student.Experience)  // è‡ªåŠ¨æœ‰äº†!
```

#### 2. å¦‚ä½•æ·»åŠ æ–°è¡¨?

**åœºæ™¯**: æ·»åŠ ä¸€ä¸ª"ä»»åŠ¡ç³»ç»Ÿ"

**æ­¥éª¤:**
```sql
-- 1. åˆ›å»ºè¡¨
CREATE TABLE tasks (
  id VARCHAR(64) PRIMARY KEY,
  title VARCHAR(128) NOT NULL,
  description TEXT,
  reward_stars INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

```go
// 2. å®šä¹‰æ¨¡å‹
type Task struct {
    ID           string    `gorm:"column:id;primaryKey"`
    Title        string    `gorm:"column:title;size:128;not null"`
    Description  string    `gorm:"column:description;type:text"`
    RewardStars  int       `gorm:"column:reward_stars;default:0"`
    CreatedAt    time.Time `gorm:"autoCreateTime"`
}

func (Task) TableName() string {
    return "tasks"
}
```

```go
// 3. åˆ›å»ºRepository
type TaskRepository struct {
    db *gorm.DB
}

func (r *TaskRepository) FindByID(ctx context.Context, id string) (*Task, error) {
    var task Task
    err := r.db.WithContext(ctx).Where("id = ?", id).First(&task).Error
    return &task, err
}
```

```go
// 4. æ·»åŠ åˆ°Repositoryå·¥å‚
type Repositories struct {
    // ... å…¶ä»–Repository ...
    Task *TaskRepository
}

func NewRepositories(db *gorm.DB) *Repositories {
    return &Repositories{
        // ... å…¶ä»– ...
        Task: NewTaskRepository(db),
    }
}
```

#### 3. å¦‚ä½•è°ƒè¯•SQL?

**æ–¹æ³•1: å¯ç”¨GORMæ—¥å¿—**
```go
db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{
    Logger: logger.Default.LogMode(logger.Info), // æ‰“å°æ‰€æœ‰SQL
})
```

**æ–¹æ³•2: ä½¿ç”¨DryRun**
```go
// åªç”ŸæˆSQL,ä¸æ‰§è¡Œ
stmt := db.Session(&gorm.Session{DryRun: true}).
    Where("id = ?", "student-1").
    First(&student)
fmt.Println(stmt.Statement.SQL.String())  // æ‰“å°SQL
```

**æ–¹æ³•3: ä½¿ç”¨MySQLæ…¢æŸ¥è¯¢æ—¥å¿—**
```sql
-- å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 0.1;  -- è¶…è¿‡0.1ç§’è®°å½•

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT * FROM mysql.slow_log;
```

### å¸¸è§é—®é¢˜FAQ

#### Q: ä¸ºä»€ä¹ˆæœ‰äº›å­—æ®µè¿˜ç”¨JSON?

**A**: å¤æ‚çš„åµŒå¥—ç»“æ„ç”¨JSONæ›´åˆé€‚

ä¾‹å¦‚å…³å¡é…ç½®:
```json
{
  "tiles": [
    {"x": 0, "y": 0, "walkable": true},
    {"x": 1, "y": 0, "walkable": false, "collectible": "gem"}
  ],
  "start": {"x": 0, "y": 0, "facing": "east"},
  "goal": {"reach": {"x": 5, "y": 5}, "collectibles": 3}
}
```

å¦‚æœæ‹†æˆè¡¨:
```sql
CREATE TABLE level_tiles (...) -- ä¼šå¾ˆå¤æ‚
CREATE TABLE level_goals (...)
CREATE TABLE level_collectibles (...)
```

**åŸåˆ™**: 
- âœ… éœ€è¦æŸ¥è¯¢/ç´¢å¼•çš„å­—æ®µ â†’ ç‹¬ç«‹åˆ—
- âœ… å¤æ‚åµŒå¥—é…ç½® â†’ JSON
- âœ… é¢‘ç¹å˜æ›´çš„ç»“æ„ â†’ JSON

#### Q: sql.NullString vs string,ä»€ä¹ˆæ—¶å€™ç”¨?

**A**: æ•°æ®åº“å­—æ®µå…è®¸NULLæ—¶ç”¨sql.NullXXX

```go
type User struct {
    Name  string         `gorm:"not null"`  // å¿…å¡«,ç”¨string
    Email sql.NullString `gorm:""`          // å¯é€‰,ç”¨sql.NullString
}

// ä½¿ç”¨
if user.Email.Valid {  // æ£€æŸ¥æ˜¯å¦æœ‰å€¼
    fmt.Println(user.Email.String)
}
```

#### Q: æ€§èƒ½æ…¢æ€ä¹ˆåŠ?

**A**: ä¼˜åŒ–æ­¥éª¤
1. **æ‰¾åˆ°æ…¢æŸ¥è¯¢**: çœ‹MySQLæ…¢æŸ¥è¯¢æ—¥å¿—
2. **åˆ†ææ‰§è¡Œè®¡åˆ’**: 
   ```sql
   EXPLAIN SELECT * FROM student_level_progress WHERE student_id = 'xxx';
   ```
3. **åŠ ç´¢å¼•**:
   ```sql
   CREATE INDEX idx_progress_student ON student_level_progress(student_id);
   ```
4. **ä¼˜åŒ–æŸ¥è¯¢**: 
   - ç”¨`Select`åªé€‰éœ€è¦çš„å­—æ®µ
   - ç”¨`Joins`æ›¿ä»£å¤šæ¬¡æŸ¥è¯¢
   - ç”¨`Preload`é¿å…N+1

---

## ğŸ“š å­¦ä¹ èµ„æº

### æ¨èé˜…è¯»

1. **GORMå®˜æ–¹æ–‡æ¡£** (å¿…è¯»!)
   - ä¸­æ–‡: https://gorm.io/zh_CN/docs/
   - è‹±æ–‡: https://gorm.io/docs/

2. **MySQLä¼˜åŒ–**
   - ã€Šé«˜æ€§èƒ½MySQLã€‹ç¬¬ä¸‰ç‰ˆ
   - MySQLå®˜æ–¹æ–‡æ¡£: https://dev.mysql.com/doc/

3. **Goæœ€ä½³å®è·µ**
   - Effective Go: https://go.dev/doc/effective_go
   - Go Code Review: https://github.com/golang/go/wiki/CodeReviewComments

### ç›¸å…³æ–‡æ¡£

é¡¹ç›®å†…æ–‡æ¡£:
- `docs/æ•°æ®åº“é‡æ„æŠ€æœ¯æ–‡æ¡£.md` - è¯¦ç»†æŠ€æœ¯æ–‡æ¡£
- `docs/database_schema_v3.sql` - æ•°æ®åº“Schema
- `database/init/mysql_init_v3.sql` - æµ‹è¯•æ•°æ®
- `backend/internal/repo/mysql/` - Repositoryå®ç°ä»£ç 

---

## ğŸ‰ æ€»ç»“

### æˆ‘ä»¬å®Œæˆäº†ä»€ä¹ˆ?

âœ… **è®¾è®¡**: 20å¼ è¡¨çš„æ ‡å‡†åŒ–Schema  
âœ… **ç¼–ç **: 13ä¸ªRepository,å®Œæ•´çš„GORMæ¨¡å‹  
âœ… **æ–‡æ¡£**: è¯¦ç»†çš„æŠ€æœ¯æ–‡æ¡£å’Œè¿™ä»½æ€»ç»“  
âœ… **æ•°æ®**: æµ‹è¯•æ•°æ®è„šæœ¬  

### æŠ€æœ¯æ”¶ç›Š

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | æå‡ |
|------|--------|--------|------|
| æŸ¥è¯¢æ€§èƒ½ | å…¨è¡¨æ‰«æ | ç´¢å¼•æŸ¥è¯¢ | 10-100å€ |
| å¼€å‘æ•ˆç‡ | æ‰‹å†™SQL | GORMè‡ªåŠ¨åŒ– | 60%+ |
| ä»£ç è¡Œæ•° | Repositoryå±‚ | CRUDè‡ªåŠ¨åŒ– | -60% |
| å¯ç»´æŠ¤æ€§ | åˆ†æ•£åœ¨å„å¤„ | ç»Ÿä¸€Repository | +++++ |

### ä¸‹ä¸€æ­¥

â³ **Serviceå±‚é‡æ„** - è¿æ¥Repositoryå’ŒHandler  
â³ **å‰ç«¯é€‚é…** - éªŒè¯APIå…¼å®¹æ€§  
â³ **æ€§èƒ½æµ‹è¯•** - å‹æµ‹å’Œä¼˜åŒ–  
â³ **æ–‡æ¡£å®Œå–„** - APIæ–‡æ¡£ã€éƒ¨ç½²æ–‡æ¡£  

### æœ€åçš„è¯

è¿™æ¬¡é‡æ„æ˜¯ä¸€ä¸ª**åŸºç¡€è®¾æ–½å‡çº§**,å°±åƒç»™æˆ¿å­æ¢äº†ä¸ªæ›´ç»“å®çš„åœ°åŸºã€‚è™½ç„¶ç°åœ¨çœ‹èµ·æ¥è¿˜æ²¡æ³•ç›´æ¥ç”¨,ä½†ä¸ºå°†æ¥çš„æ‰€æœ‰åŠŸèƒ½å¼€å‘æ‰“ä¸‹äº†åšå®çš„åŸºç¡€ã€‚

**è®°ä½ä¸€å¥è¯**: "æ…¢å°±æ˜¯å¿«,åŸºç¡€æ‰“å¥½äº†,åé¢å¼€å‘æ‰èƒ½é£èµ·æ¥!" ğŸš€

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-09-30  
**ç»´æŠ¤è€…**: CodeAdventurers Team  
**é—®é¢˜åé¦ˆ**: è¯·æäº¤Issueæˆ–è”ç³»æŠ€æœ¯è´Ÿè´£äºº
