# 开发与调试指南

本文档补充说明如何在本地运行 Code Adventurers 的各类服务、调试 API / 测试，以及常见问题排查技巧。阅读本指南前，请先完成《环境配置.md》中列出的依赖安装与数据库初始化。

## 1. 常用 npm 脚本

| 命令 | 作用 | 备注 |
| --- | --- | --- |
| `npm run dev` | 启动 API 服务（默认端口 `3000`）并自动载入内置种子数据，便于本地联调。 | 支持 `PORT=4000 npm run dev` 指定端口；Windows、macOS、Linux 通用。 |
| `npm run dev:api` | `dev` 的别名，方便在 CI / 脚本中引用。 |  |
| `npm test` | 执行完整的 Jest 测试套件。 | 内置 `cross-env`，在 Windows 上无需额外设置 `NODE_OPTIONS`。 |
| `npm run test:jest -- --watch` | 以 watch 模式运行测试，便于 TDD。 | 支持追加 `--runTestsByPath tests/services/api.test.ts` 只跑指定文件。 |
| `npm run build` | 使用 `tsc` 进行类型检查与编译。 | 生成的构建产物位于 `dist/`，目前主要用于验证类型安全。 |

> 💡 **Windows 用户提示**：之前的 `NODE_OPTIONS=... jest` 写法在 PowerShell / CMD 中会报 “不是内部或外部命令”。现在已经改为跨平台的 `cross-env`，直接执行 `npm test` 即可。

## 2. 调试 API 服务

1. 确认 `.env` 或环境变量里提供了 MySQL 连接信息（若省略则自动使用内存存储）。
2. 运行 `npm run dev`，终端会输出监听地址，例如：
   ```text
   [dev] API server listening on http://localhost:3000
   ```
3. 使用 Postman / curl / 前端应用调用 REST 接口，或通过 `tests/services/api.test.ts` 学习示例请求。
4. 若需要断点调试，可追加 Node Inspector 参数：
   ```bash
   npm run dev -- --inspect-brk
   ```
   然后在 VS Code 中通过 “附加到 Node 进程” 启动调试，或在 Chrome 输入 `chrome://inspect` 连接。

## 3. 调试 Jest 测试

- **单测定位**：`npm test -- --runTestsByPath tests/packages/engine.test.ts`。
- **聚焦单个用例**：在测试文件里使用 `test.only(...)` 或 `describe.only(...)`。
- **调试断点**：
  ```bash
  node --inspect-brk ./node_modules/.bin/jest --runInBand --runTestsByPath tests/services/api.test.ts
  ```
  也可以在 VS Code `launch.json` 中配置 `type: "node"`, `program: "${workspaceFolder}/node_modules/jest/bin/jest.js"`。

## 4. MySQL 相关辅助脚本

- `docs/database_schema.sql`：完整的建表语句，覆盖用户、课程、关卡、UGC、遥测等实体。
- `docs/mysql_init.sql`：基础演示数据，可在开发模式下快速体验学生 / 教师 / 家长 / 管理端流程。
- 如需重置开发环境：
  ```bash
  mysql -u root -p code_adventurers < docs/mysql_init.sql
  ```
  或调用 API 的 `/api/system/reset` 端点快速刷新内存数据。

## 5. 常见问题排查

| 现象 | 可能原因 | 解决方式 |
| --- | --- | --- |
| `Error: connect ECONNREFUSED 127.0.0.1:3306` | MySQL 未启动或端口被占用 | 检查 `mysqld` 状态，或在 `.env` 调整 `MYSQL_HOST` / `MYSQL_PORT`。 |
| `Error [ERR_MODULE_NOT_FOUND]: Cannot find module '@engine/index'` | 未执行 `npm install` 或 TypeScript 路径未被解析 | 重新运行 `npm install`，确认 `tsconfig.json` 中 `baseUrl` / `paths` 生效。 |
| 接口返回 401 | 请求头缺少 `x-user-id` | 在调试工具中添加种子数据里存在的用户 ID，例如 `student-1`。 |
| Jest 测试卡在 VM Modules 提示 | Node 版本过低 (< 18) | 升级至 Node 18+，推荐使用 Node 20 LTS。 |

更多背景与功能对照请参考《功能梳理与实现状态总览》。如仍有疑问，可在 Issue 中附上命令行输出与 `.env` 脱敏配置，便于复现与定位。
