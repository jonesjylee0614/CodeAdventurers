# 开发与调试指南

本文档介绍如何在本地运行 Code Adventurers 的后端 API、前端项目以及相关测试，帮助你在日常开发中快速定位问题与调试。阅读本指南前，请先完成《环境配置指南》中的依赖安装与配置。

## 1. 常用开发命令

| 命令 | 作用 | 备注 |
| --- | --- | --- |
| `go run ./backend/cmd/api` | 以开发模式启动 Go API 服务。 | 支持从 `backend/.env` 读取配置，默认监听 `:8080`。 |
| `go test ./backend/...` | 运行后端单元测试。 | 当前示例项目以占位实现为主，可用于验证依赖与构建链路。 |
| `dlv debug ./backend/cmd/api` | 使用 Delve 进行断点调试。 | 推荐在 VS Code 中结合 Go 扩展使用。 |
| `cd frontend && npm run dev` | 启动前端开发服务器。 | 默认端口 `5173`，与 CORS 配置保持一致。 |
| `cd frontend && npm run build` | 构建前端产物并进行类型检查。 | 结果输出到 `frontend/dist/`。 |
| `cd frontend && npm test` | 运行现有的 Jest/TS 测试。 | 适用于前端组件与工具函数。 |

## 2. 后端调试流程（Go）

1. **准备配置**：确保 `backend/.env` 中包含 MySQL、Redis 以及 JWT 等必要参数。若缺失可复制 `backend/.env.example` 进行修改。
2. **启动服务**：执行 `go run ./backend/cmd/api`。启动日志会以 JSON 形式输出，核心字段包括 `level`、`msg`、`level_id` 等。
3. **观察日志**：
   - 成功启动后会出现 `api server starting`、`student map fetched` 等信息，帮助确认关键路径是否执行。
   - 当请求参数不符合校验规则时，将输出 `request validation failed` 级别的警告，便于在本地复现前端问题。
   - 异步任务入队、WebSocket 建连等操作也会生成结构化日志，可配合 `jq` 或日志聚合工具分析。
4. **断点调试**：
   - 使用 VS Code 打开 `backend/cmd/api/main.go`，选择 “Run and Debug > Go: Debug file”。
   - 在 Handler 或 Service 中设置断点，借助 Delve 检查入参、上下文与返回值。
5. **依赖模拟**：如暂时无法连接真实的 MySQL/Redis，可临时注释相关配置，或使用 Docker Compose 启动本地实例。

> 💡 **提示**：`logger.WithContext` 会将 zap logger 注入到 `context.Context` 中，若需要在 Service 层追加日志，可通过 `logger.FromContext(ctx)` 复用同一套字段。

## 3. 日志分析技巧

- `level=info`：表示成功执行的关键路径，如登录、关卡运行、任务入队等。
- `level=warn`：通常是请求参数或上下文缺失，需检查前端调用或测试数据。
- `level=error`：后端依赖失败或业务逻辑异常，建议结合 `error` 字段排查。
- 可以使用 `jq 'select(.logger=="student-handler")'` 来过滤某个模块的日志。

## 4. 前端调试与测试

- **精确执行单个测试**：`cd frontend && npm test -- --runTestsByPath tests/apps/student/components.test.tsx`。
- **聚焦单个用例**：在测试文件中使用 `test.only(...)` 或 `describe.only(...)`。
- **实时调试**：`cd frontend && npm run test:jest -- --watch` 可在保存文件时自动重新运行相关用例。

## 5. 数据库辅助脚本

- `docs/database_schema.sql`：完整的建表语句，覆盖用户、课程、关卡等实体。
- `docs/mysql_init.sql`：开发环境示例数据，可快速体验学生 / 教师视角流程。
- 需要重置数据时，可重新导入上述 SQL，或编写额外的迁移脚本。

## 6. 常见问题排查

| 现象 | 可能原因 | 解决方式 |
| --- | --- | --- |
| `failed to connect to MySQL` | 数据库未启动或 DSN 配置错误 | 检查 `backend/.env` 中的连接串，确认 MySQL 服务状态。 |
| `request validation failed` | 请求体缺少必填字段 | 对照 `internal/http/dto` 中的结构体修正前端或测试数据。 |
| WebSocket 立即断开 | 请求缺少 `userId` 或被代理截断 | 在调用端附加 `userId`，并确认 Nginx/网关支持 WebSocket。 |
| 日志缺失或格式异常 | `ENV` 未设置为 `dev` / `production` | 检查环境变量，或在本地使用 `dev` 获得 JSON 开发日志。 |

若仍无法定位问题，请在 Issue 中附带命令行输出、日志片段与脱敏后的配置，以便他人协助排查。
