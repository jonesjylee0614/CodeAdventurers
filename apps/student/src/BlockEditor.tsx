import * as React from 'react';
import * as Engine from '../../../packages/engine/src/index.ts';

type Instruction = Engine.Instruction;
type LevelDefinition = Engine.LevelDefinition;
type SimulationResult = Engine.SimulationResult;

// ÁßØÊú®Á±ªÂûãÂÆö‰πâ
interface BlockType {
  id: string;
  type: Instruction['type'];
  label: string;
  color: string;
  icon: string;
  category: 'action' | 'control' | 'condition';
}

// ÂèØÁî®ÁßØÊú®Â∫ì
const BLOCK_TYPES: BlockType[] = [
  { id: 'move', type: 'move', label: 'ÂêëÂâçÁßªÂä®', color: '#4CAF50', icon: '‚Üë', category: 'action' },
  { id: 'turn-left', type: 'turn', label: 'ÂêëÂ∑¶ËΩ¨', color: '#2196F3', icon: '‚Ü∂', category: 'action' },
  { id: 'turn-right', type: 'turn', label: 'ÂêëÂè≥ËΩ¨', color: '#2196F3', icon: '‚Ü∑', category: 'action' },
  { id: 'collect', type: 'collect', label: 'Êî∂ÈõÜ', color: '#FF9800', icon: '‚≠ê', category: 'action' },
  { id: 'repeat', type: 'repeat', label: 'ÈáçÂ§ç', color: '#9C27B0', icon: 'üîÑ', category: 'control' },
  { id: 'if', type: 'conditional', label: 'Â¶ÇÊûú', color: '#F44336', icon: '‚ùì', category: 'condition' },
];

// Á®ãÂ∫èÂùóÂÆû‰æã
interface ProgramBlock {
  id: string;
  blockType: BlockType;
  instruction: Instruction;
  x: number;
  y: number;
  children?: ProgramBlock[];
}

interface BlockEditorProps {
  level: LevelDefinition;
  onRun: (program: Instruction[]) => Promise<SimulationResult>;
  onReset: () => void;
}

export const BlockEditor: React.FC<BlockEditorProps> = ({ level, onRun, onReset }: BlockEditorProps) => {
  const [programBlocks, setProgramBlocks] = React.useState<ProgramBlock[]>([]);
  const [draggedBlock, setDraggedBlock] = React.useState<BlockType | null>(null);
  const [isRunning, setIsRunning] = React.useState(false);
  const [result, setResult] = React.useState<SimulationResult | null>(null);
  const programAreaRef = React.useRef<HTMLDivElement>(null);

  // ‰ªéÁßØÊú®ÂùóÁîüÊàêÊåá‰ª§Á®ãÂ∫è
  const blocksToProgram = React.useCallback((blocks: ProgramBlock[]): Instruction[] => {
    return blocks.map(block => {
      switch (block.blockType.type) {
        case 'move':
          return { type: 'move' };
        case 'turn':
          return { 
            type: 'turn', 
            direction: block.blockType.id === 'turn-left' ? 'left' : 'right' 
          } as Instruction;
        case 'collect':
          return { type: 'collect' };
        case 'repeat':
          return { 
            type: 'repeat', 
            times: 3, // ÈªòËÆ§ÈáçÂ§ç3Ê¨°ÔºåÂèØ‰ª•ËÆæÁΩÆ‰∏∫ÂèØÁºñËæë
            body: block.children ? blocksToProgram(block.children) : []
          };
        case 'conditional':
          return {
            type: 'conditional',
            condition: { type: 'tile-ahead-walkable' }, // ÈªòËÆ§Êù°‰ª∂
            truthy: block.children ? blocksToProgram(block.children) : [],
            falsy: []
          };
        default:
          return { type: 'move' };
      }
    });
  }, []);

  // Â§ÑÁêÜÁßØÊú®ÊãñÊãΩÂºÄÂßã
  const handleDragStart = (blockType: BlockType) => {
    setDraggedBlock(blockType);
  };

  // Â§ÑÁêÜÊîæÁΩÆÂà∞Á®ãÂ∫èÂå∫
  const handleDrop = React.useCallback((e: React.DragEvent) => {
    e.preventDefault();
    if (!draggedBlock || !programAreaRef.current) return;

    const rect = programAreaRef.current.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    const newBlock: ProgramBlock = {
      id: Date.now().toString(),
      blockType: draggedBlock,
      instruction: { type: draggedBlock.type } as Instruction,
      x,
      y,
      children: draggedBlock.category === 'control' ? [] : undefined
    };

    setProgramBlocks((prev: ProgramBlock[]) => [...prev, newBlock]);
    setDraggedBlock(null);
  }, [draggedBlock]);

  // ËøêË°åÁ®ãÂ∫è
  const handleRun = async () => {
    setIsRunning(true);
    try {
      const program = blocksToProgram(programBlocks);
      const simulationResult = await onRun(program);
      setResult(simulationResult);
    } catch (error) {
      console.error('ËøêË°åÁ®ãÂ∫èÊó∂Âá∫Èîô:', error);
    } finally {
      setIsRunning(false);
    }
  };

  // ÈáçÁΩÆÁ®ãÂ∫è
  const handleReset = () => {
    setProgramBlocks([]);
    setResult(null);
    onReset();
  };

  // Âà†Èô§ÁßØÊú®
  const removeBlock = (blockId: string) => {
    setProgramBlocks((prev: ProgramBlock[]) => prev.filter((block: ProgramBlock) => block.id !== blockId));
  };

  return (
    <div className="block-editor">
      <style>{`
        .block-editor {
          display: grid;
          grid-template-columns: 200px 1fr 300px;
          height: 600px;
          gap: 16px;
          font-family: 'Microsoft YaHei', sans-serif;
        }

        .block-palette {
          background: #f5f5f5;
          border-radius: 8px;
          padding: 16px;
          overflow-y: auto;
        }

        .block-category {
          margin-bottom: 16px;
        }

        .block-category h4 {
          margin: 0 0 8px 0;
          color: #333;
          font-size: 14px;
        }

        .palette-block {
          display: flex;
          align-items: center;
          padding: 8px 12px;
          margin: 4px 0;
          border-radius: 6px;
          cursor: grab;
          user-select: none;
          transition: transform 0.2s;
          color: white;
          font-weight: 500;
        }

        .palette-block:hover {
          transform: scale(1.05);
        }

        .palette-block:active {
          cursor: grabbing;
        }

        .block-icon {
          margin-right: 8px;
          font-size: 16px;
        }

        .program-area {
          background: #fff;
          border: 2px dashed #ddd;
          border-radius: 8px;
          position: relative;
          overflow: hidden;
        }

        .program-area.drag-over {
          border-color: #4CAF50;
          background-color: #f0f8f0;
        }

        .program-block {
          position: absolute;
          padding: 8px 12px;
          border-radius: 6px;
          color: white;
          font-weight: 500;
          cursor: move;
          user-select: none;
          display: flex;
          align-items: center;
          box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .program-block .delete-btn {
          margin-left: 8px;
          background: rgba(255,255,255,0.3);
          border: none;
          border-radius: 3px;
          color: white;
          cursor: pointer;
          padding: 2px 6px;
          font-size: 12px;
        }

        .control-panel {
          background: #f9f9f9;
          border-radius: 8px;
          padding: 16px;
          display: flex;
          flex-direction: column;
          gap: 12px;
        }

        .goal-section {
          background: #e3f2fd;
          border-radius: 6px;
          padding: 12px;
        }

        .goal-section h4 {
          margin: 0 0 8px 0;
          color: #1976d2;
        }

        .controls {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }

        .btn {
          padding: 10px 16px;
          border: none;
          border-radius: 6px;
          font-weight: 500;
          cursor: pointer;
          transition: background-color 0.2s;
        }

        .btn-primary {
          background: #4CAF50;
          color: white;
        }

        .btn-primary:hover:not(:disabled) {
          background: #45a049;
        }

        .btn-secondary {
          background: #f44336;
          color: white;
        }

        .btn-secondary:hover {
          background: #da190b;
        }

        .btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }

        .result-panel {
          margin-top: 16px;
          padding: 12px;
          border-radius: 6px;
        }

        .result-success {
          background: #c8e6c9;
          color: #2e7d32;
        }

        .result-error {
          background: #ffcdd2;
          color: #c62828;
        }

        .empty-program {
          display: flex;
          align-items: center;
          justify-content: center;
          height: 100%;
          color: #999;
          font-size: 18px;
        }
      `}</style>

      {/* ÁßØÊú®Ë∞ÉËâ≤Êùø */}
      <div className="block-palette">
        <div className="block-category">
          <h4>üéØ Âä®‰ΩúÁßØÊú®</h4>
          {BLOCK_TYPES.filter(b => b.category === 'action').map(blockType => (
            <div
              key={blockType.id}
              className="palette-block"
              style={{ backgroundColor: blockType.color }}
              draggable
              onDragStart={() => handleDragStart(blockType)}
            >
              <span className="block-icon">{blockType.icon}</span>
              {blockType.label}
            </div>
          ))}
        </div>

        <div className="block-category">
          <h4>üîÑ ÊéßÂà∂ÁßØÊú®</h4>
          {BLOCK_TYPES.filter(b => b.category === 'control').map(blockType => (
            <div
              key={blockType.id}
              className="palette-block"
              style={{ backgroundColor: blockType.color }}
              draggable
              onDragStart={() => handleDragStart(blockType)}
            >
              <span className="block-icon">{blockType.icon}</span>
              {blockType.label}
            </div>
          ))}
        </div>

        <div className="block-category">
          <h4>‚ùì Êù°‰ª∂ÁßØÊú®</h4>
          {BLOCK_TYPES.filter(b => b.category === 'condition').map(blockType => (
            <div
              key={blockType.id}
              className="palette-block"
              style={{ backgroundColor: blockType.color }}
              draggable
              onDragStart={() => handleDragStart(blockType)}
            >
              <span className="block-icon">{blockType.icon}</span>
              {blockType.label}
            </div>
          ))}
        </div>
      </div>

      {/* Á®ãÂ∫èÁºñËæëÂå∫ */}
      <div
        ref={programAreaRef}
        className={`program-area ${draggedBlock ? 'drag-over' : ''}`}
        onDragOver={(e: React.DragEvent) => e.preventDefault()}
        onDrop={(e: React.DragEvent) => handleDrop(e)}
      >
        {programBlocks.length === 0 ? (
          <div className="empty-program">
            ÊãñÊãΩÁßØÊú®Âà∞ËøôÈáåÂºÄÂßãÁºñÁ®ã üß©
          </div>
        ) : (
          programBlocks.map((block: ProgramBlock) => (
            <div
              key={block.id}
              className="program-block"
              style={{
                backgroundColor: block.blockType.color,
                left: block.x,
                top: block.y
              }}
            >
              <span className="block-icon">{block.blockType.icon}</span>
              {block.blockType.label}
              <button
                className="delete-btn"
                onClick={() => removeBlock(block.id)}
                title="Âà†Èô§ÁßØÊú®"
              >
                √ó
              </button>
            </div>
          ))
        )}
      </div>

      {/* ÊéßÂà∂Èù¢Êùø */}
      <div className="control-panel">
        <div className="goal-section">
          <h4>üéØ ÁõÆÊ†á</h4>
          <p>{level.name}</p>
          <p>ÊúÄ‰Ω≥Ê≠•Êï∞: {level.bestSteps}</p>
        </div>

        <div className="controls">
          <button
            className="btn btn-primary"
            onClick={handleRun}
            disabled={isRunning || programBlocks.length === 0}
          >
            {isRunning ? 'ËøêË°å‰∏≠...' : '‚ñ∂Ô∏è ËøêË°åÁ®ãÂ∫è'}
          </button>
          
          <button
            className="btn btn-secondary"
            onClick={handleReset}
          >
            üîÑ ÈáçÁΩÆ
          </button>
        </div>

        {result && (
          <div className={`result-panel ${result.success ? 'result-success' : 'result-error'}`}>
            {result.success ? (
              <>
                <h4>üéâ ÊàêÂäüÈÄöÂÖ≥ÔºÅ</h4>
                <p>Ê≠•Êï∞: {result.steps}</p>
                <p>ÊòüÁ∫ß: {'‚≠ê'.repeat(result.stars)}</p>
                {result.metadata.bestSteps && (
                  <p>‰∏éÊúÄ‰Ω≥ÊñπÊ°àÂ∑ÆË∑ù: {result.steps - result.metadata.bestSteps} Ê≠•</p>
                )}
              </>
            ) : (
              <>
                <h4>üí° ÂÜçËØïËØïÂêß</h4>
                <p>ÈîôËØØ: {result.errorCode}</p>
                <p>Â∑≤ÊâßË°åÊ≠•Êï∞: {result.steps}</p>
              </>
            )}
          </div>
        )}
      </div>
    </div>
  );
};
